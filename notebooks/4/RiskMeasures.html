
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>4.4. Risk Measures and Portfolio Optimization &#8212; Optimization for Decision Science</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/4/RiskMeasures';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="5. Data Science and Applied Statistics" href="../5/data.html" />
    <link rel="prev" title="4.3. Advanced Topics in Stochastic Programming" href="AdvancedTopics.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/cbe_logo.jpg" class="logo__image only-light" alt="Optimization for Decision Science - Home"/>
    <script>document.write(`<img src="../../_static/cbe_logo.jpg" class="logo__image only-dark" alt="Optimization for Decision Science - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    Optimization for Decision Science
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Organization</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../org/intro.html">Welcome</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../org/syllabus.html">Syllabus</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../org/calendar.html">Fall 2024 Calendar</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../org/contribute.html">Contribution Instructions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../org/workshop.html">Computational Optimization in Python (SÃ£o Paulo, Brazil)</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../org/assignments.html">Assignments</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../assignments/Pyomo1.html">Pyomo Homework 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../assignments/Pyomo2.html">Pyomo Homework 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../assignments/Pyomo3.html">Pyomo Homework 3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../org/project1.html">Project 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../assignments/Algorithms1.html">Algorithms Homework 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../assignments/Algorithms2.html">Algorithms Homework 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../org/project2.html">Project 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../assignments/Algorithms3.html">Algorithms Homework 3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../assignments/Algorithms4.html">Algorithms Homework 4</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../org/archive.html">Archive</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../assignments/Pyomo-Mini-Project.html">Pyomo Mini-Project: Receding Horizon Stochastic Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../org/semester_project.html">Semester Project (Spring 2023)</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Optimization Modeling in Pyomo</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../1/getting-started.html">1. Getting Started with Pyomo</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../1/Local-Install.html">1.1. Local Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../1/Optimization-Modeling.html">1.2. Optimization Modeling with Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../1/Pyomo-Introduction.html">1.3. Your First Optimization Problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../1/LP.html">1.4. Continuous Optimization: Linear Programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="../1/NLP.html">1.5. Continuous Optimization: Nonlinear Programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="../1/IP.html">1.6. Integer Programs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../1/Pyomo-Nuts-and-Bolts.html">1.7. 60 Minutes to Pyomo: An Energy Storage Model Predictive Control Example</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../2/logic.html">2. Logical Modeling</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../2/Logical_Modeling_GDP.html">2.1. Logical Modeling and Generalized Disjunctive Programs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../2/Modeling_Disjunctions_Strip_Packing.html">2.2. Modeling Disjunctions through the Strip Packing Problem</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../3/dynamics.html">3. Dynamic Optimization</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../3/PyomoDAE_car.html">3.1. Pyomo.DAE Example: Race Car</a></li>
<li class="toctree-l2"><a class="reference internal" href="../3/PyomoDAE_TCLab.html">3.2. Pyomo.DAE Example: Temperature Control Lab</a></li>
<li class="toctree-l2"><a class="reference internal" href="../3/DAE_background.html">3.3. Differential Algebraic Equations (DAEs)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../3/DAE_numeric_integration.html">3.4. Numeric Integration for DAEs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../3/PyomoDAE_theory.html">3.5. Dynamic Optimization with Collocation and Pyomo.DAE</a></li>
<li class="toctree-l2"><a class="reference internal" href="../3/PyomoDAE_example.html">3.6. Pyomo.DAE: Racing Example Revisited</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="uncertainty.html">4. Optimization Under Uncertainty</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="SP.html">4.1. Stochastic Programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="blocks.html">4.2. Blocks and Other Pyomo Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="AdvancedTopics.html">4.3. Advanced Topics in Stochastic Programming</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">4.4. Risk Measures and Portfolio Optimization</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../5/data.html">5. Data Science and Applied Statistics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../5/Parmest-tutorial.html">5.1. Parameter estimation with <code class="docutils literal notranslate"><span class="pre">parmest</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../5/Parmest-generate-data.html">5.2. Supplementary material: data for parmest tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../5/Pyomo_DoE_Tutorial.html">5.3. Optimizing Experiments with <code class="docutils literal notranslate"><span class="pre">Pyomo.DoE</span></code></a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Algorithms and Theory</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../6/unconstrained.html">6. Unconstrained Nonlinear Optimization</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../6/Math-Primer-1.html">6.1. Linear Algebra Review and SciPy Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../6/Math-Primer-2.html">6.2. Mathematics Primer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../6/Optimality.html">6.3. Unconstrained Optimality Conditions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../6/Newton-Methods.html">6.4. Newton-type Methods for Unconstrained Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../6/Quasi-Newton-Methods.html">6.5. Quasi-Newton Methods for Unconstrained Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../6/Globalization.html">6.6. Descent and Globalization</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../7/constrained.html">7. Constrained Nonlinear Optimization</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../7/Convexity.html">7.1. Convexity Revisited</a></li>
<li class="toctree-l2"><a class="reference internal" href="../7/Local-Optimality.html">7.2. Local Optimality Conditions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../7/KKT-Multipliers.html">7.3. Analysis of KKT Conditions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../7/Constraint-Qualifications.html">7.4. Constraint Qualifications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../7/Second-Order.html">7.5. Second Order Optimality Conditions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../7/degeneracy_hunter.html">7.6. NLP Diagnostics with Degeneracy Hunter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../7/Interior-Point1.html">7.7. Simple Netwon Method for Equality Constrained NLPs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../7/Interior-Point2.html">7.8. Inertia-Corrected Netwon Method for Equality Constrained NLPs</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../8/special-topics.html">8. Special Topics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../8/MILP.html">8.1. Integer Programming with Simple Branch and Bound</a></li>
<li class="toctree-l2"><a class="reference internal" href="../8/MINLP-Algorithms.html">8.2. MINLP Algorithms</a></li>
<li class="toctree-l2"><a class="reference internal" href="../8/Global-Opt.html">8.3. Deterministic Global Optimization</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Student Contributions</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../contrib/pyomo.html">More Pyomo Examples</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../contrib/semiconductor_manufacturing.html">Semiconductor Production Planning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib/student_diet.html">Optimization of Daily Diet Using Pyomo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib/blending.html">Blending Under Uncertainty</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib/vehicle_routing.html">Vehicle Routing</a></li>

<li class="toctree-l2"><a class="reference internal" href="../contrib/portfolio_optimization_extended.html">Risk Measures and Portfolio Optimization: Expanded</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib/race_car_extended.html">Extended Race Car Optimization Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib/hot_air_balloon.html">Hot Air Balloon Dynamic Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib/reactor_design.html">Chemical Reactor Design</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib/Disaster_Response_Plan.html">Disaster Response Plan Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib/Sudoku_Solver.html">Sudoku Solver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib/more_circle_packing.html">Circle Packing Optimization</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../contrib/modeling.html">Modeling Paradigms</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../contrib/multi_objective.html">Multi-Objective Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib/advanced_stochastic_programming.html">Advanced Topics in Stochastic Programming</a></li>






</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../contrib/algorithms.html">Global Optimization</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../contrib/Deterministic_Global_Optimization.html">Deterministic Global Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib/Bayesian_Optimization1.html">Bayesian Optimization Tutorial 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib/Bayesian_Optimization2.html">Bayesian Optimization Tutorial 2</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../contrib/sgd.html">Stochastic Gradient Descent</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../contrib/Stochastic-Gradient-Descent-1.html">Stochastic Gradient Descent Tutorial 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib/Stochastic-Gradient-Descent-2.html">Stochastic Gradient Descent Tutorial 2</a></li>






<li class="toctree-l2"><a class="reference internal" href="../contrib/Stochastic-Gradient-Descent-3.html">Stochastic Gradient Descent Tutorial 3</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../contrib/data.html">Machine Learning and Applied Statistics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../contrib/EM-MAP.html">Expectation Maximization Algorithm and MAP Estimation</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/ndcbe/optimization/blob/master/notebooks/4/RiskMeasures.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/ndcbe/optimization" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/ndcbe/optimization/issues/new?title=Issue%20on%20page%20%2Fnotebooks/4/RiskMeasures.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/notebooks/4/RiskMeasures.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Risk Measures and Portfolio Optimization</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">4.4.1. Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#common-risk-measures-for-portfolio-optimization">4.4.2. Common Risk Measures for Portfolio Optimization</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mean-variance-mv-1-2">4.4.2.1. Mean-Variance (MV) [1,2]</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#literature-examples-using-mv">4.4.2.1.1. Literature Examples Using MV</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mean-absolute-deviation-mad-1-3">4.4.2.2. Mean-Absolute Deviation (MAD) [1,3]</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#graphical-representation-3">4.4.2.2.1. Graphical Representation [3]</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#literature-examples-using-mad">4.4.2.2.2. Literature Examples Using MAD</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#minimax-mm-1">4.4.2.3. Minimax (MM) [1]</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#literature-examples-using-mm">4.4.2.3.1. Literature Examples Using MM</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#value-at-risk-var-1-4">4.4.2.4. Value-at-Risk (VaR) [1,4]</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#literature-examples-using-var">4.4.2.4.1. Literature Examples Using VaR</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#conditional-value-at-risk-cvar-1-4">4.4.2.5. Conditional Value-at-Risk (CVaR) [1,4]</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#graphical-representation-4">4.4.2.5.1. Graphical Representation [4]</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#literature-examples-using-cvar">4.4.2.5.2. Literature Examples Using CVaR</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#motivating-example-product-portfolio-optimization-in-the-brazilian-sugarcane-industry">4.4.3. Motivating Example: Product Portfolio Optimization in the Brazilian Sugarcane Industry</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-definition">4.4.3.1. Problem Definition</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#process-flow-diagram">4.4.3.2. Process Flow Diagram</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#process-model">4.4.3.3. Process Model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#degree-of-freedom-dof-analysis">4.4.3.4. Degree of Freedom (DOF) Analysis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-input-data">4.4.3.5. Visualize Input Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-base-model-in-pyomo">4.4.3.6. Define Base Model in Pyomo</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#maximize-profit-only-no-risk-measure">4.4.3.7. Maximize Profit Only (No Risk Measure)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-results">4.4.3.8. Visualize Results</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#profit-distribution">4.4.3.8.1. Profit Distribution</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#product-distribution">4.4.3.8.2. Product Distribution</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#solve-model-with-risk-measures">4.4.4. Solve Model with Risk Measures</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#formulate-the-mv-objective">4.4.4.1. Formulate the MV Objective</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-the-covariance-matrix">4.4.4.1.1. Calculate the Covariance Matrix</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">4.4.4.2. Visualize Results</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">4.4.4.2.1. Profit Distribution</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">4.4.4.2.2. Product Distribution</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#formulate-the-mad-objective">4.4.4.3. Formulate the MAD Objective</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">4.4.4.4. Visualize Results</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">4.4.4.4.1. Profit Distribution</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">4.4.4.4.2. Product Distribution</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#formulate-the-cvar-objective">4.4.4.5. Formulate the CVaR Objective</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">4.4.4.6. Visualize Results</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">4.4.4.6.1. Profit Distribution</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">4.4.4.6.2. Product Distribution</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">4.4.5. Conclusion</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#final-results-comparison">4.4.5.1. Final Results Comparison</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#discussion-questions">4.4.5.2. Discussion Questions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">4.4.6. References</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="risk-measures-and-portfolio-optimization">
<h1><span class="section-number">4.4. </span>Risk Measures and Portfolio Optimization<a class="headerlink" href="#risk-measures-and-portfolio-optimization" title="Link to this heading">#</a></h1>
<p><strong>Prepared by:</strong> Madelynn Watson (<a class="reference external" href="mailto:mwatson4&#37;&#52;&#48;nd&#46;edu">mwatson4<span>&#64;</span>nd<span>&#46;</span>edu</a>, 2023)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Imports</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="k">if</span> <span class="s2">&quot;google.colab&quot;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
    <span class="o">!</span>wget<span class="w"> </span><span class="s2">&quot;https://raw.githubusercontent.com/ndcbe/optimization/main/notebooks/helper.py&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">helper</span>
    <span class="n">helper</span><span class="o">.</span><span class="n">easy_install</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;../&#39;</span><span class="p">)</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">helper</span>
<span class="n">helper</span><span class="o">.</span><span class="n">set_plotting_style</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="introduction">
<h2><span class="section-number">4.4.1. </span>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<p>In engineering, a common objective for optimization problems is maximizing overall profit; however, typically, static market prices are considered for different commodities which do not reflect actual market behavior. Failing to account for this uncertainty can lead to risk-inclined investments. Markowitz initially developed portfolio optimization in 1959 to de-risk financial asset portfolio returns in volatile market situations. In this framework proposed by Markowitz, a multi-objective optimization problem is considered where the expected value of the portfolio return is maximized, and the financial risk is minimized by selecting âweightsâ or quantities of each asset [1]. One challenge in this framework is how to quantify the financial risk. Throughout this notebook, we will examine five different risk measures (mean-variance (MV), mean-absolute deviation (MAD), Minmax (MM), value-at-risk (VaR), and conditional value-at-risk (CVaR)) and demonstrate their use in a motivating example for product portfolio optimization.</p>
</section>
<section id="common-risk-measures-for-portfolio-optimization">
<h2><span class="section-number">4.4.2. </span>Common Risk Measures for Portfolio Optimization<a class="headerlink" href="#common-risk-measures-for-portfolio-optimization" title="Link to this heading">#</a></h2>
<section id="mean-variance-mv-1-2">
<h3><span class="section-number">4.4.2.1. </span>Mean-Variance (MV) [1,2]<a class="headerlink" href="#mean-variance-mv-1-2" title="Link to this heading">#</a></h3>
<p>MV was the original quantifier of risk used by Markowitz in 1959. Here the risk is defined as the variance for a given expected return. The mathematical model is detailed in the following equations where <span class="math notranslate nohighlight">\(x_i\)</span> and <span class="math notranslate nohighlight">\(x_j\)</span> represent the quantity of assets i and j, and <span class="math notranslate nohighlight">\(\sigma_{i,j}\)</span> represents the covariance of asset i and j.</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
MV = \sum_{i=1}^{n} \sum_{j=1}^{n} \sigma_{i,j} x_i x_j 
\end{align*}\]</div>
<p>Although MV is easy to implement for simple portfolio problems, the computation of the covariance matrix makes it challenging to implement on large-scale problems. Additionally, if data is not normally distributed (a common challenge with real data) and there lies asymmetry in the probability distribution leading to a need for different risk measures to better quantify the risk-return tradeoffs.</p>
<section id="literature-examples-using-mv">
<h4><span class="section-number">4.4.2.1.1. </span>Literature Examples Using MV<a class="headerlink" href="#literature-examples-using-mv" title="Link to this heading">#</a></h4>
<div class="csl-entry">Xu, D., Bai, Z., Jin, X., Yang, X., Chen, S., &#38; Zhou, M. (2022). A mean-variance portfolio optimization approach for high-renewable energy hub. <i>Applied Energy</i>, <i>325</i>. https://doi.org/10.1016/j.apenergy.2022.119888</div>
<div class="csl-entry">Chen, W., Zhang, H., Mehlawat, M. K., &#38; Jia, L. (2021). Meanâvariance portfolio optimization using machine learning-based stock price prediction. <i>Applied Soft Computing</i>, <i>100</i>. https://doi.org/10.1016/j.asoc.2020.106943</div></section>
</section>
<section id="mean-absolute-deviation-mad-1-3">
<h3><span class="section-number">4.4.2.2. </span>Mean-Absolute Deviation (MAD) [1,3]<a class="headerlink" href="#mean-absolute-deviation-mad-1-3" title="Link to this heading">#</a></h3>
<p>MAD was proposed by Konno and Yamazaki in 1991. The MAD model is a variant of the MV model in which the measure of risk is replaced by the absolute deviation. The mathematical model is detailed in the following equations where <span class="math notranslate nohighlight">\(x_j\)</span> represents the quantity of asset j and <span class="math notranslate nohighlight">\(R_j\)</span> represents the return of asset j.</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
MAD = E \left[ \mid \sum_{j=1}^{n} R_j x_j -E \left[ \sum_{j=1}^{n} R_j x_j \right] \mid \right]
\end{align*}\]</div>
<p>MAD can be employed for large-scale and highly diversified portfolio selection problems. One drawback of this risk measure is that it penalizes both positive and negative deviations.</p>
<section id="graphical-representation-3">
<h4><span class="section-number">4.4.2.2.1. </span>Graphical Representation [3]<a class="headerlink" href="#graphical-representation-3" title="Link to this heading">#</a></h4>
<p><img alt="mad.png" src="https://raw.githubusercontent.com/ndcbe/optimization/main/media/contrib/mad_diagram.png" /></p>
</section>
<section id="literature-examples-using-mad">
<h4><span class="section-number">4.4.2.2.2. </span>Literature Examples Using MAD<a class="headerlink" href="#literature-examples-using-mad" title="Link to this heading">#</a></h4>
<div class="csl-entry">Hosseini-Nodeh, Z., Khanjani-Shiraz, R., &#38; Pardalos, P. M. (2023). Portfolio optimization using robust mean absolute deviation model: Wasserstein metric approach. <i>Finance Research Letters</i>. https://doi.org/10.1016/j.frl.2023.103735</div>
<div class="csl-entry">Ferreira, L., Borenstein, D., Righi, M. B., &#38; de Almeida Filho, A. T. (2018). A fuzzy hybrid integrated framework for portfolio optimization in private banking. <i>Expert Systems with Applications</i>, <i>92</i>, 350â362. https://doi.org/10.1016/j.eswa.2017.09.055</div></section>
</section>
<section id="minimax-mm-1">
<h3><span class="section-number">4.4.2.3. </span>Minimax (MM) [1]<a class="headerlink" href="#minimax-mm-1" title="Link to this heading">#</a></h3>
<p>MM uses the minimum return as a measure of risk. In scenarios where the asset returns are multivariate and normally distributed, both MM and MV lead to the same result. This risk measure is simply shown below, where <span class="math notranslate nohighlight">\(M_p\)</span> represents the minimum portfolio return.</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
MM = M_p 
\end{align*}\]</div>
<p>MM has certain advantages when the returns are not normally distributed. Additionally, MM is fast due to its property of linear
programming and can be employed for more complex models and constraints. One of the
disadvantages of MM is its sensitivity to outliers. Hence, it cannot be used when the historical data is missing.</p>
<section id="literature-examples-using-mm">
<h4><span class="section-number">4.4.2.3.1. </span>Literature Examples Using MM<a class="headerlink" href="#literature-examples-using-mm" title="Link to this heading">#</a></h4>
<div class="csl-entry">Li, B., Sun, Y., Aw, G., &#38; Teo, K. L. (2019). Uncertain portfolio optimization problem under a minimax risk measure. <i>Applied Mathematical Modelling</i>, <i>76</i>, 274â281. https://doi.org/10.1016/j.apm.2019.06.019</div>
<div class="csl-entry">Polak, G. G., Rogers, D. F., &#38; Sweeney, D. J. (2010). Risk management strategies via minimax portfolio optimization. <i>European Journal of Operational Research</i>, <i>207</i>(1), 409â419. https://doi.org/10.1016/j.ejor.2010.04.025</div></section>
</section>
<section id="value-at-risk-var-1-4">
<h3><span class="section-number">4.4.2.4. </span>Value-at-Risk (VaR) [1,4]<a class="headerlink" href="#value-at-risk-var-1-4" title="Link to this heading">#</a></h3>
<p>VaR is a measure of how the market value of an asset is likely to reduce over a period of time under certain market
conditions. VaR requires the determination of three parameters (i) time horizon, (ii) confidence level
time horizon, and (iii) unit of VaR. The VaR at a given confidence level Î² corresponds to the 1âÎ² percentile of the profit distribution, namely the lowest yearly profit after excluding all worse profits whose joint probability is at most 1âÎ². The formulation from Mutran et al. (2020) is shown below. Here the maximum V represents VaR, <span class="math notranslate nohighlight">\(R_j\)</span> is the return of asset j, and 1[Â·] stands for the Heavside step function, such that 1[x] = 1 for x <span class="math notranslate nohighlight">\(\geq\)</span> 0 and 1[x]=0 otherwise.</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
VaR_{\beta} = \max V \\
s.t.  \sum_{j=1}^{N} 1 \left[ V - R_j \right] \leq (1-\beta)N
\end{align*}\]</div>
<p>VaR can be misleading as it does not consider the worst-case loss. Additionally, VaR Jorion is discrete in nature and difficult to implement mathematically.</p>
<section id="literature-examples-using-var">
<h4><span class="section-number">4.4.2.4.1. </span>Literature Examples Using VaR<a class="headerlink" href="#literature-examples-using-var" title="Link to this heading">#</a></h4>
<div class="csl-entry">al Janabi, M. A. M., Ferrer, R., &#38; Shahzad, S. J. H. (2019). Liquidity-adjusted value-at-risk optimization of a multi-asset portfolio using a vine copula approach. <i>Physica A: Statistical Mechanics and Its Applications</i>, <i>536</i>. https://doi.org/10.1016/j.physa.2019.122579</div></section>
</section>
<section id="conditional-value-at-risk-cvar-1-4">
<h3><span class="section-number">4.4.2.5. </span>Conditional Value-at-Risk (CVaR) [1,4]<a class="headerlink" href="#conditional-value-at-risk-cvar-1-4" title="Link to this heading">#</a></h3>
<p>CVaR is a scenario-based approach where the condition associated with VaR is the weighted average of VaR and losses exceeding VaR. This quantity represents the expected value of the 100(1-Î²) % worst scenarios at a given confidence level Î². CVaR is an alternative to VaR that is more sensitive to the shape of the tail of the scenario distribution. Additionally, CVaR is a coherent and convex measure of risk.</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
CVaR_{\beta} = VaR_{\beta} - \frac{1}{(1-\beta)N}  \sum_{j=1}^{N} max \left[ 0, VaR_{\beta} - R_j \right]
\end{align*}\]</div>
<p>One disadvantage of CVaR is that it cannot indicate the maximum loss that can be incurred.</p>
<section id="graphical-representation-4">
<h4><span class="section-number">4.4.2.5.1. </span>Graphical Representation [4]<a class="headerlink" href="#graphical-representation-4" title="Link to this heading">#</a></h4>
<p><img alt="cvar.PNG" src="https://raw.githubusercontent.com/ndcbe/optimization/main/media/contrib/cvar_diagram.png" /></p>
<p>*<em>In this figure EP represents the expected value of the profit distribution (average profit) where profit is representative of the portfolio return</em></p>
</section>
<section id="literature-examples-using-cvar">
<h4><span class="section-number">4.4.2.5.2. </span>Literature Examples Using CVaR<a class="headerlink" href="#literature-examples-using-cvar" title="Link to this heading">#</a></h4>
<div class="csl-entry">Mutran, V. M., Ribeiro, C. O., Nascimento, C. A. O., &#38; Chachuat, B. (2020). Risk-conscious optimization model to support bioenergy investments in the Brazilian sugarcane industry. <i>Applied Energy</i>, <i>258</i>. https://doi.org/10.1016/j.apenergy.2019.113978</div>
<div class="csl-entry">Xuan, A., Shen, X., Guo, Q., &#38; Sun, H. (2021). A conditional value-at-risk based planning model for integrated energy system with energy storage and renewables. <i>Applied Energy</i>, <i>294</i>. https://doi.org/10.1016/j.apenergy.2021.116971</div></section>
</section>
</section>
<section id="motivating-example-product-portfolio-optimization-in-the-brazilian-sugarcane-industry">
<h2><span class="section-number">4.4.3. </span>Motivating Example: Product Portfolio Optimization in the Brazilian Sugarcane Industry<a class="headerlink" href="#motivating-example-product-portfolio-optimization-in-the-brazilian-sugarcane-industry" title="Link to this heading">#</a></h2>
<p>Brazil is the world leader in sugar production and exportation. In 2015, sugarcane GDP reached US$ 28.5 billion, with a production scale that achieved more than 30 million tons of sugar and 21 million cubic meters of ethanol [5]. The price of ethanol in Brazil is limited by the domestic price of oil and international fuel market conditions, and sugar prices are defined at the international commodity market. Weather conditions, international sugar prices, and instability of governmental fuel policies and subsidies create huge uncertainties in these markets [6]. Therefore, it is essential to quantify the financial risk from these volatile markets. Here we use portfolio optimization and three different risk measures to mitigate the impacts of financial risk in this industry by changing the sugarcane mill product portfolio.</p>
<section id="problem-definition">
<h3><span class="section-number">4.4.3.1. </span>Problem Definition<a class="headerlink" href="#problem-definition" title="Link to this heading">#</a></h3>
<p>For this problem, we model a sugarcane mill that can produce sugar, ethanol, and electricity with the ability to sell electricity to free and regulated markets. The overall capacity of the sugarcane mill is 3,000,000 tonnes of sugarcane, and conversion and cost data are provided.</p>
</section>
<section id="process-flow-diagram">
<h3><span class="section-number">4.4.3.2. </span>Process Flow Diagram<a class="headerlink" href="#process-flow-diagram" title="Link to this heading">#</a></h3>
<p><img alt="op1.jpg" src="https://raw.githubusercontent.com/ndcbe/optimization/main/media/contrib/process_PFD.jpg" /></p>
</section>
<section id="process-model">
<h3><span class="section-number">4.4.3.3. </span>Process Model<a class="headerlink" href="#process-model" title="Link to this heading">#</a></h3>
<p><em><strong>Sets</strong></em></p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
p \in P: \text{Products} \\
s \in S: Saleable\ Products \\
c \in C: Commodities \\
u \in U: Process\ Units \\
q \in Q: Historical\ Price\ Scenarios
\end{align*}\]</div>
<p><em><strong>Parameters</strong></em></p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
Ca: Yearly\ production\ of\ sugarcane \\
\tau_{u}: Maximum\ capacity\ of\ process\ unit\ u \\
PC_{s}: Production\ cost\ of\ saleable\ product\ s \\
\theta_{f,u,p}: Conversion\ of\ resource\ f\ in\ process\ unit\ u\ to\ product\ p \\
\gamma_{u,p}: Generation\ of\ product\ p\ in\ unit\ u \\
HP_{q,c}: Historical\ Prices\ at\ price\ scenario\ q\\
\pi_{reg}: Price \ of \ electricity \ at \ the \ regulated \ market
\end{align*}\]</div>
<p><em><strong>Variables</strong></em></p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
x_{p}: Amount\ of\ product\ p \\
profit_{q}: Profit\ for\ each\ historical\ price\ scenario\ q\\
Eprofit: Expected\ value\ of\ the\ profit
\end{align*}\]</div>
<p><em><strong>Constraints</strong></em></p>
<p><em>Mass Balances</em></p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
x_{jui} = Ca \cdot \theta_{cane,mill,jui} \\
x_{bag} = Ca \cdot \theta_{cane,mill,bag} \\
x_{jui} = x_{jui-fact} + x_{jui-dist} \\
x_{sug} = x_{jui-fact} \cdot \theta_{jui,fact,sug} \\
x_{mol} = x_{sug} \cdot \gamma_{mol,fact} \\
x_{eth} = x_{jui-dist} \cdot \theta_{jui,dist,eth} + x_{mol} \cdot \theta_{mol,dist,eth} \\
x_{reg} + x_{free} = x_{el-r}
\end{align*}\]</div>
<p><em>Profit Calculations</em></p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
profit_{q} = \sum_{c \in C} x_{p} \cdot HP_{q,c} + x_{reg} \cdot \pi_{reg} - \sum_{s \in S} x_{s} \cdot PC_{s} \ \ \forall \ \ q \in Q\\
Eprofit = \frac{1}{Q} \sum_{q \in Q} profit_{q} \\ 
\end{align*}\]</div>
</section>
<section id="degree-of-freedom-dof-analysis">
<h3><span class="section-number">4.4.3.4. </span>Degree of Freedom (DOF) Analysis<a class="headerlink" href="#degree-of-freedom-dof-analysis" title="Link to this heading">#</a></h3>
<p><strong>Number of Variables</strong></p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
x_{p} \cdot 10 \ products \\
profit_{Q} \cdot Q \\
Eproft \cdot 1 \\
Total\ Variables = 10 + Q + 1
\end{align*}\]</div>
<p><strong>Number of Constraints</strong></p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
7 \ mass \ balances \\
profit \ scenarios \cdot Q \\
Eproft \cdot 1 \\
Total\ Constraints = 7 + Q + 1
\end{align*}\]</div>
<p><strong>DOF</strong></p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
DOF = Variables - Constraints \\
DOF = 10 + Q + 1 - 7 - Q - 1 \\
DOF = 3
\end{align*}\]</div>
</section>
<section id="visualize-input-data">
<h3><span class="section-number">4.4.3.5. </span>Visualize Input Data<a class="headerlink" href="#visualize-input-data" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyomo.environ</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pyo</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Load Data From CSV files stored on Github</span>
<span class="n">path_cap</span><span class="o">=</span><span class="s1">&#39;https://raw.githubusercontent.com/MadelynnWatson/RiskMeasures/main/Capacity.csv&#39;</span>
<span class="n">path_opex</span> <span class="o">=</span> <span class="s1">&#39;https://raw.githubusercontent.com/MadelynnWatson/RiskMeasures/main/OPEX.csv&#39;</span>
<span class="n">path_conv</span> <span class="o">=</span> <span class="s1">&#39;https://raw.githubusercontent.com/MadelynnWatson/RiskMeasures/main/conversions.csv&#39;</span>
<span class="n">path_gen</span> <span class="o">=</span> <span class="s1">&#39;https://raw.githubusercontent.com/MadelynnWatson/RiskMeasures/main/generation.csv&#39;</span>
<span class="n">path_hp</span> <span class="o">=</span> <span class="s1">&#39;https://raw.githubusercontent.com/MadelynnWatson/RiskMeasures/main/historicalprices.csv&#39;</span>
<span class="n">df_maxcap</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_cap</span><span class="p">)</span>
<span class="n">df_prodcost</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_opex</span><span class="p">)</span>
<span class="n">df_conv</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_conv</span><span class="p">)</span>
<span class="n">df_gen</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_gen</span><span class="p">)</span>
<span class="n">df_hp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_hp</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Uncomment to Display Additional Data in Tables</span>
<span class="c1"># display(df_maxcap)</span>
<span class="c1"># display(df_prodcost)</span>
<span class="c1"># display(df_conv)</span>
<span class="c1"># display(df_gen)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Plot historical prices</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">df_hp</span><span class="p">[</span><span class="s1">&#39;eth&#39;</span><span class="p">])</span><span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">df_hp</span><span class="p">[</span><span class="s1">&#39;eth&#39;</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Ethanol&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Week (2013 - 2022)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;USD/m$^3$&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">df_hp</span><span class="p">[</span><span class="s1">&#39;sug&#39;</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Sugar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Week (2013 - 2022)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;USD/tonne&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">df_hp</span><span class="p">[</span><span class="s1">&#39;fre&#39;</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Electricity to Free Market&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Week (2013 - 2022)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;USD/MWh&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/cc4c26d60090a63bd3a96b8bdb2d72128a89f17ad0229123ba6f4896a2df5872.png" src="../../_images/cc4c26d60090a63bd3a96b8bdb2d72128a89f17ad0229123ba6f4896a2df5872.png" />
<img alt="../../_images/6810f15b176d97e0c5bcc4a10336c53c25f12c79a57fc8e32e483e7459fdf6ef.png" src="../../_images/6810f15b176d97e0c5bcc4a10336c53c25f12c79a57fc8e32e483e7459fdf6ef.png" />
<img alt="../../_images/19b6c3fb146232b1db3c76f17132d8ac0aa9715822d4764190ed326b2d6326af.png" src="../../_images/19b6c3fb146232b1db3c76f17132d8ac0aa9715822d4764190ed326b2d6326af.png" />
</div>
</div>
</section>
<section id="define-base-model-in-pyomo">
<h3><span class="section-number">4.4.3.6. </span>Define Base Model in Pyomo<a class="headerlink" href="#define-base-model-in-pyomo" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Create Base Model In Pyomo</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_model</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function buils a superstructure model in Pyomo for a sugarcane mill that can produce jet fuel.</span>

<span class="sd">    Inputs: </span>
<span class="sd">            product: desired product to maximize</span>
<span class="sd">            pathway: Excel sheet containing Jet fuel</span>

<span class="sd">    Returns: Pyomo model m</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">m</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">()</span>
    
    <span class="c1">#SETS</span>
    <span class="n">resources</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sug&#39;</span><span class="p">,</span> <span class="s1">&#39;eth&#39;</span><span class="p">,</span> <span class="s1">&#39;fre&#39;</span><span class="p">,</span> <span class="s1">&#39;reg&#39;</span><span class="p">,</span> <span class="s1">&#39;cane&#39;</span><span class="p">,</span> <span class="s1">&#39;jui&#39;</span><span class="p">,</span> <span class="s1">&#39;mol&#39;</span><span class="p">,</span> <span class="s1">&#39;bag&#39;</span><span class="p">,</span> <span class="s1">&#39;el-r&#39;</span><span class="p">]</span>
    <span class="n">saleable_products</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sug&#39;</span><span class="p">,</span> <span class="s1">&#39;eth&#39;</span><span class="p">,</span> <span class="s1">&#39;fre&#39;</span><span class="p">,</span> <span class="s1">&#39;reg&#39;</span><span class="p">]</span>
    <span class="n">processes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mill&#39;</span><span class="p">,</span> <span class="s1">&#39;fact&#39;</span><span class="p">,</span> <span class="s1">&#39;dist&#39;</span><span class="p">,</span><span class="s1">&#39;cogen&#39;</span><span class="p">]</span>
    <span class="n">commodity</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fre&#39;</span><span class="p">,</span><span class="s1">&#39;sug&#39;</span><span class="p">,</span><span class="s1">&#39;eth&#39;</span><span class="p">]</span>

    <span class="c1">#PARAMETERS</span>
    <span class="c1">#Scalars</span>
    <span class="n">Ca</span> <span class="o">=</span> <span class="mi">3000000</span>  <span class="c1">#Annual Sugarcane Capacity</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="mf">0.9</span>   <span class="c1">#Confidence Level For CVaR Formulation</span>
    <span class="n">price_reg</span> <span class="o">=</span> <span class="mf">72.5</span>   <span class="c1">#Price of electricity sold to the regulated market</span>

    <span class="c1">#Fill in Dictionaries with Excel Data</span>
    <span class="n">max_cap</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">prodcost</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">conv</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">gen</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">hp</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_maxcap</span><span class="p">[</span><span class="s1">&#39;process&#39;</span><span class="p">])):</span>
        <span class="n">max_cap</span><span class="p">[</span><span class="n">df_maxcap</span><span class="p">[</span><span class="s1">&#39;process&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df_maxcap</span><span class="p">[</span><span class="s1">&#39;capacity&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_prodcost</span><span class="p">[</span><span class="s1">&#39;saleable_product&#39;</span><span class="p">])):</span>
        <span class="n">prodcost</span><span class="p">[</span><span class="n">df_prodcost</span><span class="p">[</span><span class="s1">&#39;saleable_product&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df_prodcost</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_conv</span><span class="p">[</span><span class="n">k</span><span class="p">])):</span>
            <span class="n">conv</span><span class="p">[(</span><span class="n">df_conv</span><span class="p">[</span><span class="s1">&#39;resource&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="n">df_conv</span><span class="p">[</span><span class="s1">&#39;process&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="n">df_conv</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_gen</span><span class="p">[</span><span class="n">k</span><span class="p">])):</span>
            <span class="n">gen</span><span class="p">[(</span><span class="n">df_gen</span><span class="p">[</span><span class="s1">&#39;process&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="n">df_gen</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">commodity</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_hp</span><span class="p">[</span><span class="n">k</span><span class="p">])):</span>
            <span class="n">hp</span><span class="p">[(</span><span class="n">df_hp</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="n">df_hp</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>

    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_hp</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">])</span>
    <span class="n">q</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;t</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        
    <span class="c1">#PYOMO SETS</span>
    <span class="n">m</span><span class="o">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">resources</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">saleable_products</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">saleable_products</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">processes</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">processes</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">q</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">commodities</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">commodity</span><span class="p">)</span>
    
    <span class="n">m</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">N</span><span class="p">)</span>

    <span class="c1">#VARIABLES</span>
    <span class="c1">#Positive Variables</span>
    <span class="n">m</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">resources</span><span class="p">,</span> <span class="n">within</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">resources</span><span class="p">,</span><span class="n">m</span><span class="o">.</span><span class="n">processes</span><span class="p">,</span> <span class="n">within</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span> <span class="c1">#For juice split point</span>
    <span class="n">m</span><span class="o">.</span><span class="n">profit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">EP</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">()</span>

    <span class="c1">#CONSTRAINTS</span>
    <span class="c1">#Superstructure Constraints</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mill1</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Ca</span> <span class="o">*</span> <span class="n">conv</span><span class="p">[</span><span class="s1">&#39;cane&#39;</span><span class="p">,</span><span class="s1">&#39;mill&#39;</span><span class="p">,</span><span class="s1">&#39;jui&#39;</span><span class="p">]</span>
    <span class="n">m</span><span class="o">.</span><span class="n">milleq1</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">mill1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">mill2</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;bag&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Ca</span> <span class="o">*</span> <span class="n">conv</span><span class="p">[</span><span class="s1">&#39;cane&#39;</span><span class="p">,</span><span class="s1">&#39;mill&#39;</span><span class="p">,</span><span class="s1">&#39;bag&#39;</span><span class="p">]</span>
    <span class="n">m</span><span class="o">.</span><span class="n">milleq2</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">mill2</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">juice1</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">m</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">,</span><span class="s1">&#39;fact&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">,</span><span class="s1">&#39;dist&#39;</span><span class="p">]</span>
    <span class="n">m</span><span class="o">.</span><span class="n">juiceeq1</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">juice1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">juice2</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">,</span><span class="s1">&#39;fact&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_cap</span><span class="p">[</span><span class="s1">&#39;fact&#39;</span><span class="p">]</span>
    <span class="n">m</span><span class="o">.</span><span class="n">juiceeq2</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">juice2</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">juice3</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">,</span><span class="s1">&#39;dist&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_cap</span><span class="p">[</span><span class="s1">&#39;dist&#39;</span><span class="p">]</span>
    <span class="n">m</span><span class="o">.</span><span class="n">juiceeq3</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">juice3</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sugar1</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;sug&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">conv</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">,</span> <span class="s1">&#39;fact&#39;</span><span class="p">,</span> <span class="s1">&#39;sug&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">,</span><span class="s1">&#39;fact&#39;</span><span class="p">]</span>
    <span class="n">m</span><span class="o">.</span><span class="n">su1</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">sugar1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sugar2</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;mol&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">gen</span><span class="p">[</span><span class="s1">&#39;fact&#39;</span><span class="p">,</span><span class="s1">&#39;mol&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;sug&#39;</span><span class="p">]</span>
    <span class="n">m</span><span class="o">.</span><span class="n">su2</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">sugar2</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ethanol1</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;eth&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">conv</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">,</span><span class="s1">&#39;dist&#39;</span><span class="p">,</span><span class="s1">&#39;eth&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">,</span><span class="s1">&#39;dist&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">conv</span><span class="p">[</span><span class="s1">&#39;mol&#39;</span><span class="p">,</span><span class="s1">&#39;dist&#39;</span><span class="p">,</span><span class="s1">&#39;eth&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;mol&#39;</span><span class="p">]</span>
    <span class="n">m</span><span class="o">.</span><span class="n">et1</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">ethanol1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">el_prod</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;el-r&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Ca</span> <span class="o">*</span> <span class="mf">0.053</span> <span class="c1">#53 kWh produced per ton of sugarcane processes</span>
    <span class="n">m</span><span class="o">.</span><span class="n">el_produced</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">el_prod</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">el_sales</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;fre&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;reg&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;el-r&#39;</span><span class="p">]</span>
    <span class="n">m</span><span class="o">.</span><span class="n">electricity</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">el_sales</span><span class="p">)</span>
    
    <span class="c1">#Expected Profit</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">profit</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">q</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">profit</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">==</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;sug&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">hp</span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="s1">&#39;sug&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;eth&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">hp</span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="s1">&#39;eth&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;fre&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">hp</span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="s1">&#39;fre&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;reg&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">price_reg</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">prodcost</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">saleable_products</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">profiteq</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">,</span> <span class="n">rule</span> <span class="o">=</span> <span class="n">profit</span><span class="p">)</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">eprofit1</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">EP</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">N</span><span class="p">)</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">profit</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">ep1</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">eprofit1</span><span class="p">)</span>
    
    <span class="c1">#Product Revenues to be used in analysis</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sug_prof</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;sug&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">hp</span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="s1">&#39;sug&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">N</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">avg_sug_prof</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">sug_prof</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">eth_prof</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;eth&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">hp</span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="s1">&#39;eth&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">N</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">avg_eth_prof</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">eth_prof</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">el_prof</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;fre&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">hp</span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="s1">&#39;fre&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">N</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">avg_el_prof</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">el_prof</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">m</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="maximize-profit-only-no-risk-measure">
<h3><span class="section-number">4.4.3.7. </span>Maximize Profit Only (No Risk Measure)<a class="headerlink" href="#maximize-profit-only-no-risk-measure" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Load the base model from the function created above</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">()</span>

<span class="c1">#Set the objective to maximize the expected value of the profit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">obj_rule</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">EP</span>
<span class="n">m</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">obj_rule</span><span class="p">,</span> <span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">maximize</span><span class="p">)</span>

<span class="c1">#Solve the Model</span>
<span class="n">sol</span> <span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="s1">&#39;ipopt&#39;</span><span class="p">)</span>

<span class="n">sol</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Results&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;----------------------------------------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Expected Profit&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">obj</span><span class="p">),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;USD&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Ethanol Produced&#39;</span><span class="p">,</span>  <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;eth&#39;</span><span class="p">]),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;m3&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sugar Produced&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;sug&#39;</span><span class="p">]),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;tonne&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Electricity Produced&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;el-r&#39;</span><span class="p">]),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;MWh&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Electricity to Free Market&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;fre&#39;</span><span class="p">]),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;MWh&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Electricity to Regulated Market&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;reg&#39;</span><span class="p">]),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;MWh&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Results
----------------------------------------------------
Expected Profit 64780608.4 USD
Ethanol Produced 155062.24 m3
Sugar Produced 189129.78 tonne
Electricity Produced 159000.0 MWh
Electricity to Free Market 159000.0 MWh
Electricity to Regulated Market -0.0 MWh
</pre></div>
</div>
</div>
</div>
</section>
<section id="visualize-results">
<h3><span class="section-number">4.4.3.8. </span>Visualize Results<a class="headerlink" href="#visualize-results" title="Link to this heading">#</a></h3>
<section id="profit-distribution">
<h4><span class="section-number">4.4.3.8.1. </span>Profit Distribution<a class="headerlink" href="#profit-distribution" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Collect the profit distribution</span>
<span class="n">profits</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">:</span>
    <span class="n">profits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">profit</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

<span class="c1">#Collect the minimum profit</span>
<span class="n">min_prof</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">profits</span><span class="p">)</span>

<span class="c1">#Plot the Profit Distribution</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">profits</span><span class="p">),</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">ymin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">ymax</span><span class="o">=</span> <span class="mi">160</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">obj</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Expected Profit&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">ymin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="mi">160</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">min_prof</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Minimum Profit&#39;</span><span class="p">),</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;profit$_q$ M USD&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Results&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Expected Profit:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">obj</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;M USD&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Minimum Profit:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">min_prof</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;M USD&#39;</span><span class="p">)</span>
<span class="n">difference</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">obj</span><span class="p">)</span> <span class="o">-</span> <span class="n">min_prof</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Difference:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">difference</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;M USD&#39;</span><span class="p">)</span>

<span class="c1">#Collect Results for Conclusion</span>
<span class="n">final_EP</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">final_min</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">final_diff</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">final_EP</span><span class="p">[</span><span class="s1">&#39;No Risk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">obj</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span>
<span class="n">final_min</span><span class="p">[</span><span class="s1">&#39;No Risk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_prof</span><span class="o">/</span><span class="mf">1e6</span>
<span class="n">final_diff</span><span class="p">[</span><span class="s1">&#39;No Risk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">difference</span><span class="o">/</span><span class="mf">1e6</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/8927fe6ac273b5c9c610dac76e39abbeb13be910d9b2e65b0e6255d99f97662a.png" src="../../_images/8927fe6ac273b5c9c610dac76e39abbeb13be910d9b2e65b0e6255d99f97662a.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Results
-------------------------------------
Expected Profit: 64.78 M USD
Minimum Profit: -39.0 M USD
Difference: 103.78 M USD
</pre></div>
</div>
</div>
</div>
</section>
<section id="product-distribution">
<h4><span class="section-number">4.4.3.8.2. </span>Product Distribution<a class="headerlink" href="#product-distribution" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Sugar&#39;</span><span class="p">,</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">avg_sug_prof</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Ethanol&#39;</span><span class="p">,</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">avg_eth_prof</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Electricity </span><span class="se">\n</span><span class="s1"> Free </span><span class="se">\n</span><span class="s1"> Market&#39;</span><span class="p">,</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">avg_el_prof</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Electricity </span><span class="se">\n</span><span class="s1"> Regulated </span><span class="se">\n</span><span class="s1"> Market&#39;</span><span class="p">,</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;reg&#39;</span><span class="p">])</span><span class="o">*</span><span class="mf">72.5</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Product&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Revenue from </span><span class="se">\n</span><span class="s1"> Each Profit (USD)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/8978d82b5d7d75d52ca29867d3ce05ba9c255ac62be7c385933ce4b4bcb65f70.png" src="../../_images/8978d82b5d7d75d52ca29867d3ce05ba9c255ac62be7c385933ce4b4bcb65f70.png" />
</div>
</div>
</section>
</section>
</section>
<section id="solve-model-with-risk-measures">
<h2><span class="section-number">4.4.4. </span>Solve Model with Risk Measures<a class="headerlink" href="#solve-model-with-risk-measures" title="Link to this heading">#</a></h2>
<section id="formulate-the-mv-objective">
<h3><span class="section-number">4.4.4.1. </span>Formulate the MV Objective<a class="headerlink" href="#formulate-the-mv-objective" title="Link to this heading">#</a></h3>
<p><em><strong>Additional Parameters</strong></em></p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
\sigma_{i,j}: \ Covariance \ matrix \ between \ returns \ i \ and \ j \in \ commodities
\end{align*}\]</div>
<p><em><strong>Calculating Returns from Historical Price Data</strong></em></p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
r^{lin} &amp; = \frac{HP_{q+\Delta q} - HP_q}{HP_q}  \ for \ c \in C
\end{align*}\]</div>
<p><em><strong>Objective</strong></em></p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
minimize \ MV = \sum_{i=1}^{n} \sum_{j=1}^{n} \sigma_{i,j} x_i x_j 
\end{align*}\]</div>
<section id="calculate-the-covariance-matrix">
<h4><span class="section-number">4.4.4.1.1. </span>Calculate the Covariance Matrix<a class="headerlink" href="#calculate-the-covariance-matrix" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Calculate the Covariance Matrix</span>

<span class="c1">#Drop the scenario number column</span>
<span class="n">price</span> <span class="o">=</span> <span class="n">df_hp</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">])</span>

<span class="c1">#Calculate Returns</span>
<span class="n">Returns</span> <span class="o">=</span> <span class="n">price</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">/</span><span class="n">price</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">covar</span> <span class="o">=</span> <span class="n">Returns</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Covariance Matrix&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">covar</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Covariance Matrix
-------------------
          fre       sug       eth
fre  0.094993 -0.000350 -0.000756
sug -0.000350  0.000922  0.000390
eth -0.000756  0.000390  0.001578
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Reload the base Model</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">()</span>

<span class="c1">#Define MV as the objective</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mean_value</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">covar</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">commodities</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">commodities</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">mean_value</span><span class="p">,</span> <span class="n">sense</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">minimize</span><span class="p">)</span>

<span class="c1">#Solve the Model</span>
<span class="n">sol</span> <span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="s1">&#39;ipopt&#39;</span><span class="p">)</span>

<span class="n">sol</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Results&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Expected Profit&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;USD&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Ethanol Produced&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;eth&#39;</span><span class="p">]),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;m3&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sugar Produced&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;sug&#39;</span><span class="p">]),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;tonne&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Electricity Produced&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;el-r&#39;</span><span class="p">]),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;MWh&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Electricity to Free Market&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;fre&#39;</span><span class="p">]),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;MWh&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Electricity to Regulated Market&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;reg&#39;</span><span class="p">]),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;MWh&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Results
--------------------------------------
Expected Profit 56801237.35 USD
Ethanol Produced 179548.97 m3
Sugar Produced 148824.72 tonne
Electricity Produced 159000.0 MWh
Electricity to Free Market 1976.55 MWh
Electricity to Regulated Market 157023.45 MWh
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="id1">
<h3><span class="section-number">4.4.4.2. </span>Visualize Results<a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<section id="id2">
<h4><span class="section-number">4.4.4.2.1. </span>Profit Distribution<a class="headerlink" href="#id2" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Collect the profit distribution</span>
<span class="n">profits</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">:</span>
    <span class="n">profits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">profit</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

<span class="c1">#Collect the minimum profit</span>
<span class="n">min_prof</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">profits</span><span class="p">)</span>

<span class="c1">#Plot the Profit Distribution</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">profits</span><span class="p">),</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">ymin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">ymax</span><span class="o">=</span> <span class="mi">220</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Expected Profit&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">ymin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="mi">220</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">min_prof</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Minimum Profit&#39;</span><span class="p">),</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;profit$_q$ M USD&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Results&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Expected Profit:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;M USD&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Minimum Profit:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">min_prof</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;M USD&#39;</span><span class="p">)</span>
<span class="n">difference</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">)</span> <span class="o">-</span> <span class="n">min_prof</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Difference:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">difference</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;M USD&#39;</span><span class="p">)</span>

<span class="c1">#Collect results for conclusion</span>
<span class="n">final_EP</span><span class="p">[</span><span class="s1">&#39;MV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span>
<span class="n">final_min</span><span class="p">[</span><span class="s1">&#39;MV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_prof</span><span class="o">/</span><span class="mf">1e6</span>
<span class="n">final_diff</span><span class="p">[</span><span class="s1">&#39;MV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">difference</span><span class="o">/</span><span class="mf">1e6</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/8e99e0632d69b5fad612aa4e5799dc2db039fc64e18bce8dd8746dbcef860c55.png" src="../../_images/8e99e0632d69b5fad612aa4e5799dc2db039fc64e18bce8dd8746dbcef860c55.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Results
-------------------------------------
Expected Profit: 56.8 M USD
Minimum Profit: -34.87 M USD
Difference: 91.68 M USD
</pre></div>
</div>
</div>
</div>
</section>
<section id="id3">
<h4><span class="section-number">4.4.4.2.2. </span>Product Distribution<a class="headerlink" href="#id3" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Sugar&#39;</span><span class="p">,</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">avg_sug_prof</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Ethanol&#39;</span><span class="p">,</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">avg_eth_prof</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Electricity </span><span class="se">\n</span><span class="s1"> Free </span><span class="se">\n</span><span class="s1"> Market&#39;</span><span class="p">,</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">avg_el_prof</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Electricity </span><span class="se">\n</span><span class="s1"> Regulated </span><span class="se">\n</span><span class="s1"> Market&#39;</span><span class="p">,</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;reg&#39;</span><span class="p">])</span><span class="o">*</span><span class="mf">72.5</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Product&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Revenue from </span><span class="se">\n</span><span class="s1"> Each Profit (USD)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/06cbc3cf0cc9736f0ef406e21dc85bcd13254999e57948f546e1107df46fa485.png" src="../../_images/06cbc3cf0cc9736f0ef406e21dc85bcd13254999e57948f546e1107df46fa485.png" />
</div>
</div>
</section>
</section>
<section id="formulate-the-mad-objective">
<h3><span class="section-number">4.4.4.3. </span>Formulate the MAD Objective<a class="headerlink" href="#formulate-the-mad-objective" title="Link to this heading">#</a></h3>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
minimize \ \ MAD = E \left[ \mid \sum_{j=1}^{n} R_j x_j -E \left[ \sum_{j=1}^{n} R_j x_j \right] \mid \right]
\end{align*}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Reload the base Model</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">()</span>

<span class="c1">#Create set of return indicies</span>
<span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">m</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>

<span class="c1">#Create new variables</span>
<span class="n">m</span><span class="o">.</span><span class="n">y_aux</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">within</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">z_aux</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">within</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>

<span class="c1">#Constrain y - z to be the abs portion</span>
<span class="k">def</span><span class="w"> </span><span class="nf">aux_con</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">j</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">y_aux</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">z_aux</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">Returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="p">((</span><span class="mi">1</span><span class="o">/</span><span class="n">m</span><span class="o">.</span><span class="n">N</span><span class="p">)</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">Returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">J</span><span class="p">)))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">commodities</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">aux</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">rule</span> <span class="o">=</span> <span class="n">aux_con</span><span class="p">)</span>

<span class="c1">#Define MAD as the objective</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mad</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">1</span><span class="o">/</span><span class="n">m</span><span class="o">.</span><span class="n">N</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">y_aux</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">z_aux</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">J</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">mad</span><span class="p">,</span> <span class="n">sense</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">minimize</span><span class="p">)</span>

<span class="c1">#Solve the Model</span>
<span class="n">sol</span> <span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="s1">&#39;ipopt&#39;</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Results&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;------------------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Expected Profit&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;USD&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Ethanol Produced&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;eth&#39;</span><span class="p">]),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;m3&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sugar Produced&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;sug&#39;</span><span class="p">]),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;tonne&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Electricity Produced&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;el-r&#39;</span><span class="p">]),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;MWh&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Electricity to Free Market&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;fre&#39;</span><span class="p">]),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;MWh&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Electricity to Regulated Market&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;reg&#39;</span><span class="p">]),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;MWh&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Results
------------------------------
Expected Profit 50666115.0 USD
Ethanol Produced 200905.27 m3
Sugar Produced 113672.34 tonne
Electricity Produced 159000.0 MWh
Electricity to Free Market 891.43 MWh
Electricity to Regulated Market 158108.57 MWh
</pre></div>
</div>
</div>
</div>
</section>
<section id="id4">
<h3><span class="section-number">4.4.4.4. </span>Visualize Results<a class="headerlink" href="#id4" title="Link to this heading">#</a></h3>
<section id="id5">
<h4><span class="section-number">4.4.4.4.1. </span>Profit Distribution<a class="headerlink" href="#id5" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Collect the profit distribution</span>
<span class="n">profits</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">:</span>
    <span class="n">profits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">profit</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

<span class="c1">#Collect the minimum profit</span>
<span class="n">min_prof</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">profits</span><span class="p">)</span>

<span class="c1">#Plot the Profit Distribution</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">profits</span><span class="p">),</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">ymin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">ymax</span><span class="o">=</span> <span class="mi">220</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Expected Profit&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">ymin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="mi">220</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">min_prof</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Minimum Profit&#39;</span><span class="p">),</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;profit$_q$ M USD&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Results&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Expected Profit:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;M USD&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Minimum Profit:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">min_prof</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;M USD&#39;</span><span class="p">)</span>
<span class="n">difference</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">)</span> <span class="o">-</span> <span class="n">min_prof</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Difference:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">difference</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;M USD&#39;</span><span class="p">)</span>

<span class="c1">#Collect results for conclusion</span>
<span class="n">final_EP</span><span class="p">[</span><span class="s1">&#39;MAD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span>
<span class="n">final_min</span><span class="p">[</span><span class="s1">&#39;MAD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_prof</span><span class="o">/</span><span class="mf">1e6</span>
<span class="n">final_diff</span><span class="p">[</span><span class="s1">&#39;MAD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">difference</span><span class="o">/</span><span class="mf">1e6</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/f80e6050d10e39a379f908644408357efba50d164a65fed320e8916f08abee6f.png" src="../../_images/f80e6050d10e39a379f908644408357efba50d164a65fed320e8916f08abee6f.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Results
-------------------------------------
Expected Profit: 50.67 M USD
Minimum Profit: -39.02 M USD
Difference: 89.68 M USD
</pre></div>
</div>
</div>
</div>
</section>
<section id="id6">
<h4><span class="section-number">4.4.4.4.2. </span>Product Distribution<a class="headerlink" href="#id6" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Sugar&#39;</span><span class="p">,</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">avg_sug_prof</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Ethanol&#39;</span><span class="p">,</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">avg_eth_prof</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Electricity </span><span class="se">\n</span><span class="s1"> Free Market&#39;</span><span class="p">,</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">avg_el_prof</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Electricity </span><span class="se">\n</span><span class="s1"> Regulated Market&#39;</span><span class="p">,</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;reg&#39;</span><span class="p">])</span><span class="o">*</span><span class="mf">72.5</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Product&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Revenue from </span><span class="se">\n</span><span class="s1"> Each Profit (USD)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/0840507ecc1569edf1c9f36731d3e87adf3205c0a19af48394f8701ed2a8c4b9.png" src="../../_images/0840507ecc1569edf1c9f36731d3e87adf3205c0a19af48394f8701ed2a8c4b9.png" />
</div>
</div>
</section>
</section>
<section id="formulate-the-cvar-objective">
<h3><span class="section-number">4.4.4.5. </span>Formulate the CVaR Objective<a class="headerlink" href="#formulate-the-cvar-objective" title="Link to this heading">#</a></h3>
<p><em><strong>Additional Parameters</strong></em></p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
\alpha: VaR \\
\beta: Confidence\ Level 
\end{align*}\]</div>
<p><em><strong>Additional Variables</strong></em></p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
shortfall_{q}: Difference \ between \ VaR \ and \ profit_{q} \ at \ price \ scenario \ q\\
\end{align*}\]</div>
<p><em><strong>Additional Constraints</strong></em></p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
shortfall_{q} \ \geq \ 0 \ \ \forall \ \ q \in Q \\
profit_{q} + shortfall_{q} - \alpha \geq 0 \ \ \forall \ \ q \in Q \\
CVaR = \alpha - \left[ \frac{1}{Q(1-\beta)} \sum_{q \in Q} shortfall_{q} \right] \\
\end{align*}\]</div>
<p><em><strong>CVaR Objective</strong></em></p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
\max{CVaR}
\end{align*}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Reload the base Model</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">()</span>

<span class="c1">#Add parameters</span>
<span class="n">beta</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="c1">#confidence interval</span>

<span class="c1">#Add variables</span>
<span class="n">m</span><span class="o">.</span><span class="n">shortfall</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">()</span>
<span class="n">m</span><span class="o">.</span><span class="n">CVaR</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">()</span>

<span class="c1">#Add CVaR Constraints</span>
<span class="k">def</span><span class="w"> </span><span class="nf">CVaR1</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">CVaR</span> <span class="o">==</span> <span class="n">m</span><span class="o">.</span><span class="n">alpha</span> <span class="o">-</span> <span class="p">((</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">N</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">beta</span><span class="p">)))</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">shortfall</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">))</span>
<span class="n">m</span><span class="o">.</span><span class="n">cvar1eq</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">CVaR1</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">CVaR2</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">q</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">shortfall</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> 
<span class="n">m</span><span class="o">.</span><span class="n">cvar2eq</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">,</span> <span class="n">rule</span> <span class="o">=</span> <span class="n">CVaR2</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">CVaR4</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">q</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">profit</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">shortfall</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">alpha</span> <span class="o">&gt;=</span> <span class="mi">0</span>
<span class="n">m</span><span class="o">.</span><span class="n">cvar4eq</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">,</span> <span class="n">rule</span> <span class="o">=</span> <span class="n">CVaR4</span><span class="p">)</span>

<span class="c1">#OBJECTIVE</span>
<span class="k">def</span><span class="w"> </span><span class="nf">obj_rule</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">CVaR</span>
<span class="n">m</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">obj_rule</span><span class="p">,</span> <span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">maximize</span><span class="p">)</span>

<span class="c1">#Solve the Model</span>
<span class="n">sol</span> <span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="s1">&#39;ipopt&#39;</span><span class="p">,</span> <span class="n">tee</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Results&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;------------------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Expected Profit&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;USD&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Ethanol Produced&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;eth&#39;</span><span class="p">]),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;m3&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sugar Produced&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;sug&#39;</span><span class="p">]),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;tonne&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Electricity Produced&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;el-r&#39;</span><span class="p">]),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;MWh&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Electricity to Free Market&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;fre&#39;</span><span class="p">]),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;MWh&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Electricity to Regulated Market&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;reg&#39;</span><span class="p">]),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;MWh&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING: Loading a SolverResults object with a warning status into
model.name=&quot;unknown&quot;;
    - termination condition: infeasible
    - message from solver: Ipopt 3.14.16\x3a Converged to a locally infeasible
      point. Problem may be infeasible.
Results
------------------------------
Expected Profit 137622.59 USD
Ethanol Produced -0.0 m3
Sugar Produced -0.0 tonne
Electricity Produced 1951.54 MWh
Electricity to Free Market -0.0 MWh
Electricity to Regulated Market 1951.54 MWh
</pre></div>
</div>
</div>
</div>
</section>
<section id="id7">
<h3><span class="section-number">4.4.4.6. </span>Visualize Results<a class="headerlink" href="#id7" title="Link to this heading">#</a></h3>
<section id="id8">
<h4><span class="section-number">4.4.4.6.1. </span>Profit Distribution<a class="headerlink" href="#id8" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Collect the profit distribution</span>
<span class="n">profits</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">:</span>
    <span class="n">profits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">profit</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

<span class="c1">#Collect the minimum profit</span>
<span class="n">min_prof</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">profits</span><span class="p">)</span>

<span class="c1">#Plot the Profit Distribution</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">profits</span><span class="p">),</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">ymin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">ymax</span><span class="o">=</span> <span class="mi">220</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Expected Profit&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">ymin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="mi">220</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">min_prof</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Minimum Profit&#39;</span><span class="p">),</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;profit$_q$ M USD&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Results&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Expected Profit:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;M USD&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Minimum Profit:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">min_prof</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;M USD&#39;</span><span class="p">)</span>
<span class="n">difference</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">)</span> <span class="o">-</span> <span class="n">min_prof</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Difference:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">difference</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;M USD&#39;</span><span class="p">)</span>

<span class="c1">#Collect results for conclusion</span>
<span class="n">final_EP</span><span class="p">[</span><span class="s1">&#39;CVaR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span>
<span class="n">final_min</span><span class="p">[</span><span class="s1">&#39;CVaR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_prof</span><span class="o">/</span><span class="mf">1e6</span>
<span class="n">final_diff</span><span class="p">[</span><span class="s1">&#39;CVaR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">difference</span><span class="o">/</span><span class="mf">1e6</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/f4ddbc252cd3f439be3c6f1bb658349a85b780a207e24459dfcf03ac5d33487e.png" src="../../_images/f4ddbc252cd3f439be3c6f1bb658349a85b780a207e24459dfcf03ac5d33487e.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Results
-------------------------------------
Expected Profit: 0.14 M USD
Minimum Profit: 0.14 M USD
Difference: 0.0 M USD
</pre></div>
</div>
</div>
</div>
</section>
<section id="id9">
<h4><span class="section-number">4.4.4.6.2. </span>Product Distribution<a class="headerlink" href="#id9" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Sugar&#39;</span><span class="p">,</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">avg_sug_prof</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Ethanol&#39;</span><span class="p">,</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">avg_eth_prof</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Electricity </span><span class="se">\n</span><span class="s1"> Free </span><span class="se">\n</span><span class="s1"> Market&#39;</span><span class="p">,</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">avg_el_prof</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Electricity </span><span class="se">\n</span><span class="s1"> Regulated </span><span class="se">\n</span><span class="s1"> Market&#39;</span><span class="p">,</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;reg&#39;</span><span class="p">])</span><span class="o">*</span><span class="mf">72.5</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Revenue from </span><span class="se">\n</span><span class="s1"> Each Profit (USD)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Product&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/0961e3faf06042ff393e75981b8a71e5c70b5eccbfb639386cd7dc5440590aed.png" src="../../_images/0961e3faf06042ff393e75981b8a71e5c70b5eccbfb639386cd7dc5440590aed.png" />
</div>
</div>
</section>
</section>
</section>
<section id="conclusion">
<h2><span class="section-number">4.4.5. </span>Conclusion<a class="headerlink" href="#conclusion" title="Link to this heading">#</a></h2>
<section id="final-results-comparison">
<h3><span class="section-number">4.4.5.1. </span>Final Results Comparison<a class="headerlink" href="#final-results-comparison" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">k</span><span class="o">=</span><span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">final_EP</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span> 
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">final_EP</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Expected Profit&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">final_min</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Minimum Profit&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">final_diff</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="n">final_min</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Potential Loss&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mf">0.2</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">final_diff</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">2</span><span class="p">),</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">final_EP</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">final_min</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">final_diff</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="n">final_min</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mf">0.2</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">final_diff</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">2</span><span class="p">),</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span>

<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Risk Measure&#39;</span> <span class="p">,</span><span class="n">fontsize</span>  <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Profit Measure (M USD)&#39;</span><span class="p">,</span> <span class="n">fontsize</span>  <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/07fa2bc8aa9910a602b7668af92d090ff8396d4130587d8545cbba4638ea5db1.png" src="../../_images/07fa2bc8aa9910a602b7668af92d090ff8396d4130587d8545cbba4638ea5db1.png" />
</div>
</div>
</section>
<section id="discussion-questions">
<h3><span class="section-number">4.4.5.2. </span>Discussion Questions<a class="headerlink" href="#discussion-questions" title="Link to this heading">#</a></h3>
</section>
</section>
<section id="references">
<h2><span class="section-number">4.4.6. </span>References<a class="headerlink" href="#references" title="Link to this heading">#</a></h2>
<div class="csl-entry"> [1] Gunjan, A., &#38; Bhattacharyya, S. (2022). A brief review of portfolio optimization techniques. <i>Artificial Intelligence Review</i>. https://doi.org/10.1007/s10462-022-10273-7</div>
<div class="csl-entry"> [2] Markowitz, H. (1959). Portfolio selection, efficient diversification of investments. Wiley, New York
<div class="csl-entry"> [3] Konno, H., &#38; Koshizuka, T. (2005). Mean-absolute deviation model. <i>IIE Transactions (Institute of Industrial Engineers)</i>, <i>37</i>(10), 893â900. https://doi.org/10.1080/07408170591007786</div>
<div class="csl-entry"> [4] Mutran, V. M., Ribeiro, C. O., Nascimento, C. A. O., &#38; Chachuat, B. (2020). Risk-conscious optimization model to support bioenergy investments in the Brazilian sugarcane industry. <i>Applied Energy</i>, <i>258</i>. https://doi.org/10.1016/j.apenergy.2019.113978</div>
<div class="csl-entry"> [5] Li, L., Lin, J., Wu, N., Xie, S., Meng, C., Zheng, Y., Wang, X., &#38; Zhao, Y. (2022). Review and outlook on the international renewable energy development. In <i>Energy and Built Environment</i> (Vol. 3, Issue 2, pp. 139â157). KeAi Communications Co. https://doi.org/10.1016/j.enbenv.2020.12.002</div>
<div class="csl-entry"> [6] Oliveira, S. M. de, Ribeiro, C. de O., &#38; Cicogna, M. P. V. (2018). Uncertainty effects on production mix and on hedging decisions: The case of Brazilian ethanol and sugar. <i>Energy Economics</i>, <i>70</i>, 516â524. https://doi.org/10.1016/j.eneco.2018.01.025</div></section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/4"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="AdvancedTopics.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">4.3. </span>Advanced Topics in Stochastic Programming</p>
      </div>
    </a>
    <a class="right-next"
       href="../5/data.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">5. </span>Data Science and Applied Statistics</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">4.4.1. Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#common-risk-measures-for-portfolio-optimization">4.4.2. Common Risk Measures for Portfolio Optimization</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mean-variance-mv-1-2">4.4.2.1. Mean-Variance (MV) [1,2]</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#literature-examples-using-mv">4.4.2.1.1. Literature Examples Using MV</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mean-absolute-deviation-mad-1-3">4.4.2.2. Mean-Absolute Deviation (MAD) [1,3]</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#graphical-representation-3">4.4.2.2.1. Graphical Representation [3]</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#literature-examples-using-mad">4.4.2.2.2. Literature Examples Using MAD</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#minimax-mm-1">4.4.2.3. Minimax (MM) [1]</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#literature-examples-using-mm">4.4.2.3.1. Literature Examples Using MM</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#value-at-risk-var-1-4">4.4.2.4. Value-at-Risk (VaR) [1,4]</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#literature-examples-using-var">4.4.2.4.1. Literature Examples Using VaR</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#conditional-value-at-risk-cvar-1-4">4.4.2.5. Conditional Value-at-Risk (CVaR) [1,4]</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#graphical-representation-4">4.4.2.5.1. Graphical Representation [4]</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#literature-examples-using-cvar">4.4.2.5.2. Literature Examples Using CVaR</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#motivating-example-product-portfolio-optimization-in-the-brazilian-sugarcane-industry">4.4.3. Motivating Example: Product Portfolio Optimization in the Brazilian Sugarcane Industry</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-definition">4.4.3.1. Problem Definition</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#process-flow-diagram">4.4.3.2. Process Flow Diagram</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#process-model">4.4.3.3. Process Model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#degree-of-freedom-dof-analysis">4.4.3.4. Degree of Freedom (DOF) Analysis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-input-data">4.4.3.5. Visualize Input Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-base-model-in-pyomo">4.4.3.6. Define Base Model in Pyomo</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#maximize-profit-only-no-risk-measure">4.4.3.7. Maximize Profit Only (No Risk Measure)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-results">4.4.3.8. Visualize Results</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#profit-distribution">4.4.3.8.1. Profit Distribution</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#product-distribution">4.4.3.8.2. Product Distribution</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#solve-model-with-risk-measures">4.4.4. Solve Model with Risk Measures</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#formulate-the-mv-objective">4.4.4.1. Formulate the MV Objective</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-the-covariance-matrix">4.4.4.1.1. Calculate the Covariance Matrix</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">4.4.4.2. Visualize Results</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">4.4.4.2.1. Profit Distribution</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">4.4.4.2.2. Product Distribution</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#formulate-the-mad-objective">4.4.4.3. Formulate the MAD Objective</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">4.4.4.4. Visualize Results</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">4.4.4.4.1. Profit Distribution</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">4.4.4.4.2. Product Distribution</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#formulate-the-cvar-objective">4.4.4.5. Formulate the CVaR Objective</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">4.4.4.6. Visualize Results</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">4.4.4.6.1. Profit Distribution</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">4.4.4.6.2. Product Distribution</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">4.4.5. Conclusion</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#final-results-comparison">4.4.5.1. Final Results Comparison</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#discussion-questions">4.4.5.2. Discussion Questions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">4.4.6. References</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Alexander Dowling, et al.
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      Â© Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>