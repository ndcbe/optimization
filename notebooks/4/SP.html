
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>4.1. Stochastic Programming &#8212; Optimization for Decision Science</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/4/SP';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="4.2. Blocks and Other Pyomo Best Practices" href="blocks.html" />
    <link rel="prev" title="4. Optimization Under Uncertainty" href="uncertainty.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/cbe_logo.jpg" class="logo__image only-light" alt="Optimization for Decision Science - Home"/>
    <script>document.write(`<img src="../../_static/cbe_logo.jpg" class="logo__image only-dark" alt="Optimization for Decision Science - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    Optimization for Decision Science
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Organization</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../org/intro.html">Welcome</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../org/syllabus.html">Syllabus</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../org/calendar.html">Fall 2024 Calendar</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../org/contribute.html">Contribution Instructions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../org/workshop.html">Computational Optimization in Python (São Paulo, Brazil)</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../org/assignments.html">Assignments</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../assignments/Pyomo1.html">Pyomo Homework 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../assignments/Pyomo2.html">Pyomo Homework 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../assignments/Pyomo3.html">Pyomo Homework 3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../org/project1.html">Project 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../assignments/Algorithms1.html">Algorithms Homework 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../assignments/Algorithms2.html">Algorithms Homework 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../org/project2.html">Project 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../assignments/Algorithms3.html">Algorithms Homework 3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../assignments/Algorithms4.html">Algorithms Homework 4</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../org/archive.html">Archive</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../assignments/Pyomo-Mini-Project.html">Pyomo Mini-Project: Receding Horizon Stochastic Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../org/semester_project.html">Semester Project (Spring 2023)</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Optimization Modeling in Pyomo</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../1/getting-started.html">1. Getting Started with Pyomo</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../1/Local-Install.html">1.1. Local Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../1/Optimization-Modeling.html">1.2. Optimization Modeling with Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../1/Pyomo-Introduction.html">1.3. Your First Optimization Problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../1/LP.html">1.4. Continuous Optimization: Linear Programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="../1/NLP.html">1.5. Continuous Optimization: Nonlinear Programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="../1/IP.html">1.6. Integer Programs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../1/Pyomo-Nuts-and-Bolts.html">1.7. 60 Minutes to Pyomo: An Energy Storage Model Predictive Control Example</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../2/logic.html">2. Logical Modeling</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../2/Logical_Modeling_GDP.html">2.1. Logical Modeling and Generalized Disjunctive Programs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../2/Modeling_Disjunctions_Strip_Packing.html">2.2. Modeling Disjunctions through the Strip Packing Problem</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../3/dynamics.html">3. Dynamic Optimization</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../3/PyomoDAE_car.html">3.1. Pyomo.DAE Example: Race Car</a></li>
<li class="toctree-l2"><a class="reference internal" href="../3/PyomoDAE_TCLab.html">3.2. Pyomo.DAE Example: Temperature Control Lab</a></li>
<li class="toctree-l2"><a class="reference internal" href="../3/DAE_background.html">3.3. Differential Algebraic Equations (DAEs)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../3/DAE_numeric_integration.html">3.4. Numeric Integration for DAEs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../3/PyomoDAE_theory.html">3.5. Dynamic Optimization with Collocation and Pyomo.DAE</a></li>
<li class="toctree-l2"><a class="reference internal" href="../3/PyomoDAE_example.html">3.6. Pyomo.DAE: Racing Example Revisited</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="uncertainty.html">4. Optimization Under Uncertainty</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2 current active"><a class="current reference internal" href="#">4.1. Stochastic Programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="blocks.html">4.2. Blocks and Other Pyomo Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="AdvancedTopics.html">4.3. Advanced Topics in Stochastic Programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="RiskMeasures.html">4.4. Risk Measures and Portfolio Optimization</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../5/data.html">5. Data Science and Applied Statistics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../5/Parmest-tutorial.html">5.1. Parameter estimation with <code class="docutils literal notranslate"><span class="pre">parmest</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../5/Parmest-generate-data.html">5.2. Supplementary material: data for parmest tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../5/Pyomo_DoE_Tutorial.html">5.3. Optimizing Experiments with <code class="docutils literal notranslate"><span class="pre">Pyomo.DoE</span></code></a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Algorithms and Theory</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../6/unconstrained.html">6. Unconstrained Nonlinear Optimization</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../6/Math-Primer-1.html">6.1. Linear Algebra Review and SciPy Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../6/Math-Primer-2.html">6.2. Mathematics Primer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../6/Optimality.html">6.3. Unconstrained Optimality Conditions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../6/Newton-Methods.html">6.4. Newton-type Methods for Unconstrained Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../6/Quasi-Newton-Methods.html">6.5. Quasi-Newton Methods for Unconstrained Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../6/Globalization.html">6.6. Descent and Globalization</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../7/constrained.html">7. Constrained Nonlinear Optimization</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../7/Convexity.html">7.1. Convexity Revisited</a></li>
<li class="toctree-l2"><a class="reference internal" href="../7/Local-Optimality.html">7.2. Local Optimality Conditions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../7/KKT-Multipliers.html">7.3. Analysis of KKT Conditions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../7/Constraint-Qualifications.html">7.4. Constraint Qualifications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../7/Second-Order.html">7.5. Second Order Optimality Conditions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../7/degeneracy_hunter.html">7.6. NLP Diagnostics with Degeneracy Hunter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../7/Interior-Point1.html">7.7. Simple Netwon Method for Equality Constrained NLPs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../7/Interior-Point2.html">7.8. Inertia-Corrected Netwon Method for Equality Constrained NLPs</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../8/special-topics.html">8. Special Topics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../8/MILP.html">8.1. Integer Programming with Simple Branch and Bound</a></li>
<li class="toctree-l2"><a class="reference internal" href="../8/MINLP-Algorithms.html">8.2. MINLP Algorithms</a></li>
<li class="toctree-l2"><a class="reference internal" href="../8/Global-Opt.html">8.3. Deterministic Global Optimization</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Student Contributions</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../contrib/pyomo.html">More Pyomo Examples</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../contrib/semiconductor_manufacturing.html">Semiconductor Production Planning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib/student_diet.html">Optimization of Daily Diet Using Pyomo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib/blending.html">Blending Under Uncertainty</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib/vehicle_routing.html">Vehicle Routing</a></li>

<li class="toctree-l2"><a class="reference internal" href="../contrib/portfolio_optimization_extended.html">Risk Measures and Portfolio Optimization: Expanded</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib/race_car_extended.html">Extended Race Car Optimization Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib/hot_air_balloon.html">Hot Air Balloon Dynamic Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib/reactor_design.html">Chemical Reactor Design</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib/Disaster_Response_Plan.html">Disaster Response Plan Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib/Sudoku_Solver.html">Sudoku Solver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib/more_circle_packing.html">Circle Packing Optimization</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../contrib/modeling.html">Modeling Paradigms</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../contrib/multi_objective.html">Multi-Objective Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib/advanced_stochastic_programming.html">Advanced Topics in Stochastic Programming</a></li>






</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../contrib/algorithms.html">Global Optimization</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../contrib/Deterministic_Global_Optimization.html">Deterministic Global Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib/Bayesian_Optimization1.html">Bayesian Optimization Tutorial 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib/Bayesian_Optimization2.html">Bayesian Optimization Tutorial 2</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../contrib/sgd.html">Stochastic Gradient Descent</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../contrib/Stochastic-Gradient-Descent-1.html">Stochastic Gradient Descent Tutorial 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib/Stochastic-Gradient-Descent-2.html">Stochastic Gradient Descent Tutorial 2</a></li>






<li class="toctree-l2"><a class="reference internal" href="../contrib/Stochastic-Gradient-Descent-3.html">Stochastic Gradient Descent Tutorial 3</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../contrib/data.html">Machine Learning and Applied Statistics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../contrib/EM-MAP.html">Expectation Maximization Algorithm and MAP Estimation</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/ndcbe/optimization/blob/master/notebooks/4/SP.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/ndcbe/optimization" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/ndcbe/optimization/issues/new?title=Issue%20on%20page%20%2Fnotebooks/4/SP.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/notebooks/4/SP.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Stochastic Programming</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#farmers-example">4.1.1. Farmers Example</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-formulation-in-words">4.1.1.1. Problem Formulation In Words</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#perfect-information">4.1.1.2. Perfect information</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">4.1.1.3. Stochastic Programming</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#key-concepts">4.1.2. Key Concepts</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#probability-review">4.1.2.1. Probability Review</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#infinite-dimensional-formulation">4.1.2.2. Infinite Dimensional Formulation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#discrete-finite-dimensional-approximations">4.1.2.3. Discrete (Finite Dimensional) Approximations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#general-two-stage-stochastic-programming-formulation">4.1.2.4. General Two-Stage Stochastic Programming Formulation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#include-uncertainty-in-the-farmer-s-problem-two-stage-stochastic-program">4.1.2.5. Include uncertainty in the Farmer’s Problem (two-stage stochastic program)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-perfect-information-and-the-stochastic-solutions">4.1.2.6. Comparing Perfect Information and the Stochastic Solutions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#expected-value-of-perfect-information-evpi">4.1.2.7. Expected Value of Perfect Information (EVPI)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#expected-value-solution-ev">4.1.2.8. Expected Value Solution (EV)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#value-of-stochastic-solution-vss">4.1.2.9. Value of Stochastic Solution (VSS)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reference">4.1.2.10. Reference</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="stochastic-programming">
<h1><span class="section-number">4.1. </span>Stochastic Programming<a class="headerlink" href="#stochastic-programming" title="Link to this heading">#</a></h1>
<p>This notebook was prepared by <a class="reference external" href="https://github.com/jialuw96">Jialu Wang</a> and revised by <a class="reference external" href="https://github.com/MadelynnWatson">Maddie Watson</a> at the University of Notre Dame.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Imports</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="k">if</span> <span class="s2">&quot;google.colab&quot;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
    <span class="o">!</span>wget<span class="w"> </span><span class="s2">&quot;https://raw.githubusercontent.com/ndcbe/optimization/main/notebooks/helper.py&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">helper</span>
    <span class="n">helper</span><span class="o">.</span><span class="n">easy_install</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;../&#39;</span><span class="p">)</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">helper</span>
<span class="n">helper</span><span class="o">.</span><span class="n">set_plotting_style</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="farmers-example">
<h2><span class="section-number">4.1.1. </span>Farmers Example<a class="headerlink" href="#farmers-example" title="Link to this heading">#</a></h2>
<p>Here is the <a class="reference download internal" download="" href="../../_downloads/a2a0e3646fceec8de529a0b6b24d426b/Farmers.pdf"><span class="xref download myst">handout for lecture</span></a></p>
<p>Consider a European farmer who specializes in raising wheat, corn, and sugar beets on his 500 acres of land. During the winter, he wants to decide how much land to devote to each crop. (We refer to the farmer as “he” for convenience and not to imply anything about the gender of European farmers)</p>
<p>The farmer knows that at least 200 tons (T) of wheat and 240 T of corn are needed for cattle feed. These amounts can be raised on the farm or bought from a wholesaler. Any production in excess of the feeding requirement would be sold. Over the last decade, mean selling prices have been $170 and $150 per ton of wheat and corn, respectively. The purchase prices are 40% more than this due to the wholesaler’s margin and transportation costs.</p>
<p>Another profitable crop is sugar beet, which he expects to sell at $36/T; however, the European Commission imposes a quota on sugar beet production. Any amount in excess of the quota can be sold only at $10/T. The farmer’s quota for next year is 6000 T.</p>
<p>Based on past experience, the farmer knows that the mean yield on his land is roughly 2.5 T, 3 T, and 20 T per acre for wheat, corn, and sugar beets, respectively. Table <span class="math notranslate nohighlight">\(1\)</span> summarizes these data and the planting costs for these crops.</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p></p></th>
<th class="head"><p>Wheat</p></th>
<th class="head"><p>Corn</p></th>
<th class="head"><p>Sugar Beets</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Yield (T/acre)</strong></p></td>
<td><p>2.5</p></td>
<td><p>3</p></td>
<td><p>20</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Planting cost ($/acre)</strong></p></td>
<td><p>150</p></td>
<td><p>230</p></td>
<td><p>260</p></td>
</tr>
<tr class="row-even"><td><p><strong>Selling price ($/T)</strong></p></td>
<td><p>170</p></td>
<td><p>150</p></td>
<td><p>36 under 6000 T, 10 above 6000 T</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Purchase price ($/T)</strong></p></td>
<td><p>238</p></td>
<td><p>210</p></td>
<td><p>–</p></td>
</tr>
<tr class="row-even"><td><p><strong>Minimum requirement (T)</strong></p></td>
<td><p>200</p></td>
<td><p>240</p></td>
<td><p>–</p></td>
</tr>
</tbody>
</table>
</div>
<p><strong>Total available land</strong>: 500 acres</p>
<p>To help the farmer make up his mind, we can set up the following model. Let</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(x_1\)</span> = acres of land devoted to wheat,</p></li>
<li><p><span class="math notranslate nohighlight">\(x_2\)</span> = acres of land devoted to corn,</p></li>
<li><p><span class="math notranslate nohighlight">\(x_3\)</span> = acres of land devoted to sugar beets,</p></li>
<li><p><span class="math notranslate nohighlight">\(w_1\)</span> = tons of wheat sold,</p></li>
<li><p><span class="math notranslate nohighlight">\(y_1\)</span> = tons of wheat purchased,</p></li>
<li><p><span class="math notranslate nohighlight">\(w_2\)</span> = tons of corn sold,</p></li>
<li><p><span class="math notranslate nohighlight">\(y_2\)</span> = tons of corn purchased,</p></li>
<li><p><span class="math notranslate nohighlight">\(w_3\)</span> = tons of sugar beets sold at the favorable price,</p></li>
<li><p><span class="math notranslate nohighlight">\(w_4\)</span> = tons of sugar beets sold at the unfavorable price.</p></li>
</ul>
<div class="figure" style="text-align: center"><p><img  src="../../_images/tikz-c0c750a3bccdcdb72b6e653c453b1db0fe7faf8b.png" alt="Figure made with TikZ" /></p>
</div><section id="problem-formulation-in-words">
<h3><span class="section-number">4.1.1.1. </span>Problem Formulation In Words<a class="headerlink" href="#problem-formulation-in-words" title="Link to this heading">#</a></h3>
<p>Minimize total cost, subject to the following constraints:</p>
<ul class="simple">
<li><p>Plant up to 500 acres.</p></li>
<li><p>Need at least 200 tons of wheat (for animals).</p></li>
<li><p>Need at least 240 tons of corn (for animals).</p></li>
<li><p>Sugar beet sales must be less than or equal to the yield from the farm.</p></li>
<li><p>All variables are positive.</p></li>
<li><p>Up to 6000 tons of sugar beets can be sold at a favorable price.</p></li>
</ul>
</section>
<section id="perfect-information">
<h3><span class="section-number">4.1.1.2. </span>Perfect information<a class="headerlink" href="#perfect-information" title="Link to this heading">#</a></h3>
<p>With the ‘perfect’ information shown in the table above, the optimization problem is formed as:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
\min \quad &amp; \underbrace{150x_1 + 230x_2 + 260x_3}_{\text{planting costs}} \underbrace{+ 238y_1 - 170w_1}_{\text{wheat purchases less sales}} \\
       	&amp; \underbrace{+ 210y_2 - 150w_2}_\text{corn purchases less sales} ~
		\underbrace{- 36w_3 - 10w_4}_{\text{sugar beet sales}} \\
\text{s.t.} \quad &amp; x_1 + x_2 + x_3 \leq 500, \quad \text{(plant up to 500 acres)} \\
       	&amp; 2.5x_1 + y_1 - w_1 \geq 200, \quad \text{(satisfy wheat demand)}\\
       	&amp; 3x_2 + y_2 - w_2 \geq 240, \quad \text{(satisfy corn demand)}\\
       	&amp; w_3 + w_4 \leq 20x_3, \quad \text{(beet sales cannot exceed production)}\\
       	&amp; w_3 \leq 6000, \quad \text{(cap beet sales at favorable price)}\\
       	&amp; x_1, x_2, x_3, y_1, y_2, w_1, w_2, w_3, w_4 \geq 0.
\end{align*}
\end{split}\]</div>
<p>Create a function to build a pyomo model for the farmer’s problem with crop yeilds as an input</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pyomo.environ</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span><span class="n">ConcreteModel</span><span class="p">,</span> <span class="n">Var</span><span class="p">,</span> <span class="n">NonNegativeReals</span><span class="p">,</span> <span class="n">Objective</span><span class="p">,</span> <span class="n">minimize</span><span class="p">,</span> <span class="n">ConstraintList</span><span class="p">,</span> 
                           <span class="n">summation</span><span class="p">,</span> <span class="n">SolverFactory</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<span class="c1">### Create a function to build a pyomo model for the farmer&#39;s problem with crop yeilds as an input</span>

<span class="k">def</span><span class="w"> </span><span class="nf">build_model</span><span class="p">(</span><span class="n">yields</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Code adapted from https://mpi-sppy.readthedocs.io/en/latest/examples.html#examples</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        yields: Yield information as a list, following the rank [wheat, corn, beets]</span>
<span class="sd">        </span>
<span class="sd">    Return: </span>
<span class="sd">        model: farmer problem model </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">ConcreteModel</span><span class="p">()</span>
    
    <span class="c1"># Define sets</span>
    <span class="n">all_crops</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">,</span> <span class="s2">&quot;CORN&quot;</span><span class="p">,</span> <span class="s2">&quot;BEETS&quot;</span><span class="p">]</span>
    <span class="n">purchase_crops</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">,</span> <span class="s2">&quot;CORN&quot;</span><span class="p">]</span>
    <span class="n">sell_crops</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">,</span> <span class="s2">&quot;CORN&quot;</span><span class="p">,</span> <span class="s2">&quot;BEETS_FAVORABLE&quot;</span><span class="p">,</span> <span class="s2">&quot;BEETS_UNFAVORABLE&quot;</span><span class="p">]</span>
    
    <span class="c1"># Crops field allocation</span>
    <span class="n">model</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">all_crops</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">NonNegativeReals</span><span class="p">)</span>
    <span class="c1"># How many tons of crops to purchase</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">purchase_crops</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">NonNegativeReals</span><span class="p">)</span>
    <span class="c1"># How many tons of crops to sell</span>
    <span class="n">model</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">sell_crops</span><span class="p">,</span><span class="n">within</span><span class="o">=</span><span class="n">NonNegativeReals</span><span class="p">)</span>

    <span class="c1"># Objective function</span>
    <span class="n">model</span><span class="o">.</span><span class="n">PLANTING_COST</span> <span class="o">=</span> <span class="mi">150</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">230</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">260</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;BEETS&quot;</span><span class="p">]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">PURCHASE_COST</span> <span class="o">=</span> <span class="mi">238</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">210</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">SALES_REVENUE</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mi">170</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">150</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">]</span>
        <span class="o">+</span> <span class="mi">36</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;BEETS_FAVORABLE&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;BEETS_UNFAVORABLE&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="c1"># Maximize the Obj is to minimize the negative of the Obj</span>
    <span class="n">model</span><span class="o">.</span><span class="n">OBJ</span> <span class="o">=</span> <span class="n">Objective</span><span class="p">(</span>
        <span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">PLANTING_COST</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">PURCHASE_COST</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">SALES_REVENUE</span><span class="p">,</span>
        <span class="n">sense</span><span class="o">=</span><span class="n">minimize</span>
    <span class="p">)</span>

    <span class="c1"># Constraints</span>
    <span class="n">model</span><span class="o">.</span><span class="n">CONSTR</span><span class="o">=</span> <span class="n">ConstraintList</span><span class="p">()</span>

    <span class="n">model</span><span class="o">.</span><span class="n">CONSTR</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">summation</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">500</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">CONSTR</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">yields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">200</span>
    <span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">CONSTR</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">yields</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">240</span>
    <span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">CONSTR</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">yields</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;BEETS&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;BEETS_FAVORABLE&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;BEETS_UNFAVORABLE&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span>
    <span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;BEETS_FAVORABLE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setub</span><span class="p">(</span><span class="mi">6000</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Solve the Optimimization Problem with Perfect yields </span>
<span class="n">yields_perfect</span> <span class="o">=</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="n">yields_perfect</span><span class="p">)</span>
<span class="n">solver</span> <span class="o">=</span> <span class="n">SolverFactory</span><span class="p">(</span><span class="s2">&quot;ipopt&quot;</span><span class="p">)</span>
<span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

<span class="c1">#Define a function for printing the optimal solution</span>

<span class="k">def</span><span class="w"> </span><span class="nf">print_opt_sol</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Arguments:</span>
<span class="sd">        model: solved farmer problem model</span>
<span class="sd">        </span>
<span class="sd">    Return: </span>
<span class="sd">        Prints the optimal solution</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;===Optimal solutions based on perfect information===&quot;</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Culture.         | &#39;</span><span class="p">,</span> <span class="s1">&#39;Wheat |&#39;</span><span class="p">,</span> <span class="s1">&#39;Corn  |&#39;</span><span class="p">,</span> <span class="s1">&#39;Sugar Beets |&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Surface (acres)  | &#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">])</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">,</span> 
          <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">])</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; |&#39;</span><span class="p">,</span>
          <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;BEETS&quot;</span><span class="p">])</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39; |&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Yield (T)        | &#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">])</span><span class="o">*</span><span class="n">yields_perfect</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">,</span> 
          <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">])</span><span class="o">*</span><span class="n">yields_perfect</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">,</span>
          <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;BEETS&quot;</span><span class="p">])</span><span class="o">*</span><span class="n">yields_perfect</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sales (T)        | &#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">])</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">,</span> 
          <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">])</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;  |&#39;</span><span class="p">,</span>
          <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;BEETS_FAVORABLE&quot;</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;BEETS_UNFAVORABLE&quot;</span><span class="p">])</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Purchases (T)    | &#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">])</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;  |&#39;</span><span class="p">,</span> 
          <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">])</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;  |&#39;</span><span class="p">,</span>
          <span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;     |&#39;</span><span class="p">)</span>
    
    <span class="n">profit</span> <span class="o">=</span> <span class="o">-</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">OBJ</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Overall profit: $&#39;</span><span class="p">,</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">profit</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">profit</span>

<span class="n">profit_perfect</span> <span class="o">=</span> <span class="n">print_opt_sol</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
      
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>===Optimal solutions based on perfect information===
Culture.         |  Wheat | Corn  | Sugar Beets |
Surface (acres)  |  120.0 | 80.0  | 300.0  |
Yield (T)        |  300.0 | 240.0 | 6000.0 |
Sales (T)        |  100.0 | 0.0   | 6000.0 |
Purchases (T)    |  0.0   | 0.0   | -      |
Overall profit: $ 118600.0
</pre></div>
</div>
</div>
</div>
<p>The optimal solution based on perfect information is:</p>
<p><img alt="ex1.2" src="https://raw.githubusercontent.com/ndcbe/optimization/main/media/farmer2-1.png" /></p>
<p>This solution is easy to understand:</p>
<ul class="simple">
<li><p>The farmer devotes enough land to sugar beets to reach the quota of 6000 T</p></li>
<li><p>Devote enough land to wheat and corn production to meet the feeding requirement</p></li>
<li><p>Plant wheat in the rest of the land</p></li>
</ul>
<p>However, there are often some ‘real world’ constraints that break the perfect information heuristic:</p>
<ul class="simple">
<li><p>Market prices change</p></li>
<li><p>Yield is uncertain</p></li>
<li><p>Planting cost materials, water, labor…</p></li>
<li><p>Crop rotation</p></li>
</ul>
<p>A representation of the uncertainty would be to assume that years are good, fair, or bad for all crops, resulting in above average, average, or below average yields for all crops. Three scenarios are defined as:</p>
<ul class="simple">
<li><p>Above average yield (+20%)</p></li>
<li><p>Average yield (base case)</p></li>
<li><p>Below average yield (-20%)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### Run Above average case</span>
<span class="n">yields_above</span> <span class="o">=</span> <span class="p">[</span><span class="mf">2.5</span><span class="o">*</span><span class="mf">1.2</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="mf">1.2</span><span class="p">,</span> <span class="mi">20</span><span class="o">*</span><span class="mf">1.2</span><span class="p">]</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="n">yields_above</span><span class="p">)</span>
<span class="n">solver</span> <span class="o">=</span> <span class="n">SolverFactory</span><span class="p">(</span><span class="s2">&quot;ipopt&quot;</span><span class="p">)</span>
<span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

<span class="n">profit_above</span> <span class="o">=</span> <span class="n">print_opt_sol</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>===Optimal solutions based on perfect information===
Culture.         |  Wheat | Corn  | Sugar Beets |
Surface (acres)  |  183.3 | 66.7  | 250.0  |
Yield (T)        |  458.3 | 200.0 | 5000.0 |
Sales (T)        |  350.0 | 0.0   | 6000.0 |
Purchases (T)    |  0.0   | 0.0   | -      |
Overall profit: $ 167666.7
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### Run Below average case</span>
<span class="n">yields_below</span> <span class="o">=</span> <span class="p">[</span><span class="mf">2.5</span><span class="o">*</span><span class="mf">0.8</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="mf">0.8</span><span class="p">,</span> <span class="mi">20</span><span class="o">*</span><span class="mf">0.8</span><span class="p">]</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="n">yields_below</span><span class="p">)</span>
<span class="n">solver</span> <span class="o">=</span> <span class="n">SolverFactory</span><span class="p">(</span><span class="s2">&quot;ipopt&quot;</span><span class="p">)</span>
<span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

<span class="n">profit_below</span> <span class="o">=</span> <span class="n">print_opt_sol</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>===Optimal solutions based on perfect information===
Culture.         |  Wheat | Corn  | Sugar Beets |
Surface (acres)  |  100.0 | 25.0  | 375.0  |
Yield (T)        |  250.0 | 75.0 | 7500.0 |
Sales (T)        |  0.0 | 0.0   | 6000.0 |
Purchases (T)    |  0.0   | 180.0   | -      |
Overall profit: $ 59950.0
</pre></div>
</div>
</div>
</div>
<p>Running the optimization problem based on above average and below average yields gives optimal solutions:</p>
<p><img alt="ex1.2" src="https://raw.githubusercontent.com/ndcbe/optimization/main/media/farmer2-2.png" /></p>
<p>The solutions again seem natural. When yields are high, smaller surfaces are needed to raise the minimum requirements in wheat and corn and the sugar beet quota. The remaining land is devoted to wheat, whose extra production is sold. When yields are low, larger surfaces are needed to raise the minimum requirements and the sugar beet quota.</p>
<p>Unfortunately, weather conditions cannot be accurately predicted six months ahead. The farmer must make up his mind without perfect information on yields!</p>
</section>
<section id="id1">
<h3><span class="section-number">4.1.1.3. </span>Stochastic Programming<a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<p>Stochastic programming optimizes when some parameters are uncertain (i.e., crop yeilds), but defined with a probability distribution. It is opposed to deterministic programming where all parameters are known.</p>
<p><span class="math notranslate nohighlight">\(\Xi\)</span>: random variable, results of an ‘experiment’</p>
<p><span class="math notranslate nohighlight">\(\xi\)</span>: a realization, i.e., outcome of a simple experiment</p>
<p>Each realization has an associated probability <span class="math notranslate nohighlight">\(p(\xi)\)</span>. <span class="math notranslate nohighlight">\(\Theta\)</span> is the set of all possible realizations, <span class="math notranslate nohighlight">\(\xi \in \Theta\)</span>.</p>
<p>Let <span class="math notranslate nohighlight">\(x\)</span> be stage 1 decision variables (make now, i.e., land allocation), <span class="math notranslate nohighlight">\(y\)</span> be stage 2 decision variables (wait-and-see, i.e., buy/sell crops), a deterministic optimization problem is formed as:</p>
<p><span class="math notranslate nohighlight">\(\min f(x,y,\theta)\)</span></p>
<p><span class="math notranslate nohighlight">\(\ \ \ \ \ \  g(x,y,\theta) \leq 0\)</span></p>
<p><span class="math notranslate nohighlight">\(\ \ \ \ \ \  u(x,y,\theta) = 0\)</span></p>
<p>When the parameters <span class="math notranslate nohighlight">\(\theta\)</span> are uncertain, the corresponding stochastic optimization problem is formed as:</p>
<p><span class="math notranslate nohighlight">\(\min E[f(x,y,\Xi)]\)</span></p>
<p><span class="math notranslate nohighlight">\(\ \ \ \ \ \  g(x,y,\Xi) \leq 0\)</span></p>
<p><span class="math notranslate nohighlight">\(\ \ \ \ \ \  u(x,y,\Xi) = 0\)</span></p>
</section>
</section>
<section id="key-concepts">
<h2><span class="section-number">4.1.2. </span>Key Concepts<a class="headerlink" href="#key-concepts" title="Link to this heading">#</a></h2>
<section id="probability-review">
<h3><span class="section-number">4.1.2.1. </span>Probability Review<a class="headerlink" href="#probability-review" title="Link to this heading">#</a></h3>
<p>Example: roll a 6-sided die.</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\( \xi \)</span> is the realization (outcome) of the experiment (e.g., roll the die once).</p></li>
<li><p><span class="math notranslate nohighlight">\( p(\xi) \)</span> represents the probability for each realization.</p></li>
<li><p><span class="math notranslate nohighlight">\(\Theta\)</span> represents the set of all possible realizations/outcomes (e.g., <span class="math notranslate nohighlight">\(\Theta\)</span> = {1,2,3,4,5,6}, numbers on a die).</p></li>
<li><p>The probability density <span class="math notranslate nohighlight">\( p(\xi) \)</span> encodes the probability for all realizations <span class="math notranslate nohighlight">\(\xi \in \Theta\)</span></p></li>
</ul>
<p>Key properties:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\( 0 \leq p(\xi) \leq 1 \quad \forall \quad \xi \in \Theta \)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(\int_{\xi \in \Theta} p(\xi)d\xi = 1\)</span> for continous probabilities</p></li>
<li><p><span class="math notranslate nohighlight">\(\sum_{\xi \in \Theta} p(\xi) = 1\)</span> for discrete probabilities.</p></li>
</ul>
<p>Example: rolling a 6-sided die.</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\( P(\xi) = 1/6 \)</span> for each side of the die.</p></li>
</ul>
</section>
<section id="infinite-dimensional-formulation">
<h3><span class="section-number">4.1.2.2. </span>Infinite Dimensional Formulation<a class="headerlink" href="#infinite-dimensional-formulation" title="Link to this heading">#</a></h3>
<p>Continuous random variables have the key property:</p>
<p><span class="math notranslate nohighlight">\(0 \leq p(\xi) \leq 1\)</span> for all <span class="math notranslate nohighlight">\(\xi \in \Theta\)</span></p>
<p><span class="math notranslate nohighlight">\(\int p(\xi) d\xi = 1\)</span></p>
<p>The expectation is formed as:</p>
<p><span class="math notranslate nohighlight">\(E_{\Xi} = \int_{\Xi} f(\xi) P_{\Xi}(\xi) d\xi\)</span></p>
</section>
<section id="discrete-finite-dimensional-approximations">
<h3><span class="section-number">4.1.2.3. </span>Discrete (Finite Dimensional) Approximations<a class="headerlink" href="#discrete-finite-dimensional-approximations" title="Link to this heading">#</a></h3>
<p>Discrete random variables have the key property:</p>
<p><span class="math notranslate nohighlight">\(0 \leq p(\xi) \leq 1\)</span> for all <span class="math notranslate nohighlight">\(\xi \in \Theta\)</span></p>
<p><span class="math notranslate nohighlight">\(\sum p(\xi) = 1\)</span></p>
<p>The expectation is formed as:</p>
<p><span class="math notranslate nohighlight">\(E_{\Xi} = \sum_{\Xi} f(\xi) w(\xi)\)</span></p>
</section>
<section id="general-two-stage-stochastic-programming-formulation">
<h3><span class="section-number">4.1.2.4. </span>General Two-Stage Stochastic Programming Formulation<a class="headerlink" href="#general-two-stage-stochastic-programming-formulation" title="Link to this heading">#</a></h3>
<p><span class="math notranslate nohighlight">\( \min \sum_{\xi} w(\xi) f(x, y_\xi, \xi) \)</span></p>
<p>Subject to:
<span class="math notranslate nohighlight">\( g(x, y_\xi, \xi) \leq 0, \quad h(x, y_\xi, \xi) = 0 \)</span></p>
<p>Key features:</p>
<ul class="simple">
<li><p>Replace expectation with summation.</p></li>
<li><p>Constraints enforced only for <span class="math notranslate nohighlight">\( \xi \)</span> realizations.</p></li>
<li><p><span class="math notranslate nohighlight">\( y \)</span> reacts to uncertainty in <span class="math notranslate nohighlight">\( \xi \)</span>.</p></li>
</ul>
</section>
<section id="include-uncertainty-in-the-farmer-s-problem-two-stage-stochastic-program">
<h3><span class="section-number">4.1.2.5. </span>Include uncertainty in the Farmer’s Problem (two-stage stochastic program)<a class="headerlink" href="#include-uncertainty-in-the-farmer-s-problem-two-stage-stochastic-program" title="Link to this heading">#</a></h3>
<p>Now the farmer wants to assess the benefits and losses of each decision in each situation.</p>
<p>Decisions on land assignment (<span class="math notranslate nohighlight">\(x_1\)</span>, <span class="math notranslate nohighlight">\(x_2\)</span>, <span class="math notranslate nohighlight">\(x_3\)</span>) have to be taken now, but sales and purchases (<span class="math notranslate nohighlight">\(w_i, i=1,...,4\)</span>, <span class="math notranslate nohighlight">\(y_j, j=1,2\)</span>) depend on the yields. This forms the two-stage stochastic program:</p>
<ol class="arabic simple">
<li><p>Stage 1 decisions: land assignments (<span class="math notranslate nohighlight">\(x_1\)</span>, <span class="math notranslate nohighlight">\(x_2\)</span>, <span class="math notranslate nohighlight">\(x_3\)</span>)</p></li>
<li><p>Uncertainty is realized</p></li>
<li><p>Stage 2 decisions: wait-and-see (sales and purchases)</p></li>
</ol>
<p>It is useful to index those decisions by a scenario index <span class="math notranslate nohighlight">\(s=1,2,3\)</span> according to above average, average or below average yields, respectively. This creates a new set of variables <span class="math notranslate nohighlight">\(w_{i,s}, i=1,2,3,4, s=1,2,3\)</span> and <span class="math notranslate nohighlight">\(y_{j,s}, j=1,2, s=1,2,3.\)</span> For e.g., <span class="math notranslate nohighlight">\(w_{3,2}\)</span> represents the amount of sugar beets sold at the favorable price if yields are average.</p>
<p>If the three scenarios have an equal probability of 1/3, the farmer’s problem is formed as:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
\min \quad &amp; 150x_1 + 230x_2 + 260x_3\\
        &amp; -\frac{1}{3}(170w_{1,1} - 238y_{1,1} + 150w_{2,1} - 210y_{2,1} + 36w_{3,1} + 10w_{4,1} \\
       	&amp; -\frac{1}{3}(170w_{1,2} - 238y_{1,2} + 150w_{2,2} - 210y_{2,2} + 36w_{3,2} + 10w_{4,2} \\
        &amp; -\frac{1}{3}(170w_{1,3} - 238y_{1,3} + 150w_{2,3} - 210y_{2,3} + 36w_{3,3} + 10w_{4,3} \\
\text{s.t.} \quad &amp; \text{scenarion 1:} \\
&amp; x_1 + x_2 + x_3 \leq 500, \\
        &amp; 3x_1 + y_{1,1} - w_{1,1} \geq 200, \\
        &amp; 3.6x_2 + y_{2,1} - w_{2,1} \geq 240, \\
        &amp; w_{3,1} + w_{4,1} \leq 24x_3, \\
        &amp; w_{3,1} \leq 6000, \\
        &amp; \text{scenarion 2:} \\
        &amp; 2.5x_1 + y_{1,2} - w_{1,2} \geq 200, \\
        &amp; 3x_2 + y_{2,2} - w_{2,2} \geq 240, \\
        &amp; w_{3,2} + w_{4,2} \leq 20x_3, \\
        &amp; w_{3,2} \leq 6000, \\
        &amp; \text{scenarion 3:} \\
        &amp; 2x_1 + y_{1,3} - w_{1,3} \geq 200, \\
        &amp; 2.4x_2 + y_{2,3} - w_{2,3} \geq 240, \\
        &amp; w_{3,3} + w_{4,3} \leq 16x_3, \\
        &amp; w_{3,3} \leq 6000, \\
       	&amp; x, y, w \geq 0.
\end{align*}
\end{split}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">build_sp_model</span><span class="p">(</span><span class="n">yields</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Code adapted from https://mpi-sppy.readthedocs.io/en/latest/examples.html#examples</span>
<span class="sd">    It specifies the extensive form of the two-stage stochastic programming</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        yields: Yield information as a list, following the rank [wheat, corn, beets]</span>
<span class="sd">        </span>
<span class="sd">    Return: </span>
<span class="sd">        model: farmer problem model </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">ConcreteModel</span><span class="p">()</span>
    
    <span class="n">all_crops</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">,</span> <span class="s2">&quot;CORN&quot;</span><span class="p">,</span> <span class="s2">&quot;BEETS&quot;</span><span class="p">]</span>
    <span class="n">purchase_crops</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">,</span> <span class="s2">&quot;CORN&quot;</span><span class="p">]</span>
    <span class="n">sell_crops</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">,</span> <span class="s2">&quot;CORN&quot;</span><span class="p">,</span> <span class="s2">&quot;BEETS_FAVORABLE&quot;</span><span class="p">,</span> <span class="s2">&quot;BEETS_UNFAVORABLE&quot;</span><span class="p">]</span>
    <span class="n">scenarios</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ABOVE&quot;</span><span class="p">,</span><span class="s2">&quot;AVERAGE&quot;</span><span class="p">,</span><span class="s2">&quot;BELOW&quot;</span><span class="p">]</span>
    
    <span class="c1"># Fields allocation</span>
    <span class="n">model</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">all_crops</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">NonNegativeReals</span><span class="p">)</span>
    <span class="c1"># How many tons of crops to purchase in each scenario</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">purchase_crops</span><span class="p">,</span> <span class="n">scenarios</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">NonNegativeReals</span><span class="p">)</span>
    <span class="c1"># How many tons of crops to sell in each scenario</span>
    <span class="n">model</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">sell_crops</span><span class="p">,</span> <span class="n">scenarios</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">NonNegativeReals</span><span class="p">)</span>

    <span class="c1"># Objective function</span>
    <span class="n">model</span><span class="o">.</span><span class="n">PLANTING_COST</span> <span class="o">=</span> <span class="mi">150</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">230</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">260</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;BEETS&quot;</span><span class="p">]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">PURCHASE_COST_ABOVE</span> <span class="o">=</span> <span class="mi">238</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">,</span> <span class="s2">&quot;ABOVE&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">210</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">,</span><span class="s2">&quot;ABOVE&quot;</span><span class="p">]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">SALES_REVENUE_ABOVE</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mi">170</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">,</span> <span class="s2">&quot;ABOVE&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">150</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">,</span><span class="s2">&quot;ABOVE&quot;</span><span class="p">]</span>
        <span class="o">+</span> <span class="mi">36</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;BEETS_FAVORABLE&quot;</span><span class="p">,</span><span class="s2">&quot;ABOVE&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;BEETS_UNFAVORABLE&quot;</span><span class="p">,</span><span class="s2">&quot;ABOVE&quot;</span><span class="p">])</span>
    
    <span class="n">model</span><span class="o">.</span><span class="n">PURCHASE_COST_AVE</span> <span class="o">=</span> <span class="mi">238</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">,</span> <span class="s2">&quot;AVERAGE&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">210</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">,</span><span class="s2">&quot;AVERAGE&quot;</span><span class="p">]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">SALES_REVENUE_AVE</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mi">170</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">,</span> <span class="s2">&quot;AVERAGE&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">150</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">,</span><span class="s2">&quot;AVERAGE&quot;</span><span class="p">]</span>
        <span class="o">+</span> <span class="mi">36</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;BEETS_FAVORABLE&quot;</span><span class="p">,</span><span class="s2">&quot;AVERAGE&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;BEETS_UNFAVORABLE&quot;</span><span class="p">,</span><span class="s2">&quot;AVERAGE&quot;</span><span class="p">])</span>
    
    <span class="n">model</span><span class="o">.</span><span class="n">PURCHASE_COST_BELOW</span> <span class="o">=</span> <span class="mi">238</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">,</span> <span class="s2">&quot;BELOW&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">210</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">,</span><span class="s2">&quot;BELOW&quot;</span><span class="p">]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">SALES_REVENUE_BELOW</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mi">170</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">,</span> <span class="s2">&quot;BELOW&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">150</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">,</span><span class="s2">&quot;BELOW&quot;</span><span class="p">]</span>
        <span class="o">+</span> <span class="mi">36</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;BEETS_FAVORABLE&quot;</span><span class="p">,</span><span class="s2">&quot;BELOW&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;BEETS_UNFAVORABLE&quot;</span><span class="p">,</span><span class="s2">&quot;BELOW&quot;</span><span class="p">])</span>
    
    <span class="n">model</span><span class="o">.</span><span class="n">OBJ</span> <span class="o">=</span> <span class="n">Objective</span><span class="p">(</span>
        <span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">PLANTING_COST</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">PURCHASE_COST_ABOVE</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">PURCHASE_COST_AVE</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">PURCHASE_COST_BELOW</span><span class="p">)</span>
        <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">SALES_REVENUE_ABOVE</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">SALES_REVENUE_AVE</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">SALES_REVENUE_BELOW</span><span class="p">),</span>
        <span class="n">sense</span><span class="o">=</span><span class="n">minimize</span>
    <span class="p">)</span>

    <span class="c1"># Constraints</span>
    <span class="n">model</span><span class="o">.</span><span class="n">CONSTR</span><span class="o">=</span> <span class="n">ConstraintList</span><span class="p">()</span>

    <span class="n">model</span><span class="o">.</span><span class="n">CONSTR</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">summation</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">500</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">CONSTR</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">yields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">,</span><span class="s2">&quot;AVERAGE&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">,</span><span class="s2">&quot;AVERAGE&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">CONSTR</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">yields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">1.2</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">,</span><span class="s2">&quot;ABOVE&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">,</span><span class="s2">&quot;ABOVE&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">CONSTR</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">yields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.8</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">,</span><span class="s2">&quot;BELOW&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">,</span><span class="s2">&quot;BELOW&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">)</span>
    
    <span class="n">model</span><span class="o">.</span><span class="n">CONSTR</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">yields</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">,</span><span class="s2">&quot;AVERAGE&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">,</span><span class="s2">&quot;AVERAGE&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">240</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">CONSTR</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">yields</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">1.2</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">,</span><span class="s2">&quot;ABOVE&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">,</span><span class="s2">&quot;ABOVE&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">240</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">CONSTR</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">yields</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">0.8</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">,</span><span class="s2">&quot;BELOW&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">,</span><span class="s2">&quot;BELOW&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">240</span><span class="p">)</span>
    
    <span class="n">model</span><span class="o">.</span><span class="n">CONSTR</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">yields</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;BEETS&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;BEETS_FAVORABLE&quot;</span><span class="p">,</span><span class="s2">&quot;AVERAGE&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;BEETS_UNFAVORABLE&quot;</span><span class="p">,</span><span class="s2">&quot;AVERAGE&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span>
    <span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">CONSTR</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">yields</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mf">1.2</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;BEETS&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;BEETS_FAVORABLE&quot;</span><span class="p">,</span><span class="s2">&quot;ABOVE&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;BEETS_UNFAVORABLE&quot;</span><span class="p">,</span><span class="s2">&quot;ABOVE&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span>
    <span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">CONSTR</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">yields</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mf">0.8</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;BEETS&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;BEETS_FAVORABLE&quot;</span><span class="p">,</span><span class="s2">&quot;BELOW&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;BEETS_UNFAVORABLE&quot;</span><span class="p">,</span><span class="s2">&quot;BELOW&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span>
    <span class="p">)</span>
    
    
    <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;BEETS_FAVORABLE&quot;</span><span class="p">,</span><span class="s2">&quot;AVERAGE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setub</span><span class="p">(</span><span class="mi">6000</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;BEETS_FAVORABLE&quot;</span><span class="p">,</span><span class="s2">&quot;ABOVE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setub</span><span class="p">(</span><span class="mi">6000</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;BEETS_FAVORABLE&quot;</span><span class="p">,</span><span class="s2">&quot;BELOW&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setub</span><span class="p">(</span><span class="mi">6000</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### calculate two-stage stochastic problem</span>
<span class="n">yields_perfect</span> <span class="o">=</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">build_sp_model</span><span class="p">(</span><span class="n">yields_perfect</span><span class="p">)</span>
<span class="n">solver</span> <span class="o">=</span> <span class="n">SolverFactory</span><span class="p">(</span><span class="s2">&quot;ipopt&quot;</span><span class="p">)</span>
<span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

<span class="n">profit_2stage</span> <span class="o">=</span> <span class="o">-</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">OBJ</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;===Optimal solutions of two-stage stochastic problem===&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Culture.         | &#39;</span><span class="p">,</span> <span class="s1">&#39;Wheat |&#39;</span><span class="p">,</span> <span class="s1">&#39;Corn  |&#39;</span><span class="p">,</span> <span class="s1">&#39;Sugar Beets |&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Surface (acres)  | &#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">])</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">,</span> 
      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">])</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; |&#39;</span><span class="p">,</span>
       <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;BEETS&quot;</span><span class="p">])</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39; |&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;First stage: s=1 (Above average)&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Culture.         | &#39;</span><span class="p">,</span> <span class="s1">&#39;Wheat |&#39;</span><span class="p">,</span> <span class="s1">&#39;Corn  |&#39;</span><span class="p">,</span> <span class="s1">&#39;Sugar Beets |&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Yield (T)        | &#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">])</span><span class="o">*</span><span class="n">yields_perfect</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">1.2</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">,</span> 
      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">])</span><span class="o">*</span><span class="n">yields_perfect</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">1.2</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">,</span>
       <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;BEETS&quot;</span><span class="p">])</span><span class="o">*</span><span class="n">yields_perfect</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mf">1.2</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sales (T)        | &#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">,</span><span class="s2">&quot;ABOVE&quot;</span><span class="p">])</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">,</span> 
      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">,</span><span class="s2">&quot;ABOVE&quot;</span><span class="p">])</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;  |&#39;</span><span class="p">,</span>
       <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;BEETS_FAVORABLE&quot;</span><span class="p">,</span><span class="s2">&quot;ABOVE&quot;</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;BEETS_UNFAVORABLE&quot;</span><span class="p">,</span><span class="s2">&quot;ABOVE&quot;</span><span class="p">])</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Purchases (T)    | &#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">,</span><span class="s2">&quot;ABOVE&quot;</span><span class="p">])</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;  |&#39;</span><span class="p">,</span> 
      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">,</span><span class="s2">&quot;ABOVE&quot;</span><span class="p">])</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;  |&#39;</span><span class="p">,</span>
       <span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;     |&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;First stage: s=2 (Average average)&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Culture.         | &#39;</span><span class="p">,</span> <span class="s1">&#39;Wheat |&#39;</span><span class="p">,</span> <span class="s1">&#39;Corn  |&#39;</span><span class="p">,</span> <span class="s1">&#39;Sugar Beets |&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Yield (T)        | &#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">])</span><span class="o">*</span><span class="n">yields_perfect</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">,</span> 
      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">])</span><span class="o">*</span><span class="n">yields_perfect</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">,</span>
       <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;BEETS&quot;</span><span class="p">])</span><span class="o">*</span><span class="n">yields_perfect</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sales (T)        | &#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">,</span><span class="s2">&quot;AVERAGE&quot;</span><span class="p">])</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">,</span> 
      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">,</span><span class="s2">&quot;AVERAGE&quot;</span><span class="p">])</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;  |&#39;</span><span class="p">,</span>
       <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;BEETS_FAVORABLE&quot;</span><span class="p">,</span><span class="s2">&quot;AVERAGE&quot;</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;BEETS_UNFAVORABLE&quot;</span><span class="p">,</span><span class="s2">&quot;AVERAGE&quot;</span><span class="p">])</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Purchases (T)    | &#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">,</span><span class="s2">&quot;AVERAGE&quot;</span><span class="p">])</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;  |&#39;</span><span class="p">,</span> 
      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">,</span><span class="s2">&quot;AVERAGE&quot;</span><span class="p">])</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;  |&#39;</span><span class="p">,</span>
       <span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;     |&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;First stage: s=3 (Below average)&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Culture.         | &#39;</span><span class="p">,</span> <span class="s1">&#39;Wheat |&#39;</span><span class="p">,</span> <span class="s1">&#39;Corn  |&#39;</span><span class="p">,</span> <span class="s1">&#39;Sugar Beets |&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Yield (T)        | &#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">])</span><span class="o">*</span><span class="n">yields_perfect</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.8</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">,</span> 
      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">])</span><span class="o">*</span><span class="n">yields_perfect</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">0.8</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">,</span>
       <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;BEETS&quot;</span><span class="p">])</span><span class="o">*</span><span class="n">yields_perfect</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mf">0.8</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sales (T)        | &#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">,</span><span class="s2">&quot;BELOW&quot;</span><span class="p">])</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">,</span> 
      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">,</span><span class="s2">&quot;BELOW&quot;</span><span class="p">])</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;  |&#39;</span><span class="p">,</span>
       <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;BEETS_FAVORABLE&quot;</span><span class="p">,</span><span class="s2">&quot;BELOW&quot;</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="s2">&quot;BEETS_UNFAVORABLE&quot;</span><span class="p">,</span><span class="s2">&quot;BELOW&quot;</span><span class="p">])</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Purchases (T)    | &#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">,</span><span class="s2">&quot;BELOW&quot;</span><span class="p">])</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;  |&#39;</span><span class="p">,</span> 
      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">,</span><span class="s2">&quot;BELOW&quot;</span><span class="p">])</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;  |&#39;</span><span class="p">,</span>
       <span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;     |&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Overall profit: $&#39;</span><span class="p">,</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">profit_2stage</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>===Optimal solutions of two-stage stochastic problem===
Culture.         |  Wheat | Corn  | Sugar Beets |
Surface (acres)  |  170.0 | 80.0  | 250.0  |
First stage: s=1 (Above average)
Culture.         |  Wheat | Corn  | Sugar Beets |
Yield (T)        |  510.0 | 288.0 | 6000.0 |
Sales (T)        |  310.0 | 48.0   | 6000.0 |
Purchases (T)    |  0.0   | 0.0   | -      |
First stage: s=2 (Average average)
Culture.         |  Wheat | Corn  | Sugar Beets |
Yield (T)        |  425.0 | 240.0 | 5000.0 |
Sales (T)        |  225.0 | 0.0   | 5000.0 |
Purchases (T)    |  0.0   | 0.0   | -      |
First stage: s=3 (Below average)
Culture.         |  Wheat | Corn  | Sugar Beets |
Yield (T)        |  340.0 | 192.0 | 4000.0 |
Sales (T)        |  140.0 | 0.0   | 4000.0 |
Purchases (T)    |  0.0   | 48.0   | -      |
Overall profit: $ 108390.0
</pre></div>
</div>
</div>
</div>
<p><img alt="ex1.2" src="https://raw.githubusercontent.com/ndcbe/optimization/main/media/farmer2-4.png" /></p>
<p>Such a model of a stochastic decision program is known as the <span class="math notranslate nohighlight">\(extensive\)</span> <span class="math notranslate nohighlight">\(form\)</span> of the stochastic program because it explicitly describes the second-stage decision variables for all scenarios.</p>
<p>This solution illustrates that it is impossible to find a solution that is ideal under all circumstances under uncertainty.</p>
</section>
<section id="comparing-perfect-information-and-the-stochastic-solutions">
<h3><span class="section-number">4.1.2.6. </span>Comparing Perfect Information and the Stochastic Solutions<a class="headerlink" href="#comparing-perfect-information-and-the-stochastic-solutions" title="Link to this heading">#</a></h3>
<p><strong>Perfect Information</strong></p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Yield</p></th>
<th class="head"><p>Low Yield</p></th>
<th class="head"><p>Average Yield</p></th>
<th class="head"><p>High Yield</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Profit</strong></p></td>
<td><p>$59,950</p></td>
<td><p>$118,600</p></td>
<td><p>$167,667</p></td>
</tr>
</tbody>
</table>
</div>
<p>Average: <span class="math notranslate nohighlight">\( \$115,406 \)</span>, representing the <strong>WS</strong> (wait-and-see problem)</p>
<p><strong>Stochastic Programming</strong></p>
<p><span class="math notranslate nohighlight">\( WS = E_{\xi} \left[ \min_{X} f(X, \xi) \right] \)</span></p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Profit</p></th>
<th class="head"><p>Low</p></th>
<th class="head"><p>Average</p></th>
<th class="head"><p>High</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Stochastic</strong></p></td>
<td><p>$48,820</p></td>
<td><p>$109,350</p></td>
<td><p>$167,000</p></td>
</tr>
</tbody>
</table>
</div>
<p>Average: <span class="math notranslate nohighlight">\( \$108,390 \)</span>, representing the <strong>RP</strong> (recourse problem).</p>
<p><span class="math notranslate nohighlight">\( RP = \min_{X} E_{\xi} \left[ f(X, \xi) \right] \)</span></p>
</section>
<section id="expected-value-of-perfect-information-evpi">
<h3><span class="section-number">4.1.2.7. </span>Expected Value of Perfect Information (EVPI)<a class="headerlink" href="#expected-value-of-perfect-information-evpi" title="Link to this heading">#</a></h3>
<p>Suppose yields vary over years but are cyclical. A year with above average yields is always followed by a year with average yields and then a year with below average yields. The farmer would take optimal solutions as given in perfect information chapter repectively. The mean profit in the long run will be the mean of the three figures, namely $115,406 per year.</p>
<p>Now assume again the yields vary over years but on a random basis. The farmer does not get prior information on the yields. So, the best he can do in the long run is to take the solution as given in the two-stage stochastic program. The difference between this figure and the value in the case of perfect information is <span class="math notranslate nohighlight">\(the\)</span> <span class="math notranslate nohighlight">\(expected\)</span> <span class="math notranslate nohighlight">\(value\)</span> <span class="math notranslate nohighlight">\(of\)</span> <span class="math notranslate nohighlight">\(perfect\)</span> <span class="math notranslate nohighlight">\(information\)</span> (EVPI). It represents the loss of profit due to the presence of uncertainty.</p>
<p><strong>Note:</strong> In the tables above, we reported profit. But our objective was actually to minimize <em>negative</em> profit. We added the negative sign in the calculation below. This is because the formulas are defined for minimization problems.</p>
<p><span class="math notranslate nohighlight">\( EVPI = RP - WS = -\$108,390 - (-\$115,406) = \$7,016 \)</span></p>
<p>This represents <strong>how much the farmer is willing to pay for a perfect forecast</strong>.</p>
<p>Another approach is to assume expected yields and always to allocate the optimal planting surface according to these yields, which represents the <em>expected values solution</em>. The loss by not considering the random variation is the difference between this and the stochastic model profit, which is called the <em>value of the stochastic solution</em> (VSS).</p>
</section>
<section id="expected-value-solution-ev">
<h3><span class="section-number">4.1.2.8. </span>Expected Value Solution (EV)<a class="headerlink" href="#expected-value-solution-ev" title="Link to this heading">#</a></h3>
<p>How good is the stochastic solution compared to not considering uncertainty?</p>
<ul class="simple">
<li><p><strong>Expected Value Solution:</strong>
<span class="math notranslate nohighlight">\( \bar{x} = \arg \min_{X} f(X, \bar{\xi}) \)</span></p></li>
<li><p><strong>Expected result using EV solution:</strong>
<span class="math notranslate nohighlight">\( EEV = E_{\xi} \left[ f(\bar{X}, \xi) \right] \)</span></p></li>
</ul>
<p>Farmer’s:
<span class="math notranslate nohighlight">\( EEV = -\$107,240 \)</span></p>
<p>We get this value by recomputing the objective considering the scenarion data buy using the deterministic decision.</p>
</section>
<section id="value-of-stochastic-solution-vss">
<h3><span class="section-number">4.1.2.9. </span>Value of Stochastic Solution (VSS)<a class="headerlink" href="#value-of-stochastic-solution-vss" title="Link to this heading">#</a></h3>
<p>What is the cost of ignoring uncertainty?</p>
<p>VSS = EEV - RP = (-$107,240) - (-$108,390) = $ 1,150</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># calculated EVPI</span>
<span class="n">EVPI</span> <span class="o">=</span> <span class="p">(</span><span class="n">profit_perfect</span><span class="o">+</span><span class="n">profit_above</span><span class="o">+</span><span class="n">profit_below</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span> <span class="o">-</span> <span class="n">profit_2stage</span> 

<span class="c1"># calculate expectation value</span>
<span class="n">expected</span> <span class="o">=</span> <span class="n">build_sp_model</span><span class="p">(</span><span class="n">yields_perfect</span><span class="p">)</span>
<span class="c1"># fix variables with solutions</span>
<span class="n">expected</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;WHEAT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="mi">120</span><span class="p">)</span>
<span class="n">expected</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;CORN&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span>
<span class="n">expected</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;BEETS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
<span class="c1"># solve the model</span>
<span class="n">solver</span> <span class="o">=</span> <span class="n">SolverFactory</span><span class="p">(</span><span class="s2">&quot;ipopt&quot;</span><span class="p">)</span>
<span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">expected</span><span class="p">)</span>
<span class="c1"># calculate expected value</span>
<span class="n">profit_expect</span> <span class="o">=</span> <span class="o">-</span><span class="n">value</span><span class="p">(</span><span class="n">expected</span><span class="o">.</span><span class="n">OBJ</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Expectation:&#39;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">profit_expect</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>

<span class="n">VSS</span> <span class="o">=</span> <span class="p">(</span><span class="n">profit_2stage</span> <span class="o">-</span> <span class="n">profit_expect</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;EVPI:&#39;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">EVPI</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;VSS:&#39;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">VSS</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Expectation: 107240.00084222008
EVPI: 7015.554283317964
VSS: 1150.0010277524998
</pre></div>
</div>
</div>
</div>
<p><span class="math notranslate nohighlight">\(EVPI\)</span> measures the value of knowing the future with certainty, while <span class="math notranslate nohighlight">\(VSS\)</span> assesses the value of knowing and using distributions on future outcomes.</p>
</section>
<section id="reference">
<h3><span class="section-number">4.1.2.10. </span>Reference<a class="headerlink" href="#reference" title="Link to this heading">#</a></h3>
<p>Biegler, L.T., 2010. Nonlinear programming: concepts, algorithms, and applications to chemical processes. Society for Industrial and Applied Mathematics.</p>
<p>Birge, J.R. and Louveaux, F., 2011. Introduction to stochastic programming. Springer Science &amp; Business Media.</p>
<p>Code partly adapted from:</p>
<p><a class="reference external" href="https://mpi-sppy.readthedocs.io/en/latest/quick_start.html">https://mpi-sppy.readthedocs.io/en/latest/quick_start.html</a></p>
<p><a class="reference external" href="https://mpi-sppy.readthedocs.io/en/latest/examples.html#examples">https://mpi-sppy.readthedocs.io/en/latest/examples.html#examples</a></p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/4"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="uncertainty.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">4. </span>Optimization Under Uncertainty</p>
      </div>
    </a>
    <a class="right-next"
       href="blocks.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">4.2. </span>Blocks and Other Pyomo Best Practices</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#farmers-example">4.1.1. Farmers Example</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-formulation-in-words">4.1.1.1. Problem Formulation In Words</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#perfect-information">4.1.1.2. Perfect information</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">4.1.1.3. Stochastic Programming</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#key-concepts">4.1.2. Key Concepts</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#probability-review">4.1.2.1. Probability Review</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#infinite-dimensional-formulation">4.1.2.2. Infinite Dimensional Formulation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#discrete-finite-dimensional-approximations">4.1.2.3. Discrete (Finite Dimensional) Approximations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#general-two-stage-stochastic-programming-formulation">4.1.2.4. General Two-Stage Stochastic Programming Formulation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#include-uncertainty-in-the-farmer-s-problem-two-stage-stochastic-program">4.1.2.5. Include uncertainty in the Farmer’s Problem (two-stage stochastic program)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-perfect-information-and-the-stochastic-solutions">4.1.2.6. Comparing Perfect Information and the Stochastic Solutions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#expected-value-of-perfect-information-evpi">4.1.2.7. Expected Value of Perfect Information (EVPI)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#expected-value-solution-ev">4.1.2.8. Expected Value Solution (EV)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#value-of-stochastic-solution-vss">4.1.2.9. Value of Stochastic Solution (VSS)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reference">4.1.2.10. Reference</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Alexander Dowling, et al.
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>