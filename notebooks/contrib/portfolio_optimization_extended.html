
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Risk Measures and Portfolio Optimization: Expanded &#8212; Optimization for Decision Science</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/contrib/portfolio_optimization_extended';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Extended Race Car Optimization Models" href="race_car_extended.html" />
    <link rel="prev" title="Vehicle Routing" href="vehicle_routing.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/cbe_logo.jpg" class="logo__image only-light" alt="Optimization for Decision Science - Home"/>
    <script>document.write(`<img src="../../_static/cbe_logo.jpg" class="logo__image only-dark" alt="Optimization for Decision Science - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    Optimization for Decision Science
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Organization</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../org/intro.html">Welcome</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../org/syllabus.html">Syllabus</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../org/calendar.html">Fall 2024 Calendar</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../org/contribute.html">Contribution Instructions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../org/workshop.html">Computational Optimization in Python (SÃ£o Paulo, Brazil)</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../org/assignments.html">Assignments</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../assignments/Pyomo1.html">Pyomo Homework 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../assignments/Pyomo2.html">Pyomo Homework 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../assignments/Pyomo3.html">Pyomo Homework 3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../org/project1.html">Project 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../assignments/Algorithms1.html">Algorithms Homework 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../assignments/Algorithms2.html">Algorithms Homework 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../org/project2.html">Project 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../assignments/Algorithms3.html">Algorithms Homework 3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../assignments/Algorithms4.html">Algorithms Homework 4</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../org/archive.html">Archive</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../assignments/Pyomo-Mini-Project.html">Pyomo Mini-Project: Receding Horizon Stochastic Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../org/semester_project.html">Semester Project (Spring 2023)</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Optimization Modeling in Pyomo</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../1/getting-started.html">1. Getting Started with Pyomo</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../1/Local-Install.html">1.1. Local Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../1/Optimization-Modeling.html">1.2. Optimization Modeling with Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../1/Pyomo-Introduction.html">1.3. Your First Optimization Problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../1/LP.html">1.4. Continuous Optimization: Linear Programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="../1/NLP.html">1.5. Continuous Optimization: Nonlinear Programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="../1/IP.html">1.6. Integer Programs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../1/Pyomo-Nuts-and-Bolts.html">1.7. 60 Minutes to Pyomo: An Energy Storage Model Predictive Control Example</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../2/logic.html">2. Logical Modeling</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../2/Logical_Modeling_GDP.html">2.1. Logical Modeling and Generalized Disjunctive Programs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../2/Modeling_Disjunctions_Strip_Packing.html">2.2. Modeling Disjunctions through the Strip Packing Problem</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../3/dynamics.html">3. Dynamic Optimization</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../3/PyomoDAE_car.html">3.1. Pyomo.DAE Example: Race Car</a></li>
<li class="toctree-l2"><a class="reference internal" href="../3/PyomoDAE_TCLab.html">3.2. Pyomo.DAE Example: Temperature Control Lab</a></li>
<li class="toctree-l2"><a class="reference internal" href="../3/DAE_background.html">3.3. Differential Algebraic Equations (DAEs)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../3/DAE_numeric_integration.html">3.4. Numeric Integration for DAEs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../3/PyomoDAE_theory.html">3.5. Dynamic Optimization with Collocation and Pyomo.DAE</a></li>
<li class="toctree-l2"><a class="reference internal" href="../3/PyomoDAE_example.html">3.6. Pyomo.DAE: Racing Example Revisited</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../4/uncertainty.html">4. Optimization Under Uncertainty</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../4/SP.html">4.1. Stochastic Programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="../4/blocks.html">4.2. Blocks and Other Pyomo Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../4/AdvancedTopics.html">4.3. Advanced Topics in Stochastic Programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="../4/RiskMeasures.html">4.4. Risk Measures and Portfolio Optimization</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../5/data.html">5. Data Science and Applied Statistics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../5/Parmest-tutorial.html">5.1. Parameter estimation with <code class="docutils literal notranslate"><span class="pre">parmest</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../5/Parmest-generate-data.html">5.2. Supplementary material: data for parmest tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../5/Pyomo_DoE_Tutorial.html">5.3. Optimizing Experiments with <code class="docutils literal notranslate"><span class="pre">Pyomo.DoE</span></code></a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Algorithms and Theory</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../6/unconstrained.html">6. Unconstrained Nonlinear Optimization</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../6/Math-Primer-1.html">6.1. Linear Algebra Review and SciPy Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../6/Math-Primer-2.html">6.2. Mathematics Primer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../6/Optimality.html">6.3. Unconstrained Optimality Conditions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../6/Newton-Methods.html">6.4. Newton-type Methods for Unconstrained Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../6/Quasi-Newton-Methods.html">6.5. Quasi-Newton Methods for Unconstrained Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../6/Globalization.html">6.6. Descent and Globalization</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../7/constrained.html">7. Constrained Nonlinear Optimization</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../7/Convexity.html">7.1. Convexity Revisited</a></li>
<li class="toctree-l2"><a class="reference internal" href="../7/Local-Optimality.html">7.2. Local Optimality Conditions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../7/KKT-Multipliers.html">7.3. Analysis of KKT Conditions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../7/Constraint-Qualifications.html">7.4. Constraint Qualifications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../7/Second-Order.html">7.5. Second Order Optimality Conditions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../7/degeneracy_hunter.html">7.6. NLP Diagnostics with Degeneracy Hunter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../7/Interior-Point1.html">7.7. Simple Netwon Method for Equality Constrained NLPs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../7/Interior-Point2.html">7.8. Inertia-Corrected Netwon Method for Equality Constrained NLPs</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../8/special-topics.html">8. Special Topics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../8/MILP.html">8.1. Integer Programming with Simple Branch and Bound</a></li>
<li class="toctree-l2"><a class="reference internal" href="../8/MINLP-Algorithms.html">8.2. MINLP Algorithms</a></li>
<li class="toctree-l2"><a class="reference internal" href="../8/Global-Opt.html">8.3. Deterministic Global Optimization</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Student Contributions</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="pyomo.html">More Pyomo Examples</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="semiconductor_manufacturing.html">Semiconductor Production Planning</a></li>
<li class="toctree-l2"><a class="reference internal" href="student_diet.html">Optimization of Daily Diet Using Pyomo</a></li>
<li class="toctree-l2"><a class="reference internal" href="blending.html">Blending Under Uncertainty</a></li>
<li class="toctree-l2"><a class="reference internal" href="vehicle_routing.html">Vehicle Routing</a></li>

<li class="toctree-l2 current active"><a class="current reference internal" href="#">Risk Measures and Portfolio Optimization: Expanded</a></li>
<li class="toctree-l2"><a class="reference internal" href="race_car_extended.html">Extended Race Car Optimization Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="hot_air_balloon.html">Hot Air Balloon Dynamic Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="reactor_design.html">Chemical Reactor Design</a></li>
<li class="toctree-l2"><a class="reference internal" href="Disaster_Response_Plan.html">Disaster Response Plan Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="Sudoku_Solver.html">Sudoku Solver</a></li>
<li class="toctree-l2"><a class="reference internal" href="more_circle_packing.html">Circle Packing Optimization</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="modeling.html">Modeling Paradigms</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="multi_objective.html">Multi-Objective Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced_stochastic_programming.html">Advanced Topics in Stochastic Programming</a></li>






</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="algorithms.html">Global Optimization</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="Deterministic_Global_Optimization.html">Deterministic Global Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="Bayesian_Optimization1.html">Bayesian Optimization Tutorial 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="Bayesian_Optimization2.html">Bayesian Optimization Tutorial 2</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="sgd.html">Stochastic Gradient Descent</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="Stochastic-Gradient-Descent-1.html">Stochastic Gradient Descent Tutorial 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="Stochastic-Gradient-Descent-2.html">Stochastic Gradient Descent Tutorial 2</a></li>






<li class="toctree-l2"><a class="reference internal" href="Stochastic-Gradient-Descent-3.html">Stochastic Gradient Descent Tutorial 3</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="data.html">Machine Learning and Applied Statistics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="EM-MAP.html">Expectation Maximization Algorithm and MAP Estimation</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/ndcbe/optimization/blob/master/notebooks/contrib/portfolio_optimization_extended.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/ndcbe/optimization" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/ndcbe/optimization/issues/new?title=Issue%20on%20page%20%2Fnotebooks/contrib/portfolio_optimization_extended.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/notebooks/contrib/portfolio_optimization_extended.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Risk Measures and Portfolio Optimization: Expanded</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-objectives">Learning Objectives</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-base-problem">The Base Problem</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-input-data">Visualize Input Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-plotting-functions">Define Plotting Functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-base-model-in-pyomo">Define Base Model in Pyomo</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#risk-measurement-equations">Risk measurement equations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementing-a-new-scenario-model-supply-and-demand-and-government-caps">Implementing a new scenario: model supply and demand and government caps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#system-description-model">System Description/Model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dof-analysis">DOF Analysis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summarizing-what-happened">Summarizing what happened</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementing-a-new-scenario-stochastic-modeling">Implementing a new scenario: Stochastic Modeling</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="risk-measures-and-portfolio-optimization-expanded">
<h1>Risk Measures and Portfolio Optimization: Expanded<a class="headerlink" href="#risk-measures-and-portfolio-optimization-expanded" title="Link to this heading">#</a></h1>
<p><strong>Prepared by:</strong> Andrew Marquardt and Yohannes Mariam (<a class="reference external" href="mailto:amarquar&#37;&#52;&#48;nd&#46;edu">amarquar<span>&#64;</span>nd<span>&#46;</span>edu</a><a class="reference external" href="mailto:,ymariam&#37;&#52;&#48;nd&#46;edu">,ymariam<span>&#64;</span>nd<span>&#46;</span>edu</a>, 2024). Original source material by Madelynn Watson.</p>
<p>Primary source: <a class="reference internal" href="../4/RiskMeasures.html"><span class="std std-doc">Risk Measures and Portfolio Optimization</span></a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Imports</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="k">if</span> <span class="s2">&quot;google.colab&quot;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
    <span class="err">!</span><span class="n">wget</span> <span class="s2">&quot;https://raw.githubusercontent.com/ndcbe/optimization/main/notebooks/helper.py&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">helper</span>
    <span class="n">helper</span><span class="o">.</span><span class="n">easy_install</span><span class="p">()</span>
    <span class="n">helper</span><span class="o">.</span><span class="n">install_idaes</span><span class="p">()</span>
    <span class="n">helper</span><span class="o">.</span><span class="n">install_ipopt</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;../&#39;</span><span class="p">)</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">helper</span>
<span class="n">helper</span><span class="o">.</span><span class="n">set_plotting_style</span><span class="p">()</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyomo.environ</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pyo</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--2024-10-31 21:43:08--  https://raw.githubusercontent.com/ndcbe/optimization/main/notebooks/helper.py
Resolving raw.githubusercontent.com (raw.githubusercontent.com)... 185.199.110.133, 185.199.109.133, 185.199.111.133, ...
Connecting to raw.githubusercontent.com (raw.githubusercontent.com)|185.199.110.133|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 6493 (6.3K) [text/plain]
Saving to: âhelper.py.2â


helper.py.2           0%[                    ]       0  --.-KB/s               
helper.py.2         100%[===================&gt;]   6.34K  --.-KB/s    in 0s      

2024-10-31 21:43:08 (52.8 MB/s) - âhelper.py.2â saved [6493/6493]

idaes was found! No need to install.
idaes was found! No need to install.
</pre></div>
</div>
</div>
</div>
<section id="learning-objectives">
<h2>Learning Objectives<a class="headerlink" href="#learning-objectives" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Understand how more complicated supply and demand scenarios that affect marginal profit change the way in which decisions are made during optimization</p></li>
<li><p>Learn how a variable marginal price functionally dependent on the optimum solution can be implemented into a pyomo model</p></li>
<li><p>Observe how stochastic uncertainty in the input feed affects the optimization decision flow</p></li>
<li><p>Apply stochastic modeling to a scenario with both inherent model uncertainty/noise and increased market regulation</p></li>
</ul>
</section>
<section id="the-base-problem">
<h2>The Base Problem<a class="headerlink" href="#the-base-problem" title="Link to this heading">#</a></h2>
<p>Our work expands upon the notebook prepared by Madelyn Watson for Portfolio management.  It includes the Mean Value (MV), Mean-Absolute Deviation, and Condition Value-at-Risk (CVaR) risk measurements, taken directly from Madelynâs work.  For a summary of those risk measurements, We have included the equations from her work, though for greater analysis, the source notebook is excellent.  The base idea is that a Sugar Cane mill in Brazil must decide how to process its products into sugar cane, ethanol, and free market and regulated electricity.  With different risk management metrics comes different profiles, though interesting results do follow with the inclusion of more complicated scenarios.  Below is the mill flowchart prepared in the original notebook, describing the system and decision tree, of sorts.</p>
<p><img alt="op1.jpg" src="https://raw.githubusercontent.com/ndcbe/optimization/main/media/contrib/process_PFD.jpg" /></p>
<section id="visualize-input-data">
<h3>Visualize Input Data<a class="headerlink" href="#visualize-input-data" title="Link to this heading">#</a></h3>
<p>The following data is copied from the original notebook and depicts the historical price data for each market as well as the mill constraints.  More detailed information is presented in that notebook, but it is important to at least briefly take time to understand the data sets and constraints placed on the optimization we will utilize.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#Load Data From CSV files stored on Github</span>
<span class="n">path_cap</span><span class="o">=</span><span class="s1">&#39;https://raw.githubusercontent.com/MadelynnWatson/RiskMeasures/main/Capacity.csv&#39;</span>
<span class="n">path_opex</span> <span class="o">=</span> <span class="s1">&#39;https://raw.githubusercontent.com/MadelynnWatson/RiskMeasures/main/OPEX.csv&#39;</span>
<span class="n">path_conv</span> <span class="o">=</span> <span class="s1">&#39;https://raw.githubusercontent.com/MadelynnWatson/RiskMeasures/main/conversions.csv&#39;</span>
<span class="n">path_gen</span> <span class="o">=</span> <span class="s1">&#39;https://raw.githubusercontent.com/MadelynnWatson/RiskMeasures/main/generation.csv&#39;</span>
<span class="n">path_hp</span> <span class="o">=</span> <span class="s1">&#39;https://raw.githubusercontent.com/MadelynnWatson/RiskMeasures/main/historicalprices.csv&#39;</span>
<span class="n">df_maxcap</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_cap</span><span class="p">)</span>
<span class="n">df_prodcost</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_opex</span><span class="p">)</span>
<span class="n">df_conv</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_conv</span><span class="p">)</span>
<span class="n">df_gen</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_gen</span><span class="p">)</span>
<span class="n">df_hp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_hp</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">## Uncomment to Display Additional Data in Tables</span>
<span class="n">display</span><span class="p">(</span><span class="n">df_maxcap</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">df_prodcost</span><span class="p">)</span>
<span class="c1"># display(df_conv)</span>
<span class="c1"># display(df_gen)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
  <div id="df-509310be-6ba4-4776-bfb0-45640a4f93de" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>process</th>
      <th>capacity</th>
      <th>units</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>mill</td>
      <td>3000000</td>
      <td>tonne sugarcane</td>
    </tr>
    <tr>
      <th>1</th>
      <td>fact</td>
      <td>1541400</td>
      <td>tonne juice</td>
    </tr>
    <tr>
      <th>2</th>
      <td>dist</td>
      <td>2202000</td>
      <td>tonne juice</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-509310be-6ba4-4776-bfb0-45640a4f93de')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-509310be-6ba4-4776-bfb0-45640a4f93de button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-509310be-6ba4-4776-bfb0-45640a4f93de');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-2badb6f1-b056-49aa-981b-6e4491b430c6">
  <button class="colab-df-quickchart" onclick="quickchart('df-2badb6f1-b056-49aa-981b-6e4491b430c6')"
            title="Suggest charts"
            style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-2badb6f1-b056-49aa-981b-6e4491b430c6 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

  <div id="id_40cf62e2-39f2-4ff2-b81f-b5b1800286ee">
    <style>
      .colab-df-generate {
        background-color: #E8F0FE;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: none;
        fill: #1967D2;
        height: 32px;
        padding: 0 0 0 0;
        width: 32px;
      }

      .colab-df-generate:hover {
        background-color: #E2EBFA;
        box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
        fill: #174EA6;
      }

      [theme=dark] .colab-df-generate {
        background-color: #3B4455;
        fill: #D2E3FC;
      }

      [theme=dark] .colab-df-generate:hover {
        background-color: #434B5C;
        box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
        filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
        fill: #FFFFFF;
      }
    </style>
    <button class="colab-df-generate" onclick="generateWithVariable('df_maxcap')"
            title="Generate code using this dataframe."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px">
    <path d="M7,19H8.4L18.45,9,17,7.55,7,17.6ZM5,21V16.75L18.45,3.32a2,2,0,0,1,2.83,0l1.4,1.43a1.91,1.91,0,0,1,.58,1.4,1.91,1.91,0,0,1-.58,1.4L9.25,21ZM18.45,9,17,7.55Zm-12,3A5.31,5.31,0,0,0,4.9,8.1,5.31,5.31,0,0,0,1,6.5,5.31,5.31,0,0,0,4.9,4.9,5.31,5.31,0,0,0,6.5,1,5.31,5.31,0,0,0,8.1,4.9,5.31,5.31,0,0,0,12,6.5,5.46,5.46,0,0,0,6.5,12Z"/>
  </svg>
    </button>
    <script>
      (() => {
      const buttonEl =
        document.querySelector('#id_40cf62e2-39f2-4ff2-b81f-b5b1800286ee button.colab-df-generate');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      buttonEl.onclick = () => {
        google.colab.notebook.generateWithVariable('df_maxcap');
      }
      })();
    </script>
  </div>

    </div>
  </div>
</div><div class="output text_html">
  <div id="df-8304c358-6d29-4f29-90dc-63f479768c86" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>saleable_product</th>
      <th>cost</th>
      <th>units</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>sug</td>
      <td>321.92</td>
      <td>$/tonne</td>
    </tr>
    <tr>
      <th>1</th>
      <td>eth</td>
      <td>502.01</td>
      <td>$/m3</td>
    </tr>
    <tr>
      <th>2</th>
      <td>fre</td>
      <td>1.98</td>
      <td>$/MWh</td>
    </tr>
    <tr>
      <th>3</th>
      <td>reg</td>
      <td>1.98</td>
      <td>$/MWh</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-8304c358-6d29-4f29-90dc-63f479768c86')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-8304c358-6d29-4f29-90dc-63f479768c86 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-8304c358-6d29-4f29-90dc-63f479768c86');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-d78dba62-c5c3-49f4-ba2e-c38175325ac0">
  <button class="colab-df-quickchart" onclick="quickchart('df-d78dba62-c5c3-49f4-ba2e-c38175325ac0')"
            title="Suggest charts"
            style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-d78dba62-c5c3-49f4-ba2e-c38175325ac0 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

  <div id="id_cffa7939-07bd-4b64-9bb7-dafc7d8600ea">
    <style>
      .colab-df-generate {
        background-color: #E8F0FE;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: none;
        fill: #1967D2;
        height: 32px;
        padding: 0 0 0 0;
        width: 32px;
      }

      .colab-df-generate:hover {
        background-color: #E2EBFA;
        box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
        fill: #174EA6;
      }

      [theme=dark] .colab-df-generate {
        background-color: #3B4455;
        fill: #D2E3FC;
      }

      [theme=dark] .colab-df-generate:hover {
        background-color: #434B5C;
        box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
        filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
        fill: #FFFFFF;
      }
    </style>
    <button class="colab-df-generate" onclick="generateWithVariable('df_prodcost')"
            title="Generate code using this dataframe."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px">
    <path d="M7,19H8.4L18.45,9,17,7.55,7,17.6ZM5,21V16.75L18.45,3.32a2,2,0,0,1,2.83,0l1.4,1.43a1.91,1.91,0,0,1,.58,1.4,1.91,1.91,0,0,1-.58,1.4L9.25,21ZM18.45,9,17,7.55Zm-12,3A5.31,5.31,0,0,0,4.9,8.1,5.31,5.31,0,0,0,1,6.5,5.31,5.31,0,0,0,4.9,4.9,5.31,5.31,0,0,0,6.5,1,5.31,5.31,0,0,0,8.1,4.9,5.31,5.31,0,0,0,12,6.5,5.46,5.46,0,0,0,6.5,12Z"/>
  </svg>
    </button>
    <script>
      (() => {
      const buttonEl =
        document.querySelector('#id_cffa7939-07bd-4b64-9bb7-dafc7d8600ea button.colab-df-generate');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      buttonEl.onclick = () => {
        google.colab.notebook.generateWithVariable('df_prodcost');
      }
      })();
    </script>
  </div>

    </div>
  </div>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#Plot historical prices</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">df_hp</span><span class="p">[</span><span class="s1">&#39;eth&#39;</span><span class="p">])</span><span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">df_hp</span><span class="p">[</span><span class="s1">&#39;eth&#39;</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Ethanol&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Week (2013 - 2022)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;USD/m$^3$&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">df_hp</span><span class="p">[</span><span class="s1">&#39;sug&#39;</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Sugar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Week (2013 - 2022)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;USD/tonne&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">df_hp</span><span class="p">[</span><span class="s1">&#39;fre&#39;</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Electricity to Free Market&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Week (2013 - 2022)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;USD/MWh&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/24004b73466f86f74341a7b39671abec8fb12f8869406f4fb1b5f89f8b305f96.png" src="../../_images/24004b73466f86f74341a7b39671abec8fb12f8869406f4fb1b5f89f8b305f96.png" />
<img alt="../../_images/f4f4c623350fcd37011fff2df9f5e138cb4dd5d299403979b3344d06ad24d74f.png" src="../../_images/f4f4c623350fcd37011fff2df9f5e138cb4dd5d299403979b3344d06ad24d74f.png" />
<img alt="../../_images/159500a346a1c7aa1e391cd7429f98f2bd3b3754e3de441fc7b20dec7798c9c9.png" src="../../_images/159500a346a1c7aa1e391cd7429f98f2bd3b3754e3de441fc7b20dec7798c9c9.png" />
</div>
</div>
</section>
<section id="define-plotting-functions">
<h3>Define Plotting Functions<a class="headerlink" href="#define-plotting-functions" title="Link to this heading">#</a></h3>
<p>These plotting functions will be used multiple times down the notebook to display results.  For the sake of brevity, they are defined here and then called later.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">final_EP</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">final_min</span> <span class="o">=</span><span class="p">{}</span>
<span class="n">final_diff</span> <span class="o">=</span><span class="p">{}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">profit_dist</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">obj_name</span><span class="p">,</span><span class="n">final_EP</span><span class="p">,</span><span class="n">final_min</span><span class="p">,</span><span class="n">final_diff</span><span class="p">):</span>
    <span class="c1">#Collect the profit distribution</span>
    <span class="n">profits</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">:</span>
        <span class="n">profits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">profit</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="c1">#Collect the minimum profit</span>
    <span class="n">min_prof</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">profits</span><span class="p">)</span>

    <span class="c1">#Plot the Profit Distribution</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">profits</span><span class="p">),</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">ymin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">ymax</span><span class="o">=</span> <span class="mi">220</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Expected Profit&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">ymin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="mi">220</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">min_prof</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Minimum Profit&#39;</span><span class="p">),</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;profit$_q$ M USD&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Results&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Expected Profit:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;M USD&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Minimum Profit:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">min_prof</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;M USD&#39;</span><span class="p">)</span>
    <span class="n">difference</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">)</span> <span class="o">-</span> <span class="n">min_prof</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Difference:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">difference</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;M USD&#39;</span><span class="p">)</span>

    <span class="c1">#Collect results for conclusion</span>
    <span class="n">final_EP</span><span class="p">[</span><span class="n">obj_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span>
    <span class="n">final_min</span><span class="p">[</span><span class="n">obj_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_prof</span><span class="o">/</span><span class="mf">1e6</span>
    <span class="n">final_diff</span><span class="p">[</span><span class="n">obj_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">difference</span><span class="o">/</span><span class="mf">1e6</span>
    <span class="k">return</span> <span class="n">final_EP</span><span class="p">,</span><span class="n">final_min</span><span class="p">,</span><span class="n">final_diff</span>

<span class="k">def</span><span class="w"> </span><span class="nf">revenue_breakdown</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Sugar&#39;</span><span class="p">,</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">avg_sug_prof</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Ethanol&#39;</span><span class="p">,</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">avg_eth_prof</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Electricity </span><span class="se">\n</span><span class="s1"> Free </span><span class="se">\n</span><span class="s1"> Market&#39;</span><span class="p">,</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">avg_el_prof</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Electricity </span><span class="se">\n</span><span class="s1"> Regulated </span><span class="se">\n</span><span class="s1"> Market&#39;</span><span class="p">,</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;reg&#39;</span><span class="p">])</span><span class="o">*</span><span class="mf">72.5</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Product&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Revenue from </span><span class="se">\n</span><span class="s1"> Each Profit (USD)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="define-base-model-in-pyomo">
<h3>Define Base Model in Pyomo<a class="headerlink" href="#define-base-model-in-pyomo" title="Link to this heading">#</a></h3>
<p>The following function for building the pyomo model contains 3 options: The original (âdetâ), the stochastic model designed for this project (âstocâ), and the supply and demand adjustment designed for this project (the final else).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#Create Base Model In Pyomo</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_prodCost</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
  <span class="n">og_price</span> <span class="o">=</span> <span class="n">df_prodcost</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
  <span class="n">cost_uncertainty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">1.15</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">og_price</span><span class="o">*</span><span class="n">cost_uncertainty</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_model</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">scale_hyp</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">bin_count</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function buils a superstructure model in Pyomo for a sugarcane mill that can produce jet fuel.</span>

<span class="sd">    Inputs:</span>
<span class="sd">            product: desired product to maximize</span>
<span class="sd">            pathway: Excel sheet containing Jet fuel</span>
<span class="sd">            det: True if deterministic model, false if stocahstic model</span>

<span class="sd">    Returns: Pyomo model m</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">m</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">()</span>

    <span class="c1">#SETS</span>
    <span class="n">resources</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sug&#39;</span><span class="p">,</span> <span class="s1">&#39;eth&#39;</span><span class="p">,</span> <span class="s1">&#39;fre&#39;</span><span class="p">,</span> <span class="s1">&#39;reg&#39;</span><span class="p">,</span> <span class="s1">&#39;cane&#39;</span><span class="p">,</span> <span class="s1">&#39;jui&#39;</span><span class="p">,</span> <span class="s1">&#39;mol&#39;</span><span class="p">,</span> <span class="s1">&#39;bag&#39;</span><span class="p">,</span> <span class="s1">&#39;el-r&#39;</span><span class="p">]</span>
    <span class="n">saleable_products</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sug&#39;</span><span class="p">,</span> <span class="s1">&#39;eth&#39;</span><span class="p">,</span> <span class="s1">&#39;fre&#39;</span><span class="p">,</span> <span class="s1">&#39;reg&#39;</span><span class="p">]</span>
    <span class="n">processes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mill&#39;</span><span class="p">,</span> <span class="s1">&#39;fact&#39;</span><span class="p">,</span> <span class="s1">&#39;dist&#39;</span><span class="p">,</span><span class="s1">&#39;cogen&#39;</span><span class="p">]</span>
    <span class="n">commodity</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fre&#39;</span><span class="p">,</span><span class="s1">&#39;sug&#39;</span><span class="p">,</span><span class="s1">&#39;eth&#39;</span><span class="p">]</span>

    <span class="c1">#PARAMETERS</span>
    <span class="c1">#Scalars</span>
    <span class="n">Ca</span> <span class="o">=</span> <span class="mi">3000000</span>  <span class="c1"># Annual Sugarcane Capacity</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="mf">0.9</span>   <span class="c1"># Confidence Level For CVaR Formulation</span>
    <span class="n">price_reg</span> <span class="o">=</span> <span class="mf">72.5</span>   <span class="c1"># Price of electricity sold to the regulated market</span>

    <span class="c1">#Fill in Dictionaries with Excel Data</span>
    <span class="n">max_cap</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">prodcost</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">conv</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">gen</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">hp</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_maxcap</span><span class="p">[</span><span class="s1">&#39;process&#39;</span><span class="p">])):</span>
        <span class="n">max_cap</span><span class="p">[</span><span class="n">df_maxcap</span><span class="p">[</span><span class="s1">&#39;process&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df_maxcap</span><span class="p">[</span><span class="s1">&#39;capacity&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_prodcost</span><span class="p">[</span><span class="s1">&#39;saleable_product&#39;</span><span class="p">])):</span>
        <span class="n">prodcost</span><span class="p">[</span><span class="n">df_prodcost</span><span class="p">[</span><span class="s1">&#39;saleable_product&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">get_prodCost</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_conv</span><span class="p">[</span><span class="n">k</span><span class="p">])):</span>
            <span class="n">conv</span><span class="p">[(</span><span class="n">df_conv</span><span class="p">[</span><span class="s1">&#39;resource&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="n">df_conv</span><span class="p">[</span><span class="s1">&#39;process&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="n">df_conv</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_gen</span><span class="p">[</span><span class="n">k</span><span class="p">])):</span>
            <span class="n">gen</span><span class="p">[(</span><span class="n">df_gen</span><span class="p">[</span><span class="s1">&#39;process&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="n">df_gen</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">commodity</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_hp</span><span class="p">[</span><span class="n">k</span><span class="p">])):</span>
            <span class="n">hp</span><span class="p">[(</span><span class="n">df_hp</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="n">df_hp</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>

    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_hp</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">])</span>
    <span class="n">q</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;t</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;det&quot;</span><span class="p">:</span>
      <span class="c1">#PYOMO SETS</span>
      <span class="n">m</span><span class="o">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">resources</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">saleable_products</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">saleable_products</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">processes</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">processes</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">q</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">commodities</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">commodity</span><span class="p">)</span>

      <span class="n">m</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">N</span><span class="p">)</span>

      <span class="c1">#VARIABLES</span>
      <span class="c1">#Positive Variables</span>
      <span class="n">m</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">resources</span><span class="p">,</span> <span class="n">within</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">resources</span><span class="p">,</span><span class="n">m</span><span class="o">.</span><span class="n">processes</span><span class="p">,</span> <span class="n">within</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span> <span class="c1">#For juice split point</span>
      <span class="n">m</span><span class="o">.</span><span class="n">profit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">EP</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">()</span>


      <span class="c1"># Adding randomness in yield ranging from -20% to +20%</span>
      <span class="n">yield_factors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
      <span class="n">jui_yield</span><span class="p">,</span> <span class="n">bag_yield</span><span class="p">,</span> <span class="n">sug_yield</span><span class="p">,</span> <span class="n">mol_yield</span><span class="p">,</span> <span class="n">el_yield</span><span class="p">,</span> <span class="n">eth_yield</span> <span class="o">=</span> <span class="n">yield_factors</span>

      <span class="c1">#CONSTRAINTS</span>
      <span class="c1">#Superstructure Constraints</span>
      <span class="k">def</span><span class="w"> </span><span class="nf">mill1</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">jui_yield</span> <span class="o">==</span> <span class="n">Ca</span> <span class="o">*</span> <span class="n">conv</span><span class="p">[</span><span class="s1">&#39;cane&#39;</span><span class="p">,</span><span class="s1">&#39;mill&#39;</span><span class="p">,</span><span class="s1">&#39;jui&#39;</span><span class="p">]</span>
      <span class="n">m</span><span class="o">.</span><span class="n">milleq1</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">mill1</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">mill2</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;bag&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">bag_yield</span> <span class="o">==</span> <span class="n">Ca</span> <span class="o">*</span> <span class="n">conv</span><span class="p">[</span><span class="s1">&#39;cane&#39;</span><span class="p">,</span><span class="s1">&#39;mill&#39;</span><span class="p">,</span><span class="s1">&#39;bag&#39;</span><span class="p">]</span>
      <span class="n">m</span><span class="o">.</span><span class="n">milleq2</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">mill2</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">juice1</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">jui_yield</span> <span class="o">==</span> <span class="n">m</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">,</span><span class="s1">&#39;fact&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">,</span><span class="s1">&#39;dist&#39;</span><span class="p">]</span>
      <span class="n">m</span><span class="o">.</span><span class="n">juiceeq1</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">juice1</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">juice2</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">,</span><span class="s1">&#39;fact&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_cap</span><span class="p">[</span><span class="s1">&#39;fact&#39;</span><span class="p">]</span>
      <span class="n">m</span><span class="o">.</span><span class="n">juiceeq2</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">juice2</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">juice3</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">,</span><span class="s1">&#39;dist&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_cap</span><span class="p">[</span><span class="s1">&#39;dist&#39;</span><span class="p">]</span>
      <span class="n">m</span><span class="o">.</span><span class="n">juiceeq3</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">juice3</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">sugar1</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;sug&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">sug_yield</span> <span class="o">==</span> <span class="n">conv</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">,</span> <span class="s1">&#39;fact&#39;</span><span class="p">,</span> <span class="s1">&#39;sug&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">,</span><span class="s1">&#39;fact&#39;</span><span class="p">]</span>
      <span class="n">m</span><span class="o">.</span><span class="n">su1</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">sugar1</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">sugar2</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;mol&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">mol_yield</span> <span class="o">==</span> <span class="n">gen</span><span class="p">[</span><span class="s1">&#39;fact&#39;</span><span class="p">,</span><span class="s1">&#39;mol&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;sug&#39;</span><span class="p">]</span>
      <span class="n">m</span><span class="o">.</span><span class="n">su2</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">sugar2</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">ethanol1</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;eth&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">eth_yield</span> <span class="o">==</span> <span class="n">conv</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">,</span><span class="s1">&#39;dist&#39;</span><span class="p">,</span><span class="s1">&#39;eth&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">,</span><span class="s1">&#39;dist&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">conv</span><span class="p">[</span><span class="s1">&#39;mol&#39;</span><span class="p">,</span><span class="s1">&#39;dist&#39;</span><span class="p">,</span><span class="s1">&#39;eth&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;mol&#39;</span><span class="p">]</span>
      <span class="n">m</span><span class="o">.</span><span class="n">et1</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">ethanol1</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">el_prod</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;el-r&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">el_yield</span> <span class="o">==</span> <span class="n">Ca</span> <span class="o">*</span> <span class="mf">0.053</span> <span class="c1">#53 kWh produced per ton of sugarcane processes</span>
      <span class="n">m</span><span class="o">.</span><span class="n">el_produced</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">el_prod</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">el_sales</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;fre&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;reg&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;el-r&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">el_yield</span>
      <span class="n">m</span><span class="o">.</span><span class="n">electricity</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">el_sales</span><span class="p">)</span>

      <span class="c1">#Expected Profit</span>
      <span class="k">def</span><span class="w"> </span><span class="nf">profit</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">q</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">profit</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">==</span> <span class="n">sug_yield</span><span class="o">*</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;sug&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">hp</span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="s1">&#39;sug&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">eth_yield</span><span class="o">*</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;eth&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">hp</span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="s1">&#39;eth&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;fre&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">hp</span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="s1">&#39;fre&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;reg&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">price_reg</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">prodcost</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">saleable_products</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">profiteq</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">,</span> <span class="n">rule</span> <span class="o">=</span> <span class="n">profit</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">eprofit1</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">EP</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">N</span><span class="p">)</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">profit</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">ep1</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">eprofit1</span><span class="p">)</span>

      <span class="c1">#Product Revenues to be used in analysis</span>
      <span class="k">def</span><span class="w"> </span><span class="nf">sug_prof</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;sug&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">hp</span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="s1">&#39;sug&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">N</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">avg_sug_prof</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">sug_prof</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">eth_prof</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;eth&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">hp</span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="s1">&#39;eth&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">N</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">avg_eth_prof</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">eth_prof</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">el_prof</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;fre&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">hp</span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="s1">&#39;fre&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">N</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">avg_el_prof</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">el_prof</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;stoc&quot;</span><span class="p">:</span>
      <span class="n">reg_sugar_limit</span> <span class="o">=</span> <span class="mi">150000</span>
      <span class="n">reg_eth_limit</span> <span class="o">=</span> <span class="mi">120000</span>
      <span class="n">yield_range</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">)</span>
      <span class="n">mean_yield</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">m</span><span class="o">.</span><span class="n">SugarYieldSample</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">Reals</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">yield_range</span><span class="p">,</span> <span class="n">initialize</span> <span class="o">=</span> <span class="n">mean_yield</span><span class="p">)</span>



      <span class="c1"># PYOMO SETS</span>
      <span class="n">m</span><span class="o">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">resources</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">saleable_products</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">saleable_products</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">processes</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">processes</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">q</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">commodities</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">commodity</span><span class="p">)</span>

      <span class="n">m</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">N</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">resources</span><span class="p">,</span><span class="n">m</span><span class="o">.</span><span class="n">processes</span><span class="p">,</span> <span class="n">within</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
      <span class="c1"># VARIABLES</span>
      <span class="c1"># Positive Variables</span>
      <span class="c1"># First-Stage Decision Variables (Scenario-independent)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">x_bag</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">UnitInterval</span><span class="p">)</span>  <span class="c1"># Quantity of bagasse</span>
      <span class="n">m</span><span class="o">.</span><span class="n">x_jui</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">UnitInterval</span><span class="p">)</span>


      <span class="n">m</span><span class="o">.</span><span class="n">x_juiF</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">UnitInterval</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">x_juiD</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">UnitInterval</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">profit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">EP1</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">()</span>
      <span class="n">m</span><span class="o">.</span><span class="n">EP</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">()</span>

      <span class="n">initial_price_reg_sug</span> <span class="o">=</span> <span class="mi">800</span>
      <span class="n">initial_price_reg_eth</span> <span class="o">=</span> <span class="mi">770</span>
      <span class="n">price_reg_el</span> <span class="o">=</span> <span class="mf">72.5</span>
      <span class="n">m</span><span class="o">.</span><span class="n">price_reg_sug</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">initial_price_reg_sug</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">price_reg_eth</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">initial_price_reg_eth</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>

      <span class="n">m</span><span class="o">.</span><span class="n">costs</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">q_sugar_reg</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">within</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>  <span class="c1"># Sugar to regulated market</span>
      <span class="n">m</span><span class="o">.</span><span class="n">q_sugar_free</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>  <span class="c1"># Sugar to free market</span>
      <span class="n">m</span><span class="o">.</span><span class="n">q_eth_reg</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>    <span class="c1"># Ethanol to regulated market</span>
      <span class="n">m</span><span class="o">.</span><span class="n">q_eth_free</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>    <span class="c1"># Ethanol to free market</span>
      <span class="n">m</span><span class="o">.</span><span class="n">q_el_reg</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>      <span class="c1"># Electricity to regulated market</span>
      <span class="n">m</span><span class="o">.</span><span class="n">q_el_free</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>     <span class="c1"># Electricity to free market</span>
      <span class="n">m</span><span class="o">.</span><span class="n">q_mol</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>         <span class="c1"># Molasses produced</span>

      <span class="c1">#CONSTRAINTS</span>
      <span class="c1">#Superstructure</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">CoP</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">costs</span> <span class="o">==</span> <span class="p">(</span>
          <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_sugar_free</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">q_sugar_reg</span><span class="p">)</span> <span class="o">*</span> <span class="n">prodcost</span><span class="p">[</span><span class="s1">&#39;sug&#39;</span><span class="p">]</span> <span class="o">+</span>
          <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_eth_free</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">q_eth_reg</span><span class="p">)</span> <span class="o">*</span> <span class="n">prodcost</span><span class="p">[</span><span class="s1">&#39;eth&#39;</span><span class="p">]</span> <span class="o">+</span>
          <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_el_free</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">q_el_reg</span><span class="p">)</span> <span class="o">*</span> <span class="n">prodcost</span><span class="p">[</span><span class="s1">&#39;fre&#39;</span><span class="p">]</span>
      <span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">CoP</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">mass_balance</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">x_bag</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">x_jui</span> <span class="o">==</span> <span class="mi">1</span>
      <span class="n">m</span><span class="o">.</span><span class="n">mass_balance</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">mass_balance</span><span class="p">)</span>
      <span class="k">def</span><span class="w"> </span><span class="nf">juice_production</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">,</span> <span class="s1">&#39;mill&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">conv</span><span class="p">[</span><span class="s1">&#39;cane&#39;</span><span class="p">,</span> <span class="s1">&#39;mill&#39;</span><span class="p">,</span> <span class="s1">&#39;jui&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">Ca</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">x_jui</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">SugarYieldSample</span>
      <span class="n">m</span><span class="o">.</span><span class="n">juice_production</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">juice_production</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">bagasse_production</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;bag&#39;</span><span class="p">,</span> <span class="s1">&#39;mill&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">conv</span><span class="p">[</span><span class="s1">&#39;cane&#39;</span><span class="p">,</span> <span class="s1">&#39;mill&#39;</span><span class="p">,</span> <span class="s1">&#39;bag&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">Ca</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">x_bag</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">SugarYieldSample</span>
      <span class="n">m</span><span class="o">.</span><span class="n">bagasse_production</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">bagasse_production</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">juice1</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">x_jui</span> <span class="o">==</span> <span class="n">m</span><span class="o">.</span><span class="n">x_juiF</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">x_juiD</span>
      <span class="n">m</span><span class="o">.</span><span class="n">juiceeq1</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">juice1</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">juice_flow_fact</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">,</span> <span class="s1">&#39;fact&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">m</span><span class="o">.</span><span class="n">x_juiF</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">,</span> <span class="s1">&#39;mill&#39;</span><span class="p">]</span>
      <span class="n">m</span><span class="o">.</span><span class="n">juice_flow_fact</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">juice_flow_fact</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">capacity_fact</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">x_juiF</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">x_jui</span> <span class="o">*</span> <span class="n">Ca</span> <span class="o">&lt;=</span> <span class="n">max_cap</span><span class="p">[</span><span class="s1">&#39;fact&#39;</span><span class="p">]</span>
      <span class="n">m</span><span class="o">.</span><span class="n">capacity_fact</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">capacity_fact</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">juice_flow_dist</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">,</span> <span class="s1">&#39;dist&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">m</span><span class="o">.</span><span class="n">x_juiD</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">,</span> <span class="s1">&#39;mill&#39;</span><span class="p">]</span>
      <span class="n">m</span><span class="o">.</span><span class="n">juice_flow_dist</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">juice_flow_dist</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">juice25</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">,</span><span class="s1">&#39;fact&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_cap</span><span class="p">[</span><span class="s1">&#39;fact&#39;</span><span class="p">]</span>
      <span class="n">m</span><span class="o">.</span><span class="n">juiceeq25</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">juice25</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">capacity_dist</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">x_juiD</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">x_jui</span> <span class="o">*</span> <span class="n">Ca</span> <span class="o">&lt;=</span> <span class="n">max_cap</span><span class="p">[</span><span class="s1">&#39;dist&#39;</span><span class="p">]</span>
      <span class="n">m</span><span class="o">.</span><span class="n">capacity_dist</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">capacity_dist</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">juice35</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">,</span><span class="s1">&#39;dist&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_cap</span><span class="p">[</span><span class="s1">&#39;dist&#39;</span><span class="p">]</span>
      <span class="n">m</span><span class="o">.</span><span class="n">juiceeq35</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">juice35</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">sugar_production</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">q_sugar_reg</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">q_sugar_free</span> <span class="o">==</span> <span class="n">conv</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">,</span> <span class="s1">&#39;fact&#39;</span><span class="p">,</span> <span class="s1">&#39;sug&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">,</span> <span class="s1">&#39;fact&#39;</span><span class="p">]</span>
      <span class="n">m</span><span class="o">.</span><span class="n">sugar_production</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">sugar_production</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">sugar2</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">q_mol</span> <span class="o">==</span> <span class="n">gen</span><span class="p">[</span><span class="s1">&#39;fact&#39;</span><span class="p">,</span><span class="s1">&#39;mol&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_sugar_reg</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">q_sugar_free</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">su2</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">sugar2</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">sugar3</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">q_sugar_reg</span> <span class="o">&lt;=</span> <span class="mi">90000</span>
      <span class="n">m</span><span class="o">.</span><span class="n">su3</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">sugar3</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">ethanol_production</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">q_eth_reg</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">q_eth_free</span> <span class="o">==</span> <span class="p">(</span><span class="n">conv</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">,</span> <span class="s1">&#39;dist&#39;</span><span class="p">,</span> <span class="s1">&#39;eth&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">,</span> <span class="s1">&#39;dist&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">conv</span><span class="p">[</span><span class="s1">&#39;mol&#39;</span><span class="p">,</span> <span class="s1">&#39;dist&#39;</span><span class="p">,</span> <span class="s1">&#39;eth&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">q_mol</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">ethanol_production</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">ethanol_production</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">ethanol2</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">q_eth_reg</span> <span class="o">&lt;=</span> <span class="mi">77000</span>
      <span class="n">m</span><span class="o">.</span><span class="n">et2</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">ethanol2</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">el_prod</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">q_el_reg</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">q_el_free</span> <span class="o">==</span> <span class="n">Ca</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">SugarYieldSample</span> <span class="o">*</span> <span class="mf">0.053</span> <span class="c1">#53 kWh produced per ton of sugarcane processes</span>
      <span class="n">m</span><span class="o">.</span><span class="n">el_produced</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">el_prod</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">min_sugar_reg_sales</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">q_sugar_reg</span> <span class="o">&gt;=</span> <span class="mi">20000</span>
      <span class="n">m</span><span class="o">.</span><span class="n">min_sugar_reg_sales</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">min_sugar_reg_sales</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">min_eth_reg_sales</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">q_eth_reg</span> <span class="o">&gt;=</span> <span class="mi">20000</span>
      <span class="n">m</span><span class="o">.</span><span class="n">min_eth_reg_sales</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">min_eth_reg_sales</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">min_sugar_free_sales</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">q_sugar_free</span> <span class="o">&gt;=</span> <span class="mi">1000</span>
      <span class="n">m</span><span class="o">.</span><span class="n">min_sugar_free_sales</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">min_sugar_free_sales</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">min_eth_free_sales</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">q_eth_free</span> <span class="o">&gt;=</span> <span class="mi">1000</span>
      <span class="n">m</span><span class="o">.</span><span class="n">min_eth_free_sales</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">min_eth_free_sales</span><span class="p">)</span>

      <span class="n">M</span> <span class="o">=</span> <span class="mf">1e6</span>

      <span class="n">m</span><span class="o">.</span><span class="n">exceeds_sugar_limit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">Binary</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">exceeds_eth_limit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">Binary</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">sugar_limit_rule</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">q_sugar_reg</span> <span class="o">&lt;=</span> <span class="n">reg_sugar_limit</span> <span class="o">+</span> <span class="n">M</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">exceeds_sugar_limit</span>
      <span class="n">m</span><span class="o">.</span><span class="n">sugar_limit_constraint</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">sugar_limit_rule</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">sugar_over_limit_rule</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">q_sugar_reg</span> <span class="o">&gt;=</span> <span class="n">reg_sugar_limit</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">exceeds_sugar_limit</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">sugar_over_limit_constraint</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">sugar_over_limit_rule</span><span class="p">)</span>

        <span class="c1"># Add constraints to enforce binary variable logic for ethanol</span>
      <span class="k">def</span><span class="w"> </span><span class="nf">eth_limit_rule</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">q_eth_reg</span> <span class="o">&lt;=</span> <span class="n">reg_eth_limit</span> <span class="o">+</span> <span class="n">M</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">exceeds_eth_limit</span>
      <span class="n">m</span><span class="o">.</span><span class="n">eth_limit_constraint</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">eth_limit_rule</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">eth_over_limit_rule</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">q_eth_reg</span> <span class="o">&gt;=</span> <span class="n">reg_eth_limit</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">exceeds_eth_limit</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">eth_over_limit_constraint</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">eth_over_limit_rule</span><span class="p">)</span>

      <span class="c1">#Expected Profit</span>
      <span class="k">def</span><span class="w"> </span><span class="nf">profit</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
          <span class="n">sugar_reg_price</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">price_reg_sug</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">exceeds_sugar_limit</span><span class="p">)</span>
          <span class="n">ethanol_reg_price</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">price_reg_eth</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">exceeds_eth_limit</span><span class="p">)</span>
          <span class="n">revenue</span> <span class="o">=</span> <span class="p">(</span>
              <span class="n">m</span><span class="o">.</span><span class="n">q_sugar_free</span> <span class="o">*</span> <span class="n">hp</span><span class="p">[</span><span class="n">q</span><span class="p">,</span> <span class="s1">&#39;sug&#39;</span><span class="p">]</span> <span class="o">+</span>
              <span class="n">m</span><span class="o">.</span><span class="n">q_sugar_reg</span> <span class="o">*</span> <span class="n">sugar_reg_price</span> <span class="o">+</span>
              <span class="n">m</span><span class="o">.</span><span class="n">q_eth_free</span> <span class="o">*</span> <span class="n">hp</span><span class="p">[</span><span class="n">q</span><span class="p">,</span> <span class="s1">&#39;eth&#39;</span><span class="p">]</span> <span class="o">+</span>
              <span class="n">m</span><span class="o">.</span><span class="n">q_eth_reg</span> <span class="o">*</span> <span class="n">ethanol_reg_price</span> <span class="o">+</span>
              <span class="n">m</span><span class="o">.</span><span class="n">q_el_free</span> <span class="o">*</span> <span class="n">hp</span><span class="p">[</span><span class="n">q</span><span class="p">,</span> <span class="s1">&#39;fre&#39;</span><span class="p">]</span> <span class="o">+</span>
              <span class="n">m</span><span class="o">.</span><span class="n">q_el_reg</span> <span class="o">*</span> <span class="n">price_reg_el</span>
          <span class="p">)</span>
          <span class="n">cost</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">costs</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">profit</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">==</span> <span class="n">revenue</span> <span class="o">-</span> <span class="n">cost</span>
      <span class="n">m</span><span class="o">.</span><span class="n">profiteq</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">profit</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">eprofit1</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="n">total_profit</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">profit</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">)</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">EP</span> <span class="o">==</span> <span class="n">total_profit</span> <span class="o">/</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">ep2</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">eprofit1</span><span class="p">)</span>


      <span class="c1">#Product Revenues to be used in analysis</span>
      <span class="k">def</span><span class="w"> </span><span class="nf">sug_Fprof</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_sugar_free</span><span class="o">*</span><span class="n">hp</span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="s1">&#39;sug&#39;</span><span class="p">]</span>  <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">N</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">avg_sug_Fprof</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">sug_Fprof</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">eth_Fprof</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_eth_free</span><span class="o">*</span><span class="n">hp</span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="s1">&#39;eth&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">N</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">avg_eth_Fprof</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">eth_Fprof</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">sug_Rprof</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_sugar_reg</span><span class="o">*</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">price_reg_sug</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">exceeds_sugar_limit</span><span class="p">))</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">N</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">avg_sug_Rprof</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">sug_Rprof</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">eth_Rprof</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_eth_reg</span><span class="o">*</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">price_reg_eth</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">exceeds_eth_limit</span><span class="p">))</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">N</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">avg_eth_Rprof</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">eth_Rprof</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">el_prof</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_el_free</span><span class="o">*</span><span class="n">hp</span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="s1">&#39;fre&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">N</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">avg_el_prof</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">el_prof</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1">#PYOMO SETS</span>

      <span class="n">bin_width</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1541400</span><span class="o">/</span><span class="n">bin_count</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bin_count</span><span class="p">)]</span>
      <span class="n">bins</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bin_count</span><span class="p">)]</span>
      <span class="n">bin_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bin_count</span><span class="p">)]</span>

      <span class="n">m</span><span class="o">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">resources</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">saleable_products</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">saleable_products</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">processes</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">processes</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">q</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">commodities</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">commodity</span><span class="p">)</span>

      <span class="n">m</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">N</span><span class="p">)</span>

      <span class="c1">#VARIABLES</span>
      <span class="c1">#Positive Variables</span>
      <span class="n">m</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">resources</span><span class="p">,</span> <span class="n">within</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">resources</span><span class="p">,</span><span class="n">m</span><span class="o">.</span><span class="n">processes</span><span class="p">,</span> <span class="n">within</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span> <span class="c1">#For juice split point</span>
      <span class="n">m</span><span class="o">.</span><span class="n">profit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">EP</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">()</span>
      <span class="n">m</span><span class="o">.</span><span class="n">S_bins</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">bin_indices</span><span class="p">,</span><span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>

      <span class="c1"># Adding randomness in yield ranging from -20% to +20%</span>
      <span class="n">yield_factors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
      <span class="n">jui_yield</span><span class="p">,</span> <span class="n">bag_yield</span><span class="p">,</span> <span class="n">sug_yield</span><span class="p">,</span> <span class="n">mol_yield</span><span class="p">,</span> <span class="n">el_yield</span><span class="p">,</span> <span class="n">eth_yield</span> <span class="o">=</span> <span class="n">yield_factors</span>

      <span class="c1">#CONSTRAINTS</span>
      <span class="c1">#Superstructure Constraints</span>
      <span class="k">def</span><span class="w"> </span><span class="nf">mill1</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">jui_yield</span> <span class="o">==</span> <span class="n">Ca</span> <span class="o">*</span> <span class="n">conv</span><span class="p">[</span><span class="s1">&#39;cane&#39;</span><span class="p">,</span><span class="s1">&#39;mill&#39;</span><span class="p">,</span><span class="s1">&#39;jui&#39;</span><span class="p">]</span>
      <span class="n">m</span><span class="o">.</span><span class="n">milleq1</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">mill1</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">mill2</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;bag&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">bag_yield</span> <span class="o">==</span> <span class="n">Ca</span> <span class="o">*</span> <span class="n">conv</span><span class="p">[</span><span class="s1">&#39;cane&#39;</span><span class="p">,</span><span class="s1">&#39;mill&#39;</span><span class="p">,</span><span class="s1">&#39;bag&#39;</span><span class="p">]</span>
      <span class="n">m</span><span class="o">.</span><span class="n">milleq2</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">mill2</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">juice1</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">jui_yield</span> <span class="o">==</span> <span class="n">m</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">,</span><span class="s1">&#39;fact&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">,</span><span class="s1">&#39;dist&#39;</span><span class="p">]</span>
      <span class="n">m</span><span class="o">.</span><span class="n">juiceeq1</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">juice1</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">juice2</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">,</span><span class="s1">&#39;fact&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_cap</span><span class="p">[</span><span class="s1">&#39;fact&#39;</span><span class="p">]</span>
      <span class="n">m</span><span class="o">.</span><span class="n">juiceeq2</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">juice2</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">juice3</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">,</span><span class="s1">&#39;dist&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_cap</span><span class="p">[</span><span class="s1">&#39;dist&#39;</span><span class="p">]</span>
      <span class="n">m</span><span class="o">.</span><span class="n">juiceeq3</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">juice3</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">sugar1</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;sug&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">sug_yield</span> <span class="o">==</span> <span class="n">conv</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">,</span> <span class="s1">&#39;fact&#39;</span><span class="p">,</span> <span class="s1">&#39;sug&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">,</span><span class="s1">&#39;fact&#39;</span><span class="p">]</span>
      <span class="n">m</span><span class="o">.</span><span class="n">su1</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">sugar1</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">sugar2</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;mol&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">mol_yield</span> <span class="o">==</span> <span class="n">gen</span><span class="p">[</span><span class="s1">&#39;fact&#39;</span><span class="p">,</span><span class="s1">&#39;mol&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;sug&#39;</span><span class="p">]</span>
      <span class="n">m</span><span class="o">.</span><span class="n">su2</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">sugar2</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">ethanol1</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;eth&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">eth_yield</span> <span class="o">==</span> <span class="n">conv</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">,</span><span class="s1">&#39;dist&#39;</span><span class="p">,</span><span class="s1">&#39;eth&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;jui&#39;</span><span class="p">,</span><span class="s1">&#39;dist&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">conv</span><span class="p">[</span><span class="s1">&#39;mol&#39;</span><span class="p">,</span><span class="s1">&#39;dist&#39;</span><span class="p">,</span><span class="s1">&#39;eth&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;mol&#39;</span><span class="p">]</span>
      <span class="n">m</span><span class="o">.</span><span class="n">et1</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">ethanol1</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">el_prod</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;el-r&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">el_yield</span> <span class="o">==</span> <span class="n">Ca</span> <span class="o">*</span> <span class="mf">0.053</span> <span class="c1">#53 kWh produced per ton of sugarcane processes</span>
      <span class="n">m</span><span class="o">.</span><span class="n">el_produced</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">el_prod</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">el_sales</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;fre&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;reg&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;el-r&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">el_yield</span>
      <span class="n">m</span><span class="o">.</span><span class="n">electricity</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">el_sales</span><span class="p">)</span>

      <span class="c1"># sugar cane reformulation</span>
      <span class="k">def</span><span class="w"> </span><span class="nf">sugar_sum</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;sug&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">S_bins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bin_count</span><span class="p">))</span>
      <span class="n">m</span><span class="o">.</span><span class="n">sugar_tot_sum</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">sugar_sum</span><span class="p">)</span>

      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bin_count</span><span class="p">):</span>
          <span class="n">m</span><span class="o">.</span><span class="n">add_component</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;bin_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">_max&#39;</span><span class="p">,</span><span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">S_bins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">bin_width</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

      <span class="c1"># Cap on regulated electricity</span>
      <span class="k">def</span><span class="w"> </span><span class="nf">el_reg_cap</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;reg&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">100000</span>
      <span class="n">m</span><span class="o">.</span><span class="n">reg_cap</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">el_reg_cap</span><span class="p">)</span>

      <span class="c1">#Expected Profit</span>
      <span class="k">def</span><span class="w"> </span><span class="nf">profit</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">q</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">profit</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">==</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">S_bins</span><span class="p">[</span><span class="n">z</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">hp</span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="s1">&#39;sug&#39;</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">hp</span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="s1">&#39;sug&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">scale_hyp</span><span class="o">*</span><span class="mf">321.92</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">bin_count</span><span class="o">-</span><span class="n">z</span><span class="p">)</span><span class="o">/</span><span class="n">bin_count</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bin_count</span><span class="p">))</span> <span class="o">+</span> <span class="n">eth_yield</span><span class="o">*</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;eth&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">hp</span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="s1">&#39;eth&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;fre&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">hp</span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="s1">&#39;fre&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;reg&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">price_reg</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">prodcost</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">saleable_products</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">profiteq</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">,</span> <span class="n">rule</span> <span class="o">=</span> <span class="n">profit</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">eprofit1</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">EP</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">N</span><span class="p">)</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">profit</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">ep1</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">eprofit1</span><span class="p">)</span>

      <span class="c1">#Product Revenues to be used in analysis</span>
      <span class="k">def</span><span class="w"> </span><span class="nf">sug_prof</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">S_bins</span><span class="p">[</span><span class="n">z</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">hp</span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="s1">&#39;sug&#39;</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">hp</span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="s1">&#39;sug&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">/</span><span class="mi">3</span><span class="o">*</span><span class="mf">321.92</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">bin_count</span><span class="o">-</span><span class="n">z</span><span class="p">)</span><span class="o">/</span><span class="n">bin_count</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bin_count</span><span class="p">))</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">N</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">avg_sug_prof</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">sug_prof</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">eth_prof</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;eth&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">hp</span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="s1">&#39;eth&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">N</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">avg_eth_prof</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">eth_prof</span><span class="p">)</span>

      <span class="k">def</span><span class="w"> </span><span class="nf">el_prof</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
          <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;fre&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">hp</span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="s1">&#39;fre&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">N</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">avg_el_prof</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">el_prof</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">m</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="risk-measurement-equations">
<h2>Risk measurement equations<a class="headerlink" href="#risk-measurement-equations" title="Link to this heading">#</a></h2>
<p><strong>MV</strong> (Mean value)</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
MV = \sum_{i=1}^{n} \sum_{j=1}^{n} \sigma_{i,j} x_i x_j
\end{align*}\]</div>
<p><strong>MAD</strong> (Mean Absolute Deviation)</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
MAD = E \left[ \mid \sum_{j=1}^{n} R_j x_j -E \left[ \sum_{j=1}^{n} R_j x_j \right] \mid \right]
\end{align*}\]</div>
<p><strong>CVaR</strong> (Conditional Value-at-Risk)</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
VaR_{\beta} = \max V \\
s.t.  \sum_{j=1}^{N} 1 \left[ V - R_j \right] \leq (1-\beta)N
\end{align*}\]</div>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
CVaR_{\beta} = VaR_{\beta} - \frac{1}{(1-\beta)N}  \sum_{j=1}^{N} max \left[ 0, VaR_{\beta} - R_j \right]
\end{align*}\]</div>
</section>
<section id="implementing-a-new-scenario-model-supply-and-demand-and-government-caps">
<h2>Implementing a new scenario: model supply and demand and government caps<a class="headerlink" href="#implementing-a-new-scenario-model-supply-and-demand-and-government-caps" title="Link to this heading">#</a></h2>
<p>Say the historical prices are only averages and the true reality is that the market supply and demand curves are more active.  Specifically, this imiplies that the market prices provided are anchor prices, but the true profit a certain mill recieves is functionally dependent on the amount produced.</p>
<p>Generally, supply and demand curves can take any one of a variety of functional forms relating production/quantity and price, but for the sake of not repeating stale analysis, we primarily considered a linearly decreasing market price.  The actual total profit requires that the production curve be integrated from 0 to the amount produced, but this amount is unknown and dependent on the optimization, so pyomo cannot handle an implicit integration system- normally, this would require a lambda function-type code or a significant nondimensionalization reformatting.  Alternatively, the sale prices could be binned, with a more precise integral resulting from more bins (with the accompanying increase in computational cost from a larger number of variables).  This approach was utilized.  The bins used a left-side rule, so the bin approximation of a true integral is larger than a middle-point rule or the true integral itself, but this is more reasonable from a real-life scenario, since the maximum price in any real-life binning scenario would be applied to the top bin instead of some estimated median value.  The equation used is listed in the profit calculations section below.</p>
<p>There are 2 ways to initiate the model: either use the historical data as a middle point somewhere along the curve, or use the historical data as the demand cost for 1 unit.  We believe it is impossible to provide any practical justification for the former strategy, since it is unclear where along the curve that anchor should be placed without knowing how much will be produced.  We could use the previous optimization solution, but it is still unclear how aggressive to be in this design.  Since we are already designing the functions ourselves, we decided to focus any hypothetical on this.</p>
<p>We ensured that the market price is still positive for all values that could be produced using the mill capacity, but that if the mill produced too much sugar, it would start to lose money at some point.  The aggressiveness of this decay is a hyperparameter that effectively determines the floor price of sugar (which is named in our parameter set), though the effect on production of a more aggressive regime is easily deduced from the a baseline decay regime.</p>
<p>We also applied a maximum cap on the amount of electricity that could possibly go to the regulated market, assuming that some government regulation would limit the amount that could be sold there.  This is a farily simple change, but it does increase the considerations that the system must work with.</p>
</section>
<section id="system-description-model">
<h2>System Description/Model<a class="headerlink" href="#system-description-model" title="Link to this heading">#</a></h2>
<p><em><strong>Sets</strong></em></p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
r \in R: &amp;\ \text{Resources} \\
s \in S: &amp;\ \text{Saleable Products} \\
u \in U: &amp;\ \text{Process Units} \\
c \in C: &amp;\ \text{Commodities} \\
q \in Q: &amp;\ \text{Historical Price Scenarios} \\
b \in B: &amp;\ \text{Sugar in all Bins}
\end{align*}\]</div>
<p><em><strong>Parameters</strong></em></p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
Ca: Yearly\ production\ of\ sugarcane \\
\tau_{u}: Maximum\ capacity\ of\ process\ unit\ u \\
PC_{s}: Production\ cost\ of\ saleable\ product\ s \\
\theta_{f,u,p}: Conversion\ of\ resource\ f\ in\ process\ unit\ u\ to\ product\ p \\
\gamma_{u,p}: Generation\ of\ product\ p\ in\ unit\ u \\
HP_{q,c}: Historical\ Prices\ at\ price\ scenario\ q\\
\pi_{reg}: Price \ of \ electricity \ at \ the \ regulated \ market \\
\ n_{bins}: Number \ of \ integration \ bins \\
\ P_{floor}: Floor \ price \ of \ sugar \ cane \\
\ sug_{max}: Maximum \ amount \ of \ sugar \ produced \\
\end{align*}\]</div>
<p><em><strong>Variables</strong></em></p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
x_{p}: Amount\ of\ product\ p \\
profit_{q}: Profit\ for\ each\ historical\ price\ scenario\ q\\
Eprofit: Expected\ value\ of\ the\ profit \\
y_{b}: Amount \ of \ sugar \ in \ bin \ b
\end{align*}\]</div>
<p><em><strong>Constraints</strong></em></p>
<p><em>Mass Balances</em></p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
x_{jui} = Ca \cdot \theta_{cane,mill,jui} \\
x_{bag} = Ca \cdot \theta_{cane,mill,bag} \\
x_{jui} = x_{jui-fact} + x_{jui-dist} \\
x_{sug} = x_{jui-fact} \cdot \theta_{jui,fact,sug} \\
x_{mol} = x_{sug} \cdot \gamma_{mol,fact} \\
x_{eth} = x_{jui-dist} \cdot \theta_{jui,dist,eth} + x_{mol} \cdot \theta_{mol,dist,eth} \\
x_{reg} + x_{free} = x_{el-r} \\
\sum_{b \in B} y_{b} = x_{sug} \\
\ y_{b} \leq \frac{sug_{max}}{n_{bins}} \\
\end{align*}\]</div>
<p><strong>Additional Electricity Constraint</strong></p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
&amp; x_{el-r} \leq 100000 \ MWh \\
\end{align*}\]</div>
<p><strong>Profit Calculations</strong></p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
profit_{q} = \sum_{c \in C not sugar} x_{p} \cdot HP_{q,c} + f(x_{sug},HP_{q,sug}) + x_{reg} \cdot \pi_{reg} - \sum_{s \in S} x_{s} \cdot PC_{s} \ \ \forall \ \ q \in Q\\
f(x_{sug},HP_{q,sug}) = \sum_{b \in B} y_{b}*(HP_{q,sug} - (1-\frac{b}{n_{bins}})*(HP_{q,sug}- P_{floor}))\\
Eprofit = \frac{1}{Q} \sum_{q \in Q} profit_{q} \\
\end{align*}\]</div>
</section>
<section id="dof-analysis">
<h2>DOF Analysis<a class="headerlink" href="#dof-analysis" title="Link to this heading">#</a></h2>
<p><strong>Number of Variables</strong></p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
x_{p} \cdot 10 \ products \\
y_{b} \cdot n_{bins} \ bins\\
n_{bins} \cdot 1 \\
profit_{Q} \cdot Q \\
Eproft \cdot 1 \\
Total\ Variables = 10 + n_{bins} + 1 + Q + 1
\end{align*}\]</div>
<p><strong>Number of Constraints</strong></p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
7 \ mass \ balances \\
\ bin \ constraints \cdot n_{bins}\\
\ bin \ sum \cdot 1 \\
profit \ scenarios \cdot Q \\
Eproft \cdot 1 \\
Total\ Constraints = 7 + n_{bins} + 1 + Q + 1
\end{align*}\]</div>
<p><strong>DOF</strong></p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
DOF = Variables - Constraints \\
DOF = 10 + n_{bins} + 1 + Q + 1 - 7 - n_{bins} - 1 - Q - 1 \\
DOF = 3
\end{align*}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#Reload the base Model</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;s&amp;d&quot;</span><span class="p">)</span>

<span class="c1">#Drop the scenario number column</span>
<span class="n">price</span> <span class="o">=</span> <span class="n">df_hp</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">])</span>

<span class="c1">#Calculate Returns</span>
<span class="n">Returns</span> <span class="o">=</span> <span class="n">price</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">/</span><span class="n">price</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">covar</span> <span class="o">=</span> <span class="n">Returns</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Covariance Matrix&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">covar</span><span class="p">)</span>

<span class="c1">#Define MV as the objective</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mean_value</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">covar</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">commodities</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">commodities</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">mean_value</span><span class="p">,</span> <span class="n">sense</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">minimize</span><span class="p">)</span>

<span class="c1">#Solve the Model</span>
<span class="n">sol</span> <span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="s1">&#39;ipopt&#39;</span><span class="p">)</span>

<span class="n">sol</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Results&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Expected Profit&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;USD&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Ethanol Produced&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;eth&#39;</span><span class="p">]),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;m3&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sugar Produced&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;sug&#39;</span><span class="p">]),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;tonne&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Electricity Produced&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;el-r&#39;</span><span class="p">]),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;MWh&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Electricity to Free Market&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;fre&#39;</span><span class="p">]),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;MWh&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Electricity to Regulated Market&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;reg&#39;</span><span class="p">]),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;MWh&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Covariance Matrix
-------------------
          fre       sug       eth
fre  0.094993 -0.000350 -0.000756
sug -0.000350  0.000922  0.000390
eth -0.000756  0.000390  0.001578
Results
--------------------------------------
Expected Profit 38373444.1 USD
Ethanol Produced 151564.09 m3
Sugar Produced 151445.92 tonne
Electricity Produced 160620.53 MWh
Electricity to Free Market 59000.0 MWh
Electricity to Regulated Market 100000.0 MWh
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">final_EP</span><span class="p">,</span><span class="n">final_min</span><span class="p">,</span><span class="n">final_diff</span> <span class="o">=</span> <span class="n">profit_dist</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="s1">&#39;MV&#39;</span><span class="p">,</span><span class="n">final_EP</span><span class="p">,</span><span class="n">final_min</span><span class="p">,</span><span class="n">final_diff</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/5b14c297835ad2e4496745167968abc644fa74f14567772f0a6ac0cdaf5fc3ee.png" src="../../_images/5b14c297835ad2e4496745167968abc644fa74f14567772f0a6ac0cdaf5fc3ee.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Results
-------------------------------------
Expected Profit: 38.37 M USD
Minimum Profit: -32.64 M USD
Difference: 71.01 M USD
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">revenue_breakdown</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/8ded0d7b15a34399c2836d3fdff40add29006aaacc210f81ab635b4f40338687.png" src="../../_images/8ded0d7b15a34399c2836d3fdff40add29006aaacc210f81ab635b4f40338687.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#Reload the base Model</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;s&amp;d&quot;</span><span class="p">)</span>

<span class="c1">#Create set of return indicies</span>
<span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">m</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>

<span class="c1">#Create new variables</span>
<span class="n">m</span><span class="o">.</span><span class="n">y_aux</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">within</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">z_aux</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">within</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>

<span class="c1">#Constrain y - z to be the abs portion</span>
<span class="k">def</span><span class="w"> </span><span class="nf">aux_con</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">j</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">y_aux</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">z_aux</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">Returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="p">((</span><span class="mi">1</span><span class="o">/</span><span class="n">m</span><span class="o">.</span><span class="n">N</span><span class="p">)</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">Returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">J</span><span class="p">)))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">commodities</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">aux</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">rule</span> <span class="o">=</span> <span class="n">aux_con</span><span class="p">)</span>

<span class="c1">#Define MAD as the objective</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mad</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">1</span><span class="o">/</span><span class="n">m</span><span class="o">.</span><span class="n">N</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">y_aux</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">z_aux</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">J</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">mad</span><span class="p">,</span> <span class="n">sense</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">minimize</span><span class="p">)</span>

<span class="c1">#Solve the Model</span>
<span class="n">sol</span> <span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="s1">&#39;ipopt&#39;</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Results&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;------------------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Expected Profit&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;USD&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Ethanol Produced&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;eth&#39;</span><span class="p">]),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;m3&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sugar Produced&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;sug&#39;</span><span class="p">]),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;tonne&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Electricity Produced&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;el-r&#39;</span><span class="p">]),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;MWh&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Electricity to Free Market&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;fre&#39;</span><span class="p">]),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;MWh&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Electricity to Regulated Market&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;reg&#39;</span><span class="p">]),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;MWh&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Results
------------------------------
Expected Profit 11452693.54 USD
Ethanol Produced 196693.51 m3
Sugar Produced 182111.45 tonne
Electricity Produced 135856.58 MWh
Electricity to Free Market 59000.0 MWh
Electricity to Regulated Market 100000.0 MWh
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">final_EP</span><span class="p">,</span><span class="n">final_min</span><span class="p">,</span><span class="n">final_diff</span> <span class="o">=</span> <span class="n">profit_dist</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="s1">&#39;MAD&#39;</span><span class="p">,</span><span class="n">final_EP</span><span class="p">,</span><span class="n">final_min</span><span class="p">,</span><span class="n">final_diff</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/721e90bcef0127411f1be154216b3401d490f86dd4196eb13cc6dad9f2c2b582.png" src="../../_images/721e90bcef0127411f1be154216b3401d490f86dd4196eb13cc6dad9f2c2b582.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Results
-------------------------------------
Expected Profit: 11.45 M USD
Minimum Profit: -64.31 M USD
Difference: 75.77 M USD
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">revenue_breakdown</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/94ef967c3486ac7634a0d6cdbb5d7b92e1f372f04390210df15e47c5a0a89335.png" src="../../_images/94ef967c3486ac7634a0d6cdbb5d7b92e1f372f04390210df15e47c5a0a89335.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#Reload the base Model</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;s&amp;d&quot;</span><span class="p">)</span>

<span class="c1">#Add parameters</span>
<span class="n">beta</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="c1">#confidence interval</span>

<span class="c1">#Add variables</span>
<span class="n">m</span><span class="o">.</span><span class="n">shortfall</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">()</span>
<span class="n">m</span><span class="o">.</span><span class="n">CVaR</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">()</span>

<span class="c1">#Add CVaR Constraints</span>
<span class="k">def</span><span class="w"> </span><span class="nf">CVaR1</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">CVaR</span> <span class="o">==</span> <span class="n">m</span><span class="o">.</span><span class="n">alpha</span> <span class="o">-</span> <span class="p">((</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">N</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">beta</span><span class="p">)))</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">shortfall</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">))</span>
<span class="n">m</span><span class="o">.</span><span class="n">cvar1eq</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">CVaR1</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">CVaR2</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">q</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">shortfall</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span>
<span class="n">m</span><span class="o">.</span><span class="n">cvar2eq</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">,</span> <span class="n">rule</span> <span class="o">=</span> <span class="n">CVaR2</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">CVaR4</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">q</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">profit</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">shortfall</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">alpha</span> <span class="o">&gt;=</span> <span class="mi">0</span>
<span class="n">m</span><span class="o">.</span><span class="n">cvar4eq</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">,</span> <span class="n">rule</span> <span class="o">=</span> <span class="n">CVaR4</span><span class="p">)</span>

<span class="c1">#OBJECTIVE</span>
<span class="k">def</span><span class="w"> </span><span class="nf">obj_rule</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">CVaR</span>
<span class="n">m</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">obj_rule</span><span class="p">,</span> <span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">maximize</span><span class="p">)</span>

<span class="c1">#Solve the Model</span>
<span class="n">sol</span> <span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="s1">&#39;ipopt&#39;</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Results&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;------------------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Expected Profit&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;USD&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Ethanol Produced&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;eth&#39;</span><span class="p">]),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;m3&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sugar Produced&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;sug&#39;</span><span class="p">]),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;tonne&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Electricity Produced&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;el-r&#39;</span><span class="p">]),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;MWh&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Electricity to Free Market&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;fre&#39;</span><span class="p">]),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;MWh&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Electricity to Regulated Market&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;reg&#39;</span><span class="p">]),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;MWh&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:pyomo.core:Loading a SolverResults object with a warning status into model.name=&quot;unknown&quot;;
  - termination condition: infeasible
  - message from solver: Ipopt 3.13.2\x3a Converged to a locally infeasible point. Problem may be infeasible.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Results
------------------------------
Expected Profit -1187931.9 USD
Ethanol Produced 1136.87 m3
Sugar Produced 114923.73 tonne
Electricity Produced 152404.67 MWh
Electricity to Free Market 10622.36 MWh
Electricity to Regulated Market 148377.64 MWh
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">final_EP</span><span class="p">,</span><span class="n">final_min</span><span class="p">,</span><span class="n">final_diff</span> <span class="o">=</span> <span class="n">profit_dist</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="s1">&#39;MCVaR&#39;</span><span class="p">,</span><span class="n">final_EP</span><span class="p">,</span><span class="n">final_min</span><span class="p">,</span><span class="n">final_diff</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/ce24662c2b3100978ba7ab96cfb8679a205d0b20233093ce812d54dd7262e037.png" src="../../_images/ce24662c2b3100978ba7ab96cfb8679a205d0b20233093ce812d54dd7262e037.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Results
-------------------------------------
Expected Profit: -1.19 M USD
Minimum Profit: -4.69 M USD
Difference: 3.5 M USD
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">revenue_breakdown</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/f585b0a2c670e0cc89df6ce44db56c5a1ef790588432f029d731e3494fb097e4.png" src="../../_images/f585b0a2c670e0cc89df6ce44db56c5a1ef790588432f029d731e3494fb097e4.png" />
</div>
</div>
</section>
<section id="summarizing-what-happened">
<h2>Summarizing what happened<a class="headerlink" href="#summarizing-what-happened" title="Link to this heading">#</a></h2>
<p>It isnât always easy to see what happened differently, but compared to the results returned by the original notebook (the source material linked at the top of this notebook), there are a few things to note.  First, the amount of profit from Sugar sold to market decreased significantly using the MAD objective, but not the MV objective.  This suggests the difference in priority carries over between targets, but sugar profit still becomes capped and affects the overall portfolio in certain circumstances.  Second, as expected the electricity to the free market increases to compensate for the regulated market cap.  Nothing particularly special there, but it is a good sanity check that the algorithm is functioning as intended.  Finally, it should be noted that profit is down overall for all metrics- as expected.
For a better visualization of how these results change, one only needs to change the model specification for a given objective and re-run the code.</p>
</section>
<section id="implementing-a-new-scenario-stochastic-modeling">
<h2>Implementing a new scenario: Stochastic Modeling<a class="headerlink" href="#implementing-a-new-scenario-stochastic-modeling" title="Link to this heading">#</a></h2>
<p>The true market landscape is more complex than what is depicted in the original model, influenced by both production decisions and regulatory constraints. This is particularly evident in the commitment to the ratio of juice to bagasse, a key feature that was absent in the previous model. In the old model, we assumed flexibility in how the production process allocated sugarcane between juice and bagasse, but in reality, this ratio is often fixed. This commitment limits operational choices and requires a more careful balance in production planning, as optimizing one part of the process (such as juice) directly affects the availability of resources for others (like bagasse).</p>
<p>Additionally, the new model introduces more marketsâboth free and regulatedâwhich operate under distinct pricing schemes. Free markets fluctuate based on supply and demand, while regulated markets are constrained by set prices and government-imposed caps on how much can be sold. By imposing constraints on both free and regulated markets, we can better capture the practical challenges that businesses face. For instance, surpassing the regulatory limit on sugar or ethanol sales can lead to reduced prices, which the model now reflects through binary variables. These variables allow for price adjustments when production exceeds regulatory thresholds, making the model more responsive to real-world market conditions.</p>
<p><em><strong>Sets</strong></em></p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
r \in R: &amp;\ \text{Resources} \\
s \in S: &amp;\ \text{Saleable Products} \\
u \in U: &amp;\ \text{Process Units} \\
c \in C: &amp;\ \text{Commodities} \\
q \in Q: &amp;\ \text{Historical Price Scenarios}
\end{align*}\]</div>
<p><em><strong>Parameters</strong></em></p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
Ca &amp;: \text{Annual sugarcane capacity} \\
\beta &amp;: \text{Confidence level for CVaR formulation} \\
\pi^{\text{reg}}_{\text{el}} &amp;: \text{Price of electricity sold to the regulated market} \\
\omega_{sug} &amp;: \text{Regulated sugar market limit} \\
\omega_{eth} &amp;: \text{Regulated ethanol market limit} \\
\theta_{r,u,k} &amp;: \text{Conversion factor from resource } r \text{ in process } u \text{ to resource } k \\
\gamma_{u,k} &amp;: \text{Generation factor of resource } k \text{ in process } u \\
\tau_u &amp;: \text{Maximum capacity of process unit } u \\
PC_s &amp;: \text{Production cost of saleable product } s \\
HP_{q,c} &amp;: \text{Historical price at scenario } q \text{ for commodity } c \\
\pi^{\text{reg}}_{\text{sug}, q} &amp;: \text{Price of sugar in regulated market at scenario } q \\
\pi^{\text{reg}}_{\text{eth}, q} &amp;: \text{Price of ethanol in regulated market at scenario } q \\
M &amp;: \text{A large constant for binary constraints (e.g., } 1 \times 10^6\text{)}
\end{align*}\]</div>
<p><em><strong>Variables</strong></em></p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
\rho &amp;: \text{Random variable representing sugar yield sample} \\
r_{k,u} &amp;: \text{Amount of resource } k \text{ in process } u \\
x_{\text{bag}} &amp;: \text{Fraction of bagasse} \\
x_{\text{jui}} &amp;: \text{Fraction of juice} \\
x_{\text{juiF}} &amp;: \text{Fraction of juice sent to factory} \\
x_{\text{juiD}} &amp;: \text{Fraction of juice sent to distillery} \\
q_{\text{sugar\_reg}} &amp;: \text{Quantity of sugar to regulated market} \\
q_{\text{sugar\_free}} &amp;: \text{Quantity of sugar to free market} \\
q_{\text{eth\_reg}} &amp;: \text{Quantity of ethanol to regulated market} \\
q_{\text{eth\_free}} &amp;: \text{Quantity of ethanol to free market} \\
q_{\text{el\_reg}} &amp;: \text{Quantity of electricity to regulated market} \\
q_{\text{el\_free}} &amp;: \text{Quantity of electricity to free market} \\
q_{\text{mol}} &amp;: \text{Quantity of molasses produced} \\
\psi_{sug} &amp;: \text{Indicator variable indicating if sugar sales exceed regulated limit} \\
\psi_{eth} &amp;: \text{Indicator variable indicating if ethanol sales exceed regulated limit} \\
\text{profit}_q &amp;: \text{Profit at scenario } q \\
EP &amp;: \text{Expected profit} \\
\text{costs} &amp;: \text{Total production costs}
\end{align*}\]</div>
<p><em><strong>Constraints</strong></em></p>
<p><strong>Cost of Production</strong></p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
\text{costs} = &amp;\ (q_{\text{sugar\_free}} + q_{\text{sugar\_reg}}) \cdot PC_{\text{sug}} \\
&amp;+ (q_{\text{eth\_free}} + q_{\text{eth\_reg}}) \cdot PC_{\text{eth}} \\
&amp;+ (q_{\text{el\_free}} + q_{\text{el\_reg}}) \cdot PC_{\text{fre}}
\end{align*}\]</div>
<p><strong>Mass Balances</strong></p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
&amp;x_{\text{bag}} + x_{\text{jui}} = 1 \\
&amp;r_{\text{jui}, \text{mill}} = \theta_{\text{cane}, \text{mill}, \text{jui}} \cdot Ca \cdot x_{\text{jui}} \cdot \rho \\
&amp;r_{\text{bag}, \text{mill}} = \theta_{\text{cane}, \text{mill}, \text{bag}} \cdot Ca \cdot x_{\text{bag}} \cdot \rho \\
&amp;x_{\text{jui}} = x_{\text{juiF}} + x_{\text{juiD}} \\
&amp;r_{\text{jui}, \text{fact}} = x_{\text{juiF}} \cdot r_{\text{jui}, \text{mill}} \\
&amp;r_{\text{jui}, \text{dist}} = x_{\text{juiD}} \cdot r_{\text{jui}, \text{mill}} \\
&amp;x_{\text{juiF}} \cdot x_{\text{jui}} \cdot Ca \leq \tau_{\text{fact}} \\
&amp;x_{\text{juiD}} \cdot x_{\text{jui}} \cdot Ca \leq \tau_{\text{dist}} \\
&amp;q_{\text{sugar\_reg}} + q_{\text{sugar\_free}} = \theta_{\text{jui}, \text{fact}, \text{sug}} \cdot r_{\text{jui}, \text{fact}} \\
&amp;q_{\text{mol}} = \gamma_{\text{fact}, \text{mol}} \cdot (q_{\text{sugar\_reg}} + q_{\text{sugar\_free}}) \\
&amp;q_{\text{eth\_reg}} + q_{\text{eth\_free}} = \theta_{\text{jui}, \text{dist}, \text{eth}} \cdot r_{\text{jui}, \text{dist}} + \theta_{\text{mol}, \text{dist}, \text{eth}} \cdot q_{\text{mol}} \\
&amp;q_{\text{el\_reg}} + q_{\text{el\_free}} = Ca \cdot \rho \cdot 0.053
\end{align*}\]</div>
<p><strong>Minimum and Maximum Sales Constraints</strong></p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
&amp;20000 \leq q_{\text{sugar\_reg}} \leq 90000 \\
&amp;20000 \leq q_{\text{eth\_reg}} \leq 77000 \\
&amp;q_{\text{sugar\_free}} \geq 1000 \\
&amp;q_{\text{eth\_free}} \geq 1000
\end{align*}\]</div>
<p><strong>Profit Calculations</strong></p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
\text{profit}_q = &amp;\ q_{\text{sugar\_free}} \cdot HP_{q, \text{sug}} + q_{\text{sugar\_reg}} \cdot \pi^{\text{reg}}_{\text{sug}, q} \cdot (1 - 0.5 \cdot \psi_{sug}) \\
&amp;+ q_{\text{eth\_free}} \cdot HP_{q, \text{eth}} + q_{\text{eth\_reg}} \cdot \pi^{\text{reg}}_{\text{eth}, q} \cdot (1 - 0.5 \cdot \psi_{eth}) \\
&amp;+ q_{\text{el\_free}} \cdot HP_{q, \text{fre}} + q_{\text{el\_reg}} \cdot \pi^{\text{reg}}_{\text{el}} - \sum_{s \in S} x_{s} \cdot PC_{s} \ \ \forall \ \ q \in Q\\
EP = &amp;\ \frac{1}{N} \sum_{q \in Q} \text{profit}_q
\end{align*}\]</div>
<p><strong>Number of Variables</strong></p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
x_{p} \cdot 14 \ products \\
profit_{Q} \cdot Q \\
Eproft \cdot 1 \\
Total\ Variables = 12 + Q + 1
\end{align*}\]</div>
<p><strong>Number of Constraints</strong></p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
12 \ mass \ balances \\
profit \ scenarios \cdot Q \\
Eproft \cdot 1 \\
Total\ Constraints = 12 + Q + 1
\end{align*}\]</div>
<p><strong>DOF</strong></p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
DOF = Variables - Constraints \\
DOF = 14 + Q + 1 - 12 - Q - 1 \\
DOF = 2
\end{align*}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#Load the base model from the function created above</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;stoc&quot;</span><span class="p">)</span>

<span class="c1">#Set the objective to maximize the expected value of the profit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">obj_rule</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">EP</span>
<span class="n">m</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">obj_rule</span><span class="p">,</span> <span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">maximize</span><span class="p">)</span>
<span class="c1">#Solve the Model</span>
<span class="n">sol</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="s1">&#39;bonmin&#39;</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">sol</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Results&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;----------------------------------------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Expected Profit&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">obj</span><span class="p">),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;USD&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Sugar to Regulated Market: </span><span class="si">{</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_sugar_reg</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Sugar to Free Market: </span><span class="si">{</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_sugar_free</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Ethanol to Regulated Market: </span><span class="si">{</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_eth_reg</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Ethanol to Free Market: </span><span class="si">{</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_eth_free</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Electricity to Free Market: </span><span class="si">{</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_el_free</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Electricity to Regulated Market: </span><span class="si">{</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_el_reg</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Results
----------------------------------------------------
Expected Profit 88177260.07 USD
  Sugar to Regulated Market: 19999.9998
  Sugar to Free Market: 169129.78209129782
  Ethanol to Regulated Market: 19999.9998
  Ethanol to Free Market: 243048.3211674899
  Electricity to Free Market: 222600.00222601
  Electricity to Regulated Market: 0.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#Collect the profit distribution</span>
<span class="n">profits</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">:</span>
    <span class="n">profits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">profit</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

<span class="c1">#Collect the minimum profit</span>
<span class="n">min_prof</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">profits</span><span class="p">)</span>

<span class="c1">#Plot the Profit Distribution</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">profits</span><span class="p">),</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">ymin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">ymax</span><span class="o">=</span> <span class="mi">160</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">obj</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Expected Profit&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">ymin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="mi">160</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">min_prof</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Minimum Profit&#39;</span><span class="p">),</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;profit$_q$ M USD&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Results&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Expected Profit:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">obj</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;M USD&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Minimum Profit:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">min_prof</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;M USD&#39;</span><span class="p">)</span>
<span class="n">difference</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">obj</span><span class="p">)</span> <span class="o">-</span> <span class="n">min_prof</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Difference:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">difference</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;M USD&#39;</span><span class="p">)</span>

<span class="c1">#Collect Results for Conclusion</span>
<span class="n">final_EP</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">final_min</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">final_diff</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">final_EP</span><span class="p">[</span><span class="s1">&#39;No Risk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">obj</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span>
<span class="n">final_min</span><span class="p">[</span><span class="s1">&#39;No Risk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_prof</span><span class="o">/</span><span class="mf">1e6</span>
<span class="n">final_diff</span><span class="p">[</span><span class="s1">&#39;No Risk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">difference</span><span class="o">/</span><span class="mf">1e6</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/81d81b44fdf5de378909c2eac562ef2959e6088dd7d902f7cdf85d526c460bed.png" src="../../_images/81d81b44fdf5de378909c2eac562ef2959e6088dd7d902f7cdf85d526c460bed.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Results
-------------------------------------
Expected Profit: 88.18 M USD
Minimum Profit: -41.95 M USD
Difference: 130.13 M USD
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Sugar </span><span class="se">\n</span><span class="s1"> Free </span><span class="se">\n</span><span class="s1"> Market&#39;</span><span class="p">,</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">avg_sug_Fprof</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Sugar </span><span class="se">\n</span><span class="s1"> Regulated </span><span class="se">\n</span><span class="s1"> Market&#39;</span><span class="p">,</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">avg_sug_Rprof</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Ethanol </span><span class="se">\n</span><span class="s1"> Free </span><span class="se">\n</span><span class="s1"> Market&#39;</span><span class="p">,</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">avg_eth_Fprof</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Ethanol </span><span class="se">\n</span><span class="s1"> Regulated </span><span class="se">\n</span><span class="s1"> Market&#39;</span><span class="p">,</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">avg_eth_Rprof</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Electricity </span><span class="se">\n</span><span class="s1"> Free </span><span class="se">\n</span><span class="s1"> Market&#39;</span><span class="p">,</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">avg_el_prof</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Electricity </span><span class="se">\n</span><span class="s1"> Regulated </span><span class="se">\n</span><span class="s1"> Market&#39;</span><span class="p">,</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_el_reg</span><span class="p">)</span><span class="o">*</span><span class="mf">72.5</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Product&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Revenue from </span><span class="se">\n</span><span class="s1"> Each Profit (USD)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/2466e38311f66d3edfc8cca3c60d49d2ae552ef91b82589b3ccc74e194a53ad2.png" src="../../_images/2466e38311f66d3edfc8cca3c60d49d2ae552ef91b82589b3ccc74e194a53ad2.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#Calculate the Covariance Matrix</span>

<span class="c1">#Drop the scenario number column</span>
<span class="n">price</span> <span class="o">=</span> <span class="n">df_hp</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">])</span>

<span class="c1">#Calculate Returns</span>
<span class="n">Returns</span> <span class="o">=</span> <span class="n">price</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">/</span><span class="n">price</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">covar</span> <span class="o">=</span> <span class="n">Returns</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Covariance Matrix&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">covar</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Covariance Matrix
-------------------
          fre       sug       eth
fre  0.094993 -0.000350 -0.000756
sug -0.000350  0.000922  0.000390
eth -0.000756  0.000390  0.001578
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#Reload the base Model</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;stoc&quot;</span><span class="p">)</span>

<span class="c1">#Define MV as the objective</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mean_value</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="c1"># Assume covar is the covariance matrix dataframe</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_sugar_free</span> <span class="o">*</span> <span class="n">covar</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;sug&#39;</span><span class="p">,</span> <span class="s1">&#39;eth&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">q_eth_free</span><span class="p">)</span> <span class="o">+</span>
        <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_sugar_free</span> <span class="o">*</span> <span class="n">covar</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;sug&#39;</span><span class="p">,</span> <span class="s1">&#39;fre&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">q_el_free</span><span class="p">)</span> <span class="o">+</span>
        <span class="mi">2</span> <span class="o">*</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_eth_free</span> <span class="o">*</span> <span class="n">covar</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;eth&#39;</span><span class="p">,</span> <span class="s1">&#39;fre&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">q_el_free</span><span class="p">)</span>
    <span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">mean_value</span><span class="p">,</span> <span class="n">sense</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">minimize</span><span class="p">)</span>

<span class="c1">#Solve the Model</span>
<span class="n">sol</span> <span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="s1">&#39;bonmin&#39;</span><span class="p">,</span> <span class="n">tee</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="n">sol</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Results&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Expected Profit&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;USD&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sugar to Regulated Market: </span><span class="si">{</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_sugar_reg</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sugar to Free Market: </span><span class="si">{</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_sugar_free</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ethanol to Regulated Market: </span><span class="si">{</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_eth_reg</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ethanol to Free Market: </span><span class="si">{</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_eth_free</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Electricity to Free Market: </span><span class="si">{</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_el_free</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Electricity to Regulated Market: </span><span class="si">{</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_el_reg</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Results
--------------------------------------
Expected Profit 55668301.76 USD
Sugar to Regulated Market: 90000.0009
Sugar to Free Market: 18074.16018074838
Ethanol to Regulated Market: 19999.9998
Ethanol to Free Market: 292292.4480869271
Electricity to Free Market: 222600.00222601
Electricity to Regulated Market: 0.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#Reload the base Model</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;stoc&quot;</span><span class="p">)</span>

<span class="c1">#Define MV as the objective</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mean_value</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="c1"># Assume covar is the covariance matrix dataframe</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_sugar_free</span> <span class="o">*</span> <span class="n">covar</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;sug&#39;</span><span class="p">,</span> <span class="s1">&#39;eth&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">q_eth_free</span><span class="p">)</span> <span class="o">+</span>
        <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_sugar_free</span> <span class="o">*</span> <span class="n">covar</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;sug&#39;</span><span class="p">,</span> <span class="s1">&#39;fre&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">q_el_free</span><span class="p">)</span> <span class="o">+</span>
        <span class="mi">2</span> <span class="o">*</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_eth_free</span> <span class="o">*</span> <span class="n">covar</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;eth&#39;</span><span class="p">,</span> <span class="s1">&#39;fre&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">q_el_free</span><span class="p">)</span>
    <span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">rule</span> <span class="o">=</span> <span class="n">mean_value</span><span class="p">,</span> <span class="n">sense</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">minimize</span><span class="p">)</span>

<span class="c1">#Solve the Model</span>
<span class="n">sol</span> <span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="s1">&#39;bonmin&#39;</span><span class="p">,</span> <span class="n">tee</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="n">sol</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Results&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Expected Profit&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;USD&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sugar to Regulated Market: </span><span class="si">{</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_sugar_reg</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sugar to Free Market: </span><span class="si">{</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_sugar_free</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ethanol to Regulated Market: </span><span class="si">{</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_eth_reg</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ethanol to Free Market: </span><span class="si">{</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_eth_free</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Electricity to Free Market: </span><span class="si">{</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_el_free</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Electricity to Regulated Market: </span><span class="si">{</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_el_reg</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Results
--------------------------------------
Expected Profit 39008019.39 USD
Sugar to Regulated Market: 90000.0009
Sugar to Free Market: 18074.16018074838
Ethanol to Regulated Market: 19999.9998
Ethanol to Free Market: 292292.4480869271
Electricity to Free Market: 222600.00222601
Electricity to Regulated Market: 0.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#Collect the profit distribution</span>
<span class="n">profits</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">:</span>
    <span class="n">profits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">profit</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

<span class="c1">#Collect the minimum profit</span>
<span class="n">min_prof</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">profits</span><span class="p">)</span>

<span class="c1">#Plot the Profit Distribution</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">profits</span><span class="p">),</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">ymin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">ymax</span><span class="o">=</span> <span class="mi">160</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Expected Profit&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">ymin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="mi">160</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">min_prof</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Minimum Profit&#39;</span><span class="p">),</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;profit$_q$ M USD&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Results&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Expected Profit:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;M USD&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Minimum Profit:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">min_prof</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;M USD&#39;</span><span class="p">)</span>
<span class="n">difference</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">)</span> <span class="o">-</span> <span class="n">min_prof</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Difference:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">difference</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;M USD&#39;</span><span class="p">)</span>

<span class="n">final_EP</span><span class="p">[</span><span class="s1">&#39;MV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">obj</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span>
<span class="n">final_min</span><span class="p">[</span><span class="s1">&#39;MV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_prof</span><span class="o">/</span><span class="mf">1e6</span>
<span class="n">final_diff</span><span class="p">[</span><span class="s1">&#39;MV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">difference</span><span class="o">/</span><span class="mf">1e6</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/c7c6b4944afea99c5b03f5df427aeae6eeeed0f03615f6aaf7a275898327016e.png" src="../../_images/c7c6b4944afea99c5b03f5df427aeae6eeeed0f03615f6aaf7a275898327016e.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Results
-------------------------------------
Expected Profit: 39.01 M USD
Minimum Profit: -69.71 M USD
Difference: 108.72 M USD
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Sugar </span><span class="se">\n</span><span class="s1"> Free </span><span class="se">\n</span><span class="s1"> Market&#39;</span><span class="p">,</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">avg_sug_Fprof</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Sugar </span><span class="se">\n</span><span class="s1"> Regulated </span><span class="se">\n</span><span class="s1"> Market&#39;</span><span class="p">,</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">avg_sug_Rprof</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Ethanol </span><span class="se">\n</span><span class="s1"> Free </span><span class="se">\n</span><span class="s1"> Market&#39;</span><span class="p">,</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">avg_eth_Fprof</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Ethanol </span><span class="se">\n</span><span class="s1"> Regulated </span><span class="se">\n</span><span class="s1"> Market&#39;</span><span class="p">,</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">avg_eth_Rprof</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Electricity </span><span class="se">\n</span><span class="s1"> Free </span><span class="se">\n</span><span class="s1"> Market&#39;</span><span class="p">,</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">avg_el_prof</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Electricity </span><span class="se">\n</span><span class="s1"> Regulated </span><span class="se">\n</span><span class="s1"> Market&#39;</span><span class="p">,</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_el_reg</span><span class="p">)</span><span class="o">*</span><span class="mf">72.5</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Product&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Revenue from </span><span class="se">\n</span><span class="s1"> Each Profit (USD)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/26a1a117a4a4646d3117ded13123b8d0ef3062b2c3bd9eeffdf1083eb2bb5b45.png" src="../../_images/26a1a117a4a4646d3117ded13123b8d0ef3062b2c3bd9eeffdf1083eb2bb5b45.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#Reload the base Model</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;stoc&quot;</span><span class="p">)</span>

<span class="c1">#Create set of return indicies</span>
<span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">m</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>

<span class="c1">#Create new variables</span>
<span class="n">m</span><span class="o">.</span><span class="n">y_aux</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">within</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">z_aux</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">within</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>

<span class="c1">#Constrain y - z to be the abs portion</span>
<span class="k">def</span><span class="w"> </span><span class="nf">aux_con</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">y_aux</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">z_aux</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span>
        <span class="n">m</span><span class="o">.</span><span class="n">q_sugar_free</span> <span class="o">*</span> <span class="p">(</span><span class="n">Returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="s1">&#39;sug&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">m</span><span class="o">.</span><span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="n">Returns</span><span class="p">[</span><span class="s1">&#39;sug&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">+</span>
        <span class="n">m</span><span class="o">.</span><span class="n">q_eth_free</span> <span class="o">*</span> <span class="p">(</span><span class="n">Returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="s1">&#39;eth&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">m</span><span class="o">.</span><span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="n">Returns</span><span class="p">[</span><span class="s1">&#39;eth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">+</span>
        <span class="n">m</span><span class="o">.</span><span class="n">q_el_free</span> <span class="o">*</span> <span class="p">(</span><span class="n">Returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="s1">&#39;fre&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">m</span><span class="o">.</span><span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="n">Returns</span><span class="p">[</span><span class="s1">&#39;fre&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    <span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">aux_constraint</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">aux_con</span><span class="p">)</span>

<span class="c1">#Define MAD as the objective</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mad</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">m</span><span class="o">.</span><span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">y_aux</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">z_aux</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">J</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">mad</span><span class="p">,</span> <span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">minimize</span><span class="p">)</span>

<span class="c1">#Solve the Model</span>
<span class="n">sol</span> <span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="s1">&#39;bonmin&#39;</span><span class="p">,</span> <span class="n">tee</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Results&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;------------------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Expected Profit&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">),</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;USD&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sugar to Regulated Market: </span><span class="si">{</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_sugar_reg</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sugar to Free Market: </span><span class="si">{</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_sugar_free</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ethanol to Regulated Market: </span><span class="si">{</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_eth_reg</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ethanol to Free Market: </span><span class="si">{</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_eth_free</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Electricity to Free Market: </span><span class="si">{</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_el_free</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Electricity to Regulated Market: </span><span class="si">{</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_el_reg</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Results
------------------------------
Expected Profit 8170171.51 USD
Sugar to Regulated Market: 20328.041043691588
Sugar to Free Market: 999.9999900006177
Ethanol to Regulated Market: 20227.029833779416
Ethanol to Free Market: 999.9999900004543
Electricity to Free Market: 7.378656985065415
Electricity to Regulated Market: 106808.29162836997
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#Collect the profit distribution</span>
<span class="n">profits</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">:</span>
    <span class="n">profits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">profit</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

<span class="c1">#Collect the minimum profit</span>
<span class="n">min_prof</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">profits</span><span class="p">)</span>

<span class="c1">#Plot the Profit Distribution</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">profits</span><span class="p">),</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">ymin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">ymax</span><span class="o">=</span> <span class="mi">220</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Expected Profit&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">ymin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="mi">220</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">min_prof</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Minimum Profit&#39;</span><span class="p">),</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;profit$_q$ M USD&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Results&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Expected Profit:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;M USD&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Minimum Profit:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">min_prof</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;M USD&#39;</span><span class="p">)</span>
<span class="n">difference</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">)</span> <span class="o">-</span> <span class="n">min_prof</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Difference:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">difference</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;M USD&#39;</span><span class="p">)</span>

<span class="c1">#Collect results for conclusion</span>
<span class="n">final_EP</span><span class="p">[</span><span class="s1">&#39;MAD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span>
<span class="n">final_min</span><span class="p">[</span><span class="s1">&#39;MAD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_prof</span><span class="o">/</span><span class="mf">1e6</span>
<span class="n">final_diff</span><span class="p">[</span><span class="s1">&#39;MAD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">difference</span><span class="o">/</span><span class="mf">1e6</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/48eeb0a5d191d3341c6a3ca3eee6bc42b43a8beace160ace12164348dd1c677d.png" src="../../_images/48eeb0a5d191d3341c6a3ca3eee6bc42b43a8beace160ace12164348dd1c677d.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Results
-------------------------------------
Expected Profit: 8.17 M USD
Minimum Profit: 7.62 M USD
Difference: 0.55 M USD
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Sugar </span><span class="se">\n</span><span class="s1"> Free </span><span class="se">\n</span><span class="s1"> Market&#39;</span><span class="p">,</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">avg_sug_Fprof</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Sugar </span><span class="se">\n</span><span class="s1"> Regulated </span><span class="se">\n</span><span class="s1"> Market&#39;</span><span class="p">,</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">avg_sug_Rprof</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Ethanol </span><span class="se">\n</span><span class="s1"> Free </span><span class="se">\n</span><span class="s1"> Market&#39;</span><span class="p">,</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">avg_eth_Fprof</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Ethanol </span><span class="se">\n</span><span class="s1"> Regulated </span><span class="se">\n</span><span class="s1"> Market&#39;</span><span class="p">,</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">avg_eth_Rprof</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Electricity </span><span class="se">\n</span><span class="s1"> Free </span><span class="se">\n</span><span class="s1"> Market&#39;</span><span class="p">,</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">avg_el_prof</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Electricity </span><span class="se">\n</span><span class="s1"> Regulated </span><span class="se">\n</span><span class="s1"> Market&#39;</span><span class="p">,</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_el_reg</span><span class="p">)</span><span class="o">*</span><span class="mf">72.5</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Product&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Revenue from </span><span class="se">\n</span><span class="s1"> Each Profit (USD)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/46008a6cdaa622f3bcf0bd873e4b345c45aa4757f330280908d949318cc42de2.png" src="../../_images/46008a6cdaa622f3bcf0bd873e4b345c45aa4757f330280908d949318cc42de2.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Reload the base Model</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;stoc&quot;</span><span class="p">)</span>

<span class="c1"># Add parameters</span>
<span class="n">beta</span> <span class="o">=</span> <span class="mf">0.9</span>  <span class="c1"># confidence interval</span>

<span class="c1"># Add variables for CVaR</span>
<span class="n">m</span><span class="o">.</span><span class="n">shortfall</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">Reals</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">CVaR</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">within</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">Reals</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Add CVaR Constraints</span>
<span class="k">def</span><span class="w"> </span><span class="nf">CVaR1</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">CVaR</span> <span class="o">==</span> <span class="n">m</span><span class="o">.</span><span class="n">alpha</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">N</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">beta</span><span class="p">)))</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">shortfall</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">cvar1eq</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">CVaR1</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">CVaR2</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">shortfall</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span>
<span class="n">m</span><span class="o">.</span><span class="n">cvar2eq</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">CVaR2</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">CVaR4</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">profit</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">shortfall</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">alpha</span> <span class="o">&gt;=</span> <span class="mi">0</span>
<span class="n">m</span><span class="o">.</span><span class="n">cvar4eq</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">CVaR4</span><span class="p">)</span>

<span class="c1"># Objective: Maximize CVaR</span>
<span class="k">def</span><span class="w"> </span><span class="nf">obj_rule</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">CVaR</span>
<span class="n">m</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">obj_rule</span><span class="p">,</span> <span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">maximize</span><span class="p">)</span>

<span class="c1"># Solve the Model</span>
<span class="n">sol</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="s1">&#39;bonmin&#39;</span><span class="p">,</span> <span class="n">tee</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="c1"># Display Results</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Results&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;------------------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Expected Profit:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;USD&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sugar to Regulated Market: </span><span class="si">{</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_sugar_reg</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sugar to Free Market: </span><span class="si">{</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_sugar_free</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ethanol to Regulated Market: </span><span class="si">{</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_eth_reg</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ethanol to Free Market: </span><span class="si">{</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_eth_free</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Electricity to Free Market: </span><span class="si">{</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_el_free</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Electricity to Regulated Market: </span><span class="si">{</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_el_reg</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Results
------------------------------
Expected Profit: 55885788.25 USD
Sugar to Regulated Market: 90000.0009
Sugar to Free Market: 99129.7809912978
Ethanol to Regulated Market: 19999.9998
Ethanol to Free Market: 54072.67927772556
Electricity to Free Market: 0.0
Electricity to Regulated Market: 222600.00222600996
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#Collect the profit distribution</span>
<span class="n">profits</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">price_time_obs</span><span class="p">:</span>
    <span class="n">profits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">profit</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

<span class="c1">#Collect the minimum profit</span>
<span class="n">min_prof</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">profits</span><span class="p">)</span>

<span class="c1">#Plot the Profit Distribution</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">profits</span><span class="p">),</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">ymin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">ymax</span><span class="o">=</span> <span class="mi">220</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Expected Profit&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">ymin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="mi">220</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">min_prof</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Minimum Profit&#39;</span><span class="p">),</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;profit$_q$ M USD&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Results&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Expected Profit:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;M USD&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Minimum Profit:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">min_prof</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;M USD&#39;</span><span class="p">)</span>
<span class="n">difference</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">)</span> <span class="o">-</span> <span class="n">min_prof</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Difference:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">difference</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;M USD&#39;</span><span class="p">)</span>

<span class="c1">#Collect results for conclusion</span>
<span class="n">final_EP</span><span class="p">[</span><span class="s1">&#39;CVaR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EP</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span>
<span class="n">final_min</span><span class="p">[</span><span class="s1">&#39;CVaR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_prof</span><span class="o">/</span><span class="mf">1e6</span>
<span class="n">final_diff</span><span class="p">[</span><span class="s1">&#39;CVaR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">difference</span><span class="o">/</span><span class="mf">1e6</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/25e4630760ba39943a0b34348099ef4042a146a3130d5037fe5f2f2312210ad4.png" src="../../_images/25e4630760ba39943a0b34348099ef4042a146a3130d5037fe5f2f2312210ad4.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Results
-------------------------------------
Expected Profit: 55.89 M USD
Minimum Profit: 15.15 M USD
Difference: 40.74 M USD
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Sugar </span><span class="se">\n</span><span class="s1"> Free </span><span class="se">\n</span><span class="s1"> Market&#39;</span><span class="p">,</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">avg_sug_Fprof</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Sugar </span><span class="se">\n</span><span class="s1"> Regulated </span><span class="se">\n</span><span class="s1"> Market&#39;</span><span class="p">,</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">avg_sug_Rprof</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Ethanol </span><span class="se">\n</span><span class="s1"> Free </span><span class="se">\n</span><span class="s1"> Market&#39;</span><span class="p">,</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">avg_eth_Fprof</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Ethanol </span><span class="se">\n</span><span class="s1"> Regulated </span><span class="se">\n</span><span class="s1"> Market&#39;</span><span class="p">,</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">avg_eth_Rprof</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Electricity </span><span class="se">\n</span><span class="s1"> Free </span><span class="se">\n</span><span class="s1"> Market&#39;</span><span class="p">,</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">avg_el_prof</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Electricity </span><span class="se">\n</span><span class="s1"> Regulated </span><span class="se">\n</span><span class="s1"> Market&#39;</span><span class="p">,</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">q_el_reg</span><span class="p">)</span><span class="o">*</span><span class="mf">72.5</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Product&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Revenue from </span><span class="se">\n</span><span class="s1"> Each Profit (USD)&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/565119f65db9178e6e885038a36930994a4f4fddc8f1e66055921486167cc057.png" src="../../_images/565119f65db9178e6e885038a36930994a4f4fddc8f1e66055921486167cc057.png" />
</div>
</div>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Link to this heading">#</a></h2>
<p>The analysis shows that the free market channels for sugar, ethanol, and electricity yield distinct revenue distributions compared to the regulated channels. For instance, in the free market, the absence of pricing controls allows for higher revenue potential; however, this also introduces greater variability, as prices are susceptible to market fluctuations. In contrast, the regulated markets provide a more predictable revenue stream but cap the profit potential due to controlled pricing. These distinctions underscore a crucial trade-off between risk and revenue stability in choosing between market types.</p>
<p>The results further highlight that sugar and ethanol are particularly sensitive to regulatory constraints, with the regulated market setting a ceiling on potential earnings, especially when production surpluses increase supply. This condition may compel producers to prioritize free markets when aiming for higher profitability, albeit with increased exposure to market risks.</p>
<p>Overall, the model provides a comparative framework, guiding decision-makers to balance between predictable returns and potential profits within an uncertain market environment. This perspective is especially valuable for industries where the regulated and free markets can operate in tandem, allowing for diversified approaches that mitigate risk while maximizing revenue opportunities.</p>
<p>Future work ideas:</p>
<ul class="simple">
<li><p>Add more narrative at the beginning to discuss how this goes beyond the previous example/notebook</p></li>
<li><p>More clearly explain (using mathematical symbols) how the uncertainty model is being constructed</p></li>
<li><p>Explore <a class="reference internal" href="advanced_stochastic_programming.html"><span class="std std-doc">advanced stochastic programming</span></a> methods.</p></li>
</ul>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Link to this heading">#</a></h2>
<div class="csl-entry"> [1] Gunjan, A., &#38; Bhattacharyya, S. (2022). A brief review of portfolio optimization techniques. <i>Artificial Intelligence Review</i>. https://doi.org/10.1007/s10462-022-10273-7</div>
<div class="csl-entry"> [2] Markowitz, H. (1959). Portfolio selection, efficient diversification of investments. Wiley, New York
<div class="csl-entry"> [3] Konno, H., &#38; Koshizuka, T. (2005). Mean-absolute deviation model. <i>IIE Transactions (Institute of Industrial Engineers)</i>, <i>37</i>(10), 893â900. https://doi.org/10.1080/07408170591007786</div>
<div class="csl-entry"> [4] Mutran, V. M., Ribeiro, C. O., Nascimento, C. A. O., &#38; Chachuat, B. (2020). Risk-conscious optimization model to support bioenergy investments in the Brazilian sugarcane industry. <i>Applied Energy</i>, <i>258</i>. https://doi.org/10.1016/j.apenergy.2019.113978</div>
<div class="csl-entry"> [5] Li, L., Lin, J., Wu, N., Xie, S., Meng, C., Zheng, Y., Wang, X., &#38; Zhao, Y. (2022). Review and outlook on the international renewable energy development. In <i>Energy and Built Environment</i> (Vol. 3, Issue 2, pp. 139â157). KeAi Communications Co. https://doi.org/10.1016/j.enbenv.2020.12.002</div>
<div class="csl-entry"> [6] Oliveira, S. M. de, Ribeiro, C. de O., &#38; Cicogna, M. P. V. (2018). Uncertainty effects on production mix and on hedging decisions: The case of Brazilian ethanol and sugar. <i>Energy Economics</i>, <i>70</i>, 516â524. https://doi.org/10.1016/j.eneco.2018.01.025</div></section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/contrib"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="vehicle_routing.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Vehicle Routing</p>
      </div>
    </a>
    <a class="right-next"
       href="race_car_extended.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Extended Race Car Optimization Models</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-objectives">Learning Objectives</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-base-problem">The Base Problem</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-input-data">Visualize Input Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-plotting-functions">Define Plotting Functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-base-model-in-pyomo">Define Base Model in Pyomo</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#risk-measurement-equations">Risk measurement equations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementing-a-new-scenario-model-supply-and-demand-and-government-caps">Implementing a new scenario: model supply and demand and government caps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#system-description-model">System Description/Model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dof-analysis">DOF Analysis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summarizing-what-happened">Summarizing what happened</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementing-a-new-scenario-stochastic-modeling">Implementing a new scenario: Stochastic Modeling</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Alexander Dowling, et al.
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      Â© Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>